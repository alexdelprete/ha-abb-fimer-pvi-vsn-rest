# VSN-SunSpec Point Mapping Notes

## Overview

The [vsn-sunspec-point-mapping.xlsx](vsn-sunspec-point-mapping.xlsx) file
contains a comprehensive mapping of 259 data points from VSN300/VSN700
dataloggers to SunSpec models and Home Assistant entities.

Generated by: `scripts/generate_mapping_excel.py`

## Statistics

### Coverage

- **Total Points**: 259
- **VSN300-only**: 80 points (three-phase inverter specific, some M103 points)
- **VSN700-only**: 147 points (vendor-specific energy counters, system monitoring)
- **Both VSN300 and VSN700**: 32 points (common measurements)

### By Category

- Energy Counter: 59
- Unknown (VSN300-only): 67
- Inverter: 28
- Battery: 16
- Diagnostic: 18
- Meter: 17
- Control: 12
- And more...

### By SunSpec Model

- M64061 (ABB Vendor Model): 75 points
- VSN300-only: 67 points
- ABB Proprietary: 47 points
- M103 (Three Phase Inverter): 24 points
- M203 (Three Phase Meter): 17 points
- M802 (Battery Bank): 14 points
- And more...

### Description Sources (3-tier priority)

- **Priority 1** (Feeds title): 102 points
- **Priority 2** (SunSpec workbook description): 34 points
- **Priority 3** (Label fallback): 124 points

## Description Priority System

The script uses a 3-tier priority system to determine the description for each point:

### Priority 1: Feeds Title (when descriptive)

Source: `feeds.json` files from VSN300/VSN700 data

The `title` field in feeds.json can be either:

- **Descriptive text**: "E0 - Inverter Produced Energy - Total"
- **Point name reference**: "IGrid" (maps to VSN700 point name)

The script distinguishes between these using heuristics:

- Contains ' - ' separator → description
- Multiple words (>2) → description
- Short alphanumeric without ' - ' → point name reference

Examples of descriptive titles:

- `ETotal`: "E0 - Inverter Produced Energy - Total"
- `Ein`: "Ein - Inverter PV Energy - Total"
- `E0_1Y`: "E0 - Inverter Produced Energy - 1Y"
- `ECharge_7D`: "Battery Charge Energy - 7D"

### Priority 2: SunSpec Workbook Description

Source: `docs/sunspec-maps/models_workbook.xlsx` (Column N)

Used when the feeds title is not descriptive or unavailable.

Example: `m103_1_W` → "AC Power"

### Priority 3: Label Fallback

Source: Either SunSpec workbook label (Column M) or generated from point name

Used when neither feeds title nor workbook description is available.

Example: `m103_1_AphB` → "Amps PhaseB"

## Entity Naming Strategy

The mapping uses a hybrid approach to handle protocol differences between VSN300 and VSN700:

### Standard SunSpec Points

Points that exist in standard SunSpec models use the pattern: `abb_{model}_{point}`

Example: `ETotal` (M103 AC energy) → `abb_m103_wh`

### VSN-Specific Points

Points that only exist in VSN700 REST API (not in Modbus/SunSpec) use: `abb_vsn_{point}`

Example: `Ein` (PV DC energy, VSN700-only) → `abb_vsn_ein`

**Note**: While VSN300 has `m103_1_WH`, VSN700 exposes both `ETotal` (AC energy)
and `Ein` (DC energy). Since SunSpec M103 only defines one energy register (WH),
`ETotal` maps to `abb_m103_wh` and `Ein` is treated as VSN-specific → `abb_vsn_ein`.

## VSN300 ↔ VSN700 Cross-References

The mapping includes VSN300→VSN700 cross-references using feeds title data:

### Three-Phase Points

VSN300 uses modbus format with phase suffixes, VSN700 uses vendor names:

| VSN300 | VSN700 | Description |
|--------|--------|-------------|
| `m103_1_AphB` | `IoutS` | Phase B/S Current |
| `m103_1_AphC` | `IoutT` | Phase C/T Current |

### Point Name References

When VSN300 feeds `title` field contains a point name (not description), it maps to VSN700:

| VSN300 | Title | VSN700 Equivalent |
|--------|-------|-------------------|
| `m103_1_A` | "IGrid" | `Igrid` |
| `m103_1_W` | "Pgrid" | `Pgrid` |
| `m103_1_Hz` | "FGrid" | `Fgrid` |

## Implementation Notes

### For the Normalizer

When implementing data normalization in `abb_fimer_vsn_rest_client/normalizer.py`:

1. **Handle duplicates**: Use special mapping for `ETotal`/`Ein` to avoid entity name conflicts
2. **VSN700 priority**: When a point exists in both VSN300 and VSN700, prefer VSN700
   data (more direct, less processing)
3. **Cross-references**: Use VSN300→VSN700 mapping for protocol fallback scenarios
4. **Missing data**: Some points exist in feeds but not livedata (historical aggregations)

### Entity Naming Convention

All HA entities use lowercase with `abb_` prefix:

- Format: `abb_{model}_{point}`
- VSN-specific points: `abb_vsn_{point}`

Examples:

- `abb_m103_w` - Inverter AC power (M103 model)
- `abb_m64061_soc` - Battery state of charge (M64061 vendor model)
- `abb_vsn_e6_total` - VSN700-specific energy total

## Updating the Mapping

To regenerate the Excel file with updated data:

```bash
cd /d/OSILifeDrive/Dev/HASS/ha-abb-fimer-pvi-vsn-rest
python scripts/generate_mapping_excel.py
```

Requirements:

- Data files in `docs/vsn-data/vsn300-data/` and `docs/vsn-data/vsn700-data/`
- SunSpec models workbook: `docs/sunspec-maps/models_workbook.xlsx`
- openpyxl library

## Related Files

- [vsn-sunspec-point-mapping.xlsx](vsn-sunspec-point-mapping.xlsx) - Generated mapping file
- [scripts/generate_mapping_excel.py](../scripts/generate_mapping_excel.py) - Generator script
- [docs/sunspec-maps/models_workbook.xlsx](sunspec-maps/models_workbook.xlsx) - SunSpec metadata
- [docs/vsn-data/](vsn-data/) - VSN300/VSN700 sample data

---

**Last Updated**: 2025-10-26
**Mapping Version**: 259 points (v1.0)
