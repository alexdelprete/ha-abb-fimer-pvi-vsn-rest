# v1.0.0-beta.9 - Quality of Life Improvements & Bug Fixes

**Release Date:** 2025-01-29

## Overview

This release focuses on improving data quality and user experience through better unit handling, enhanced entity naming, temperature sensor correction, intelligent cross-referencing, and proper display precision. It also includes a hotfix for the mapping loader field name issue from beta.7.

---

## Fixed

### Critical Mapping Loader Bug (Hotfix from beta.8)

**Problem:** After the enhanced entity display names feature in beta.7, the mapping loader was looking for the old column name "HA Entity Name" but the JSON mapping file used "HA Name", causing 554 "Row missing HA entity name, skipping" errors.

**Solution:** Updated mapping_loader.py line 179 to use the correct field name "HA Name".

**Impact:** All 277 points now load correctly without errors.

**Commit:**
- d156ecc: fix: Update mapping_loader to use 'HA Name' field from new mapping format

---

### Unit Conversion for Leakage Current

**Problem:** Leakage current sensors reported values in microamperes (uA), which Home Assistant doesn't recognize as a valid unit for the current device class. This caused validation warnings.

**Solution:** Implemented comprehensive unit conversion system:
- Updated mapping Excel generator to convert uA → mA in the mapping files
- Added value conversion in normalizer.py that divides uA values by 1000
- Created `UA_TO_MA_POINTS` registry for affected points

**Points Fixed:**
1. `m64061_1_ILeakDcAc` (VSN300) - Leakage current DC/AC
2. `m64061_1_ILeakDcDc` (VSN300) - Leakage current DC/DC
3. `Ileak 1` (VSN700) - Leakage current 1
4. `Ileak 2` (VSN700) - Leakage current 2

**Before:** 150 uA (invalid unit, HA validation warning)
**After:** 0.15 mA (valid unit, proper display)

**Files Modified:**
- `scripts/generate_mapping_excel.py` - Added uA→mA conversion in mapping
- `custom_components/.../normalizer.py` - Added value conversion (÷1000)
- `docs/vsn-sunspec-point-mapping.xlsx` - Regenerated with correct units
- `docs/vsn-sunspec-point-mapping.json` - Updated mapping data

**Commit:**
- 85ae392: fix: Convert microampere (uA) to milliampere (mA) for HA compatibility

---

### Temperature Scale Factor Correction

**Problem:** Cabinet temperature sensor reported 244°C (unrealistic) instead of ~24°C. The scale factor for this sensor is incorrectly defined as -1 (÷10) when it should be -2 (÷100), requiring an additional correction.

**Solution:** Added temperature correction system in normalizer.py:
- Created `TEMP_CORRECTION_POINTS` registry
- Added threshold check (applies correction if temp > 70°C)
- Applies additional ÷10 correction to affected points

**Points Fixed:**
1. `m103_1_TmpCab` (VSN300) - Cabinet Temperature
2. `Temp1` (VSN700) - Cabinet Temperature

**Before:** 244.31°C (unrealistic reading)
**After:** 24.4°C (realistic reading)

**Technical Details:**
- Original value: 2443 with SF=-1 → 244.3°C (incorrect)
- Corrected value: 2443 with SF=-2 → 24.43°C (correct)
- Threshold: Only applies correction when temp > 70°C (to avoid false corrections)

**Files Modified:**
- `custom_components/.../normalizer.py` - Added temperature correction logic

**Commit:**
- bac10d1: fix: Add temperature scale factor correction for cabinet temperature sensor

---

### STARTUP_MESSAGE Issues

**Problem:** Two issues with the startup message:
1. Used hardcoded version string "1.0.0-beta.8" instead of VERSION constant
2. Logged on every coordinator poll, polluting logs

**Solution:**
- Changed STARTUP_MESSAGE to use f-string with VERSION constant interpolation
- Added conditional check to log only once per Home Assistant session using hass.data
- Avoided global variable to prevent ruff PLW0603 warning

**Before:**
- Showed "Version: 1.0.0-beta.8" (hardcoded)
- Logged repeatedly on every poll

**After:**
- Shows current VERSION constant value
- Logs only once per HA session

**Files Modified:**
- `custom_components/.../const.py` - Changed to f-string STARTUP_MESSAGE
- `custom_components/.../__init__.py` - Added once-per-session logging logic

**Commit:**
- c30e929: fix: Use VERSION constant in STARTUP_MESSAGE and log only once per session

---

## Changed

### Improved Entity Display Names

**Problem:** Many entity names showed cryptic abbreviations that were meaningless to users:
- "M 103 1 Hz A" instead of "Frequency Phase A"
- "M 103 1 PF A" instead of "Power Factor Phase A"
- Model prefixes like "M 103 1" cluttering the names

**Solution:** Implemented intelligent entity naming that:
- Prefers user-friendly labels over cryptic abbreviations
- Removes unnecessary model prefixes (M 103, M 64061, etc.)
- Uses HA Display Name from mapping with proper fallbacks

**Entities Improved:**
- 19 entities now have descriptive names
- Examples:
  - "M 103 1 Hz A" → "Frequency Phase A"
  - "M 103 1 PF A" → "Power Factor Phase A"
  - "M 103 1 Alarm St" → "Alarm Status"
  - "M 64061 1 Alarm St" → "Alarm Status"
  - "M 64061 1 Gnd Resist" → "Ground Resistance"

**Files Modified:**
- `custom_components/.../sensor.py` - Updated entity name generation logic

**Commit:**
- 188ac76: fix: Improve HA entity display names by preferring labels over cryptic abbreviations

---

### Smart Cross-Reference System

**Problem:** VSN300-only points were missing good descriptions because:
- They don't exist in VSN700 feeds (no label/description available)
- Excel generator was falling back to "Generated from point name"
- Example: "Pin1" showed as generated instead of "DC Power #1"

**Solution:** Implemented smart cross-reference system that:
1. Builds lookup table of VSN700 points with good labels/descriptions
2. For VSN300-only points, strips model prefix and looks up base name in VSN700 data
3. Borrows description, label, model, and data source from VSN700 equivalent
4. Properly attributes source as "Cross-ref from VSN700 (model) - original_source"

**Points Improved:**
- 7 VSN300-only points now have proper descriptions
- Examples:
  - "Pin1" → "DC Power #1" (from VSN700 equivalent)
  - "Pin2" → "DC Power #2" (from VSN700 equivalent)
  - "Iin1" → "DC Current #1" (from VSN700 equivalent)
  - "Vin1" → "DC Voltage #1" (from VSN700 equivalent)

**Technical Implementation:**
- Added `build_vsn700_lookup()` function to create reference table
- Enhanced `get_description_with_priority()` with Priority 0 cross-reference step
- Runs before all other priority levels (SunSpec, feeds, generation)

**Files Modified:**
- `scripts/generate_mapping_excel.py` - Added cross-reference logic
- `docs/vsn-sunspec-point-mapping.xlsx` - Regenerated with improved descriptions
- `docs/vsn-sunspec-point-mapping.json` - Updated mapping data

**Commit:**
- 209e2b7: feat: Add smart cross-reference system for VSN300-only points to borrow data from VSN700

---

### Comprehensive Display Precision

**Problem:** Sensors showed excessive decimal precision inappropriate for their units:
- Isolation resistance: 5.234567890 MOhm (too many decimals)
- Reactive power: 1234.567 var (should be integer)
- Frequency: 50.123456 Hz (too many decimals)

**Solution:** Added comprehensive suggested_display_precision based on unit types:

**Precision Rules:**
- **0 decimals** (integer display):
  - Power: W
  - Energy: Wh, kWh
  - Reactive power: var, VAR, VAh
  - Duration: s
  - Data size: B
  - Small resistance: Ω, Ohm

- **1 decimal**:
  - Voltage: V
  - Current: A, mA
  - Percentage: %
  - Capacity: Ah

- **2 decimals**:
  - Frequency: Hz
  - Temperature: °C, °F
  - Large resistance: MOhm, MΩ, kΩ

**Before:** Sensors showed many unnecessary decimal places
**After:** Each sensor shows appropriate precision for its unit type

**Files Modified:**
- `custom_components/.../sensor.py` - Added comprehensive precision configuration

**Commit:**
- beb41b5: feat: Add comprehensive display precision for all sensor units

---

### Title Case Consistency

**Problem:** Inconsistent casing in labels and descriptions:
- Some points had lowercase descriptions ("flash free space")
- Others had proper Title Case ("Flash Free Space")
- VSN system monitoring points had poor descriptions

**Solution:** Applied comprehensive Title Case consistency:
1. Added Title Case conversion for feed descriptions that start with lowercase
2. Created system monitoring label map with proper casing
3. Improved 11 descriptions for VSN300-only and system monitoring points

**Points Improved:**
- **6 VSN300-only datalogger points:**
  - "pn" → "Product Number"
  - "sn" → "Serial Number (Datalogger)"
  - "type" → "Device Type"
  - "wlan0_essid" → "WiFi Network Name (SSID)"
  - "wlan0_ipaddr_local" → "WiFi Local IP Address"
  - "wlan0_link_quality" → "WiFi Signal Strength"

- **5 VSN system monitoring points:**
  - "flash_free" → "Flash Free"
  - "free_ram" → "RAM Free"
  - "store_size" → "Flash Used"
  - "sys_load" → "System Load"
  - "uptime" → "Uptime"

**Before:** Mixed case, lowercase starts, generic descriptions
**After:** Consistent Title Case, descriptive labels

**Files Modified:**
- `scripts/generate_mapping_excel.py` - Added Title Case conversion and improved descriptions
- `docs/vsn-sunspec-point-mapping.xlsx` - Regenerated with consistent casing
- `docs/vsn-sunspec-point-mapping.json` - Updated mapping data

**Commit:**
- 3269a74: feat: Improve descriptions and apply Title Case consistency for all labels

---

## Technical Details

### Code Quality

**Ruff Checks:** All passed ✓

**Files Modified:** 8 files
- `custom_components/.../const.py` - STARTUP_MESSAGE f-string
- `custom_components/.../__init__.py` - Once-per-session logging
- `custom_components/.../mapping_loader.py` - Field name fix
- `custom_components/.../normalizer.py` - Unit conversions and temperature correction
- `custom_components/.../sensor.py` - Display names and precision
- `scripts/generate_mapping_excel.py` - Cross-reference, Title Case, improved descriptions
- `docs/vsn-sunspec-point-mapping.xlsx` - Regenerated (multiple times)
- `docs/vsn-sunspec-point-mapping.json` - Regenerated (multiple times)

**New Features:**
- `UA_TO_MA_POINTS` registry in normalizer.py
- `TEMP_CORRECTION_POINTS` registry in normalizer.py
- `build_vsn700_lookup()` function in generate_mapping_excel.py
- Cross-reference Priority 0 in description system
- Comprehensive display precision in sensor.py
- Title Case conversion for feed descriptions
- STARTUP_LOGGED_KEY tracking in __init__.py

**Code Metrics:**
- Lines added: ~210
- Lines removed: ~35
- Net change: +175 lines

---

## Testing

**Verified:**
1. ✓ All 277 points load correctly (no mapping loader errors)
2. ✓ Leakage current sensors show mA units and proper values
3. ✓ Cabinet temperature shows realistic ~24°C instead of 244°C
4. ✓ Entity display names are descriptive and clear
5. ✓ VSN300-only points have proper descriptions from cross-reference
6. ✓ All sensor precisions are appropriate for their units
7. ✓ Labels and descriptions have consistent Title Case
8. ✓ STARTUP_MESSAGE shows correct version and logs only once
9. ✓ Ruff checks pass
10. ✓ No validation warnings from Home Assistant

---

## Breaking Changes

**None.** This release is fully backward compatible.

However, note that:
- Entity display names have changed for better readability (19 entities)
- This might affect automations that use entity names in their configuration
- Entity IDs remain unchanged, so automations using entity IDs are not affected

---

## Migration Notes

### For Users

**No action required.** Simply update the integration and restart Home Assistant.

**What to Expect:**
- More readable entity names in the UI
- Correct temperature readings for cabinet sensor
- Proper units for leakage current sensors
- Appropriate decimal precision for all sensors
- Cleaner logs (startup message shows once instead of repeatedly)
- No changes to entity IDs or unique IDs

**If You Have Issues:**
1. Check Home Assistant logs for any errors
2. Verify your VSN device is accessible
3. Report issues at: https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues

### For Developers

**Mapping File Changes:**
- uA units converted to mA in mapping
- Improved descriptions for 18 points (7 cross-ref + 11 manual)
- Title Case consistency applied to all labels and descriptions
- Cross-reference system added for VSN300-only points

**Code Changes:**
```python
# New conversion registries in normalizer.py
UA_TO_MA_POINTS = {...}  # Points requiring uA→mA conversion
TEMP_CORRECTION_POINTS = {...}  # Points requiring temp correction

# New cross-reference system in generate_mapping_excel.py
vsn700_lookup = build_vsn700_lookup(rows)  # Build reference table
# Priority 0 cross-reference in get_description_with_priority()

# New display precision in sensor.py
self._attr_suggested_display_precision = 0/1/2  # Based on unit type

# New startup logging in __init__.py
STARTUP_LOGGED_KEY = f"{DOMAIN}_startup_logged"
if not hass.data.get(STARTUP_LOGGED_KEY):
    _LOGGER.info(STARTUP_MESSAGE)
    hass.data[STARTUP_LOGGED_KEY] = True
```

---

## Known Issues

**None reported.**

This is a **beta release** - please report any issues on GitHub:
- Issues: https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues
- Discussions: https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions

---

## Upgrade Instructions

### HACS (Recommended)

1. Go to HACS → Integrations
2. Find "ABB/FIMER PVI VSN REST"
3. Click "Update"
4. Restart Home Assistant

### Manual Installation

1. Download release from GitHub
2. Extract to `custom_components/abb_fimer_pvi_vsn_rest/`
3. Restart Home Assistant

---

## Full Changelog

**All commits since v1.0.0-beta.7:**

```
c30e929 fix: Use VERSION constant in STARTUP_MESSAGE and log only once per session
3269a74 feat: Improve descriptions and apply Title Case consistency for all labels
beb41b5 feat: Add comprehensive display precision for all sensor units
bac10d1 fix: Add temperature scale factor correction for cabinet temperature sensor
209e2b7 feat: Add smart cross-reference system for VSN300-only points to borrow data from VSN700
188ac76 fix: Improve HA entity display names by preferring labels over cryptic abbreviations
85ae392 fix: Convert microampere (uA) to milliampere (mA) for HA compatibility
30eea20 Bump version to v1.0.0-beta.8 (hotfix for beta.7)
d156ecc fix: Update mapping_loader to use 'HA Name' field from new mapping format
```

**Compare:** [v1.0.0-beta.7...v1.0.0-beta.9](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.0.0-beta.7...v1.0.0-beta.9)

---

## Credits

**Contributors:**
- @alexdelprete - Project maintainer
- Claude Code - Development assistance

**Special Thanks:**
- SunSpec Alliance for the SunSpec protocol specification
- ABB/FIMER for VSN datalogger platform
- Home Assistant community for feedback and testing

---

## Links

- **Repository:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest
- **Issues:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues
- **Discussions:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions
- **CHANGELOG:** [CHANGELOG.md](../../CHANGELOG.md)

---

🤖 Generated with [Claude Code](https://claude.com/claude-code)
