# Release Notes - v1.3.6-beta.2

[![GitHub Downloads](https://img.shields.io/github/downloads/alexdelprete/ha-abb-fimer-pvi-vsn-rest/v1.3.6-beta.2/total?style=for-the-badge)](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/releases/tag/v1.3.6-beta.2)

**Release Date**: 2026-02-17

**Focus**: Fix 4 issues from beta.1 testing of per-device custom name prefixes (#36)

______________________________________________________________________

## Overview

This beta fixes all issues reported by **@giannicoderani** during beta.1 testing on a
VSN700 system with REACT2-5.0-TL inverter, 2 batteries, and 1 meter. A 4th issue
(duplicate datalogger in discovery) was found during root cause analysis of his data files.

Thanks to **@giannicoderani** for thorough beta testing and providing diagnostic data on
[issue #36](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues/36).

______________________________________________________________________

## What's Changed

### Bug Fix: Inverted Device Prefixes (Bug 1)

Custom name prefixes were assigned to the wrong devices in multi-device setups (e.g.,
battery 1 prefix applied to battery 2 and vice versa).

**Root cause**: The prefix lookup in `_async_migrate_entity_ids()` used a flat dictionary
keyed by device type (`prefix_battery`), which doesn't exist for multi-device setups that
use indexed keys (`prefix_battery_1`, `prefix_battery_2`). This caused all devices of the
same type to get an empty prefix.

**Fix**: Created shared `build_prefix_by_device()` helper in `helpers.py` that correctly
handles both single-device (base key) and multi-device (indexed key) scenarios. All three
consumers (`sensor.py`, `config_flow.py`, `__init__.py`) now use this shared helper.

### Bug Fix: `via_device` Deprecation Warnings (Bug 2)

Home Assistant logged deprecation warnings about `via_device` references to non-existent
devices on every restart.

**Root cause**: Sensor entities were created (via `async_forward_entry_setups`) before the
datalogger parent device was registered in the device registry.

**Fix**: Moved `async_update_device_registry()` before `async_forward_entry_setups()` in
`async_setup_entry()`.

### Bug Fix: Entity ID Collisions During Regeneration (Bug 3)

"Regenerate Entity IDs" failed with "target already exists" errors for certain sensors
because different measurements produced identical display names.

**Root cause**: In the mapping generator, `VgridL1_N` (grid voltage, 118V split-phase)
and `PhVphA` (inverter output voltage, 235V) were both given description
"AC Voltage Phase A-N", which standardized to the same entity ID suffix. Three collision
groups confirmed:

| Point A | Point B | Shared Display Name |
| ------- | ------- | ------------------- |
| `PhVphA` | `VgridL1_N` | Voltage AC - Phase A-N |
| `PhVphB` | `VgridL2_N` | Voltage AC - Phase B-N |
| `Pba` | `PbaT` | Power - Battery Total |

**Fix (mapping)**: Gave distinct descriptions to collision pairs:

- `VgridL1_N` → "Voltage AC - Grid L1-N" (was "Voltage AC - Phase A-N")
- `VgridL2_N` → "Voltage AC - Grid L2-N" (was "Voltage AC - Phase B-N")
- `PbaT` → "Power - Battery Aggregate" (was "Power - Battery Total")

**Fix (safety net)**: Both `_regenerate_entity_ids()` and `_async_migrate_entity_ids()`
now use a two-phase approach: pre-compute all renames, detect duplicate targets before
executing, keep the winner (alphabetically first source), skip losers with clear warning.

### Bug Fix: Duplicate Datalogger in Discovery (Bug 4)

VSN700 systems discovered the datalogger device twice, which affected device counting
for prefix key resolution.

**Root cause**: In `discovery.py:_extract_devices()`, the datalogger was created twice:
once synthetically from status_data (with rich metadata), and again when iterating
livedata entries (VSN700 includes the datalogger MAC with empty points array).

**Fix**: Skip datalogger entries (MAC pattern) in the livedata iteration loop, since the
synthetic device from status_data has richer metadata and is already authoritative.

### Improvement: Automated `strings.json` Sync

`convert_to_json.py` now auto-updates sensor entries in `strings.json` from the mapping
JSON's `HA Display Name` field. This closes the pipeline automation gap — previously
`strings.json` sensor entries had to be maintained manually.

The full regeneration pipeline is now:

```bash
python scripts/vsn-mapping-generator/generate_mapping.py
python scripts/vsn-mapping-generator/convert_to_json.py    # also syncs strings.json
python scripts/generate-translations/generate_translations.py --all
```

______________________________________________________________________

## Post-Upgrade Action Required

After upgrading from beta.1, users who set custom prefixes must trigger
**"Regenerate Entity IDs"** once from the Options flow:

1. Go to Settings > Devices & Services > ABB/FIMER PVI VSN REST
2. Click "Configure"
3. Check "Regenerate Entity IDs"
4. Click Submit

This is needed because entity IDs are stored in HA's entity registry at creation time.
The bug fixes correct the logic, but existing entity IDs must be explicitly regenerated.

______________________________________________________________________

## Files Modified

| File | Changes |
| ---- | ------- |
| `__init__.py` | Reordered setup (device before platform), fixed prefix lookup, added collision detection |
| `helpers.py` | Added `simplify_device_type()`, `get_device_type_simple()`, `build_prefix_by_device()` |
| `sensor.py` | Uses shared `build_prefix_by_device()`, passes `custom_prefix` to sensor init |
| `config_flow.py` | Uses shared helpers, two-phase collision detection in regeneration |
| `discovery.py` | Skip duplicate datalogger from livedata |
| `generate_mapping.py` | Fixed 3 collision groups in `DESCRIPTION_IMPROVEMENTS` |
| `convert_to_json.py` | Added `update_strings_json()` for automated `strings.json` sync |
| `strings.json` | Auto-generated sensor entries from mapping |
| `translations/*.json` | All 10 languages regenerated with corrected display names |
| `CLAUDE.md` | Documented full 3-step regeneration pipeline |

______________________________________________________________________

## Testing Focus

1. **Multi-device setups** (e.g., 2 batteries):
   - Set different custom prefixes for each device
   - Trigger "Regenerate Entity IDs"
   - Verify each device has correct entity ID prefix (not swapped)
2. **Collision-prone entities** (VSN700 with inverter):
   - Check that `vgrid_l1_n` and `phase_voltage_an` have distinct entity IDs
   - Check display names: "Voltage AC - Grid L1-N" vs "Voltage AC - Phase A-N"
3. **No `via_device` warnings** in HA logs after restart
4. **Discovery**: datalogger appears exactly once in device list

**Full Changelog**: [v1.3.6-beta.1...v1.3.6-beta.2](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.3.6-beta.1...v1.3.6-beta.2)
