# Release v1.0.0-beta.11 - Entity ID Hotfix

**Release Date:** 2025-01-29
**Type:** Critical Hotfix

---

## üö® Critical Bug Fix

This is an **urgent hotfix** for v1.0.0-beta.10 which had a critical bug preventing proper entity ID generation.

### Issue

**Entity IDs were displaying only the point name instead of the full template format:**

**What users saw in beta.10:**
```
sensor.dc_current_1
sensor.dc_power_1
sensor.watts
sensor.uptime
```

**What they should have seen (now fixed in beta.11):**
```
sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_current_1
sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_power_1
sensor.abb_vsn_rest_inverter_0779093g823112_m103_watts
sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_uptime
```

### Root Cause

In `sensor.py`, the entity ID template string was correctly built but assigned to the wrong attribute:

**Buggy code (beta.10):**
```python
entity_id = _build_entity_id(
    device_type_simple=device_type_simple,
    device_sn_compact=device_sn_compact,
    model=model_for_id,
    point_name=point_name,
)

# BUG: This sets unique_id (internal registry ID), NOT entity_id!
self._attr_unique_id = entity_id

# This is what HA uses to generate entity_id
self._attr_name = point_data.get("ha_display_name", ...)
```

**What happened:**
- `_attr_unique_id` got the full template: `"abb_vsn_rest_inverter_0779093g823112_m103_watts"` ‚úì
- `_attr_name` got the display name: `"DC Current #1"` ‚úì
- Home Assistant generated `entity_id` by slugifying `_attr_name`: `"sensor.dc_current_1"` ‚ùå
- Users never saw the full template string (it was only in the hidden unique_id)

### The Fix

Added one line to explicitly set the `entity_id` property:

**Fixed code (beta.11):**
```python
entity_id = _build_entity_id(
    device_type_simple=device_type_simple,
    device_sn_compact=device_sn_compact,
    model=model_for_id,
    point_name=point_name,
)

# Set unique_id
self._attr_unique_id = entity_id

# FIX: Explicitly set entity_id to override HA's automatic generation
self.entity_id = f"sensor.{entity_id}"

# Set display name (what users see in UI)
self._attr_name = point_data.get("ha_display_name", ...)
```

**Result:**
- `entity_id` (visible in entity registry): `"sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_current_1"` ‚úì
- `_attr_name` (visible in UI): `"DC Current #1"` ‚úì
- `_attr_unique_id` (internal registry): `"abb_vsn_rest_inverter_0779093g823112_m160_dc_current_1"` ‚úì

---

## üìã Changes in This Release

### Fixed

- **Entity ID Generation Bug** ([sensor.py:243](../../custom_components/abb_fimer_pvi_vsn_rest/sensor.py#L243))
  - Added explicit `self.entity_id = f"sensor.{entity_id}"` assignment
  - This overrides Home Assistant's automatic entity_id generation from `_attr_name`
  - Entity IDs now display the full template format as intended

### Changed

- **Version**: Bumped to 1.0.0-beta.11
  - [manifest.json:13](../../custom_components/abb_fimer_pvi_vsn_rest/manifest.json#L13)
  - [const.py:4](../../custom_components/abb_fimer_pvi_vsn_rest/const.py#L4)

### Documentation

- **CHANGELOG.md**: Added beta.11 entry and warning in beta.10 section
- **beta.10 release notes**: Marked with known issue warning

---

## üì• Installation / Upgrade

### For New Users

**Recommended:** Wait for a stable release. This is still a beta version.

If you want to test:
1. Install via HACS (if available) or manual installation
2. Restart Home Assistant
3. Add integration via UI
4. Configure VSN datalogger settings

### For Beta.10 Users (UPGRADE IMMEDIATELY)

**Your current installation is broken.** Entity IDs don't work properly.

**Upgrade steps:**

1. **Via HACS:**
   - HACS ‚Üí Integrations ‚Üí ABB/FIMER PVI VSN REST
   - Click "Redownload"
   - Select version: v1.0.0-beta.11
   - Restart Home Assistant

2. **Manual Installation:**
   ```bash
   cd custom_components/abb_fimer_pvi_vsn_rest
   git pull
   git checkout v1.0.0-beta.11
   ```
   - Restart Home Assistant

3. **What will happen:**
   - All entities will be recreated with correct entity IDs
   - Old entities (with wrong IDs) will become unavailable/orphaned
   - You may need to clean up orphaned entities in Settings ‚Üí Devices & Services ‚Üí Entities
   - Update your dashboards/automations with new correct entity IDs

**Entity ID changes:**
```diff
- sensor.dc_current_1           ‚ùå (beta.10 - broken)
+ sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_current_1  ‚úì (beta.11 - correct)

- sensor.watts                   ‚ùå (beta.10 - broken)
+ sensor.abb_vsn_rest_inverter_0779093g823112_m103_watts  ‚úì (beta.11 - correct)

- sensor.uptime                  ‚ùå (beta.10 - broken)
+ sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_uptime  ‚úì (beta.11 - correct)
```

### For Beta.9 or Earlier Users

Upgrade directly to beta.11. See the [v1.0.0-beta.10 release notes](v1.0.0-beta.10.md) for the full breaking changes documentation (but skip beta.10 and go straight to beta.11).

---

## üß™ Testing

### Verify the Fix

After upgrading to beta.11, verify entity IDs are correct:

1. **Go to:** Settings ‚Üí Devices & Services ‚Üí Entities
2. **Filter by:** `abb_vsn_rest`
3. **Check entity IDs include full template:**
   - ‚úì `sensor.abb_vsn_rest_inverter_{serial}_{model}_{point}`
   - ‚úì `sensor.abb_vsn_rest_datalogger_{serial}_{model}_{point}`
   - ‚ùå NOT just `sensor.{point}`

### Example Correct Entity IDs

**Inverter sensors:**
```
sensor.abb_vsn_rest_inverter_0779093g823112_m103_watts
sensor.abb_vsn_rest_inverter_0779093g823112_m103_ac_current
sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_current_1
sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_voltage_1
sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_power_1
```

**Datalogger sensors:**
```
sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_uptime
sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_device_address
sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_manufacturer
```

---

## üîß Technical Details

### Files Changed

1. **custom_components/abb_fimer_pvi_vsn_rest/sensor.py**
   - Line 243: Added `self.entity_id = f"sensor.{entity_id}"`
   - This explicitly sets the entity_id property
   - Overrides Home Assistant's automatic slugification of `_attr_name`

2. **custom_components/abb_fimer_pvi_vsn_rest/manifest.json**
   - Line 13: Version bumped to `1.0.0-beta.11`

3. **custom_components/abb_fimer_pvi_vsn_rest/const.py**
   - Line 4: Version constant updated to `1.0.0-beta.11`

4. **CHANGELOG.md**
   - Added beta.11 section documenting the fix
   - Added warning to beta.10 section about the known issue

### Home Assistant Entity ID Mechanism

**Understanding the bug requires knowing how HA generates entity IDs:**

When `has_entity_name=False` (our case):
```python
# Home Assistant's automatic behavior
entity_id = f"{domain}.{slugify(self._attr_name)}"
```

**Slugification process:**
```python
"DC Current #1" ‚Üí "dc_current_1"
"AC Power" ‚Üí "ac_power"
"Uptime" ‚Üí "uptime"
```

**Our fix overrides this:**
```python
# Explicit assignment (our fix)
self.entity_id = f"sensor.{entity_id}"
```

This takes precedence over HA's automatic generation.

**Why not use `_attr_name` for the template?**

Because `_attr_name` is the **user-facing display name** shown in the UI. Users want to see friendly names like "DC Current #1", not ugly template strings like "abb_vsn_rest_inverter_0779093g823112_m160_dc_current_1".

So we need:
- `entity_id`: Full template format (for entity registry identification)
- `_attr_name`: Friendly display name (for UI)
- `_attr_unique_id`: Internal registry ID (for entity lifecycle)

---

## üêõ Known Issues

None in this release. This hotfix resolves the critical bug from beta.10.

---

## üìö Related Documentation

- [CHANGELOG.md](../../CHANGELOG.md) - Version history summary
- [v1.0.0-beta.10 Release Notes](v1.0.0-beta.10.md) - Original release (with bug)
- [Entity ID Template Documentation](v1.0.0-beta.10.md#entity-id-template) - Template format details
- [sensor.py](../../custom_components/abb_fimer_pvi_vsn_rest/sensor.py) - Source code

---

## üí¨ Support

If you encounter issues:

1. **Check entity IDs:** Make sure they show the full template format
2. **Verify version:** Settings ‚Üí Devices & Services ‚Üí ABB/FIMER PVI VSN REST ‚Üí Version should be 1.0.0-beta.11
3. **Check logs:** Settings ‚Üí System ‚Üí Logs (filter by `abb_fimer_pvi_vsn_rest`)
4. **Report issues:** [GitHub Issues](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues)

---

## üôè Acknowledgments

Thanks to the beta testers who quickly identified this critical issue after the beta.10 release.

---

**Commit:** `fix: entity_id generation bug (hotfix for beta.10)`
**Tag:** `v1.0.0-beta.11`
