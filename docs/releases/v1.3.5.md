# Release Notes - v1.3.5

[![GitHub Downloads](https://img.shields.io/github/downloads/alexdelprete/ha-abb-fimer-pvi-vsn-rest/v1.3.5/total?style=for-the-badge)](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/releases/tag/v1.3.5)

**Release Date**: TBD

**Focus**: Fix "Regenerate Entity IDs" and Auto-Migration

______________________________________________________________________

## Overview

This release fixes the "Regenerate entity IDs" checkbox in integration options, which was
producing wrong entity ID suffixes. It also adds automatic migration for users who already
used the buggy regeneration in previous versions.

______________________________________________________________________

## What's Changed

### Fix: Entity ID Regeneration Using Wrong Suffixes

When users set a custom device prefix (e.g., "ABB FIMER Inverter") and checked
"Regenerate entity IDs" in integration options, the generated entity IDs used raw
internal point names as suffixes instead of the translated display names that HA
natively uses.

**Before (buggy)**:

- `sensor.abb_fimer_inverter_watts` (raw point_name)
- `sensor.abb_fimer_inverter_alarm_st`
- `sensor.abb_fimer_inverter_watthours`

**After (fixed)**:

- `sensor.abb_fimer_inverter_power_ac` (translated name)
- `sensor.abb_fimer_inverter_alarm_status`
- `sensor.abb_fimer_inverter_energy_ac_produced_lifetime`

Additional fixes in the same method:

- **No-prefix case**: Previously skipped entities when no custom prefix was set. Now
  uses the default friendly device name for regeneration.
- **Domain preservation**: Previously hardcoded `sensor.` domain. Now preserves the
  original entity domain (sensor, binary_sensor, etc.).

### Auto-Migration for Existing Users

Users who already used the buggy regeneration get their entity IDs automatically
corrected on the next integration load. The migration:

- Detects entities with raw point_name suffixes (the buggy pattern)
- Computes the correct entity ID using translated names
- Updates the entity registry automatically
- Is idempotent (safe to run on every load, no-op after first migration)
- Skips entities that were manually renamed or already use correct suffixes

______________________________________________________________________

## Root Cause

`_regenerate_entity_ids()` in `config_flow.py` used the raw `point_name` from the
unique_id as the entity ID suffix:

```python
new_entity_id = f"sensor.{slugify(custom_prefix)}_{point_name}"
```

But Home Assistant generates entity IDs using the **translated entity name** (from
`_attr_translation_key` via `translations/en.json`), not `suggested_object_id`.
The fix now loads English translations and uses the slugified translated name as
the suffix, matching HA's native entity ID generation convention.

______________________________________________________________________

## Impact on Existing Users

- **Users who never used "Regenerate entity IDs"**: No change
- **Users who used the buggy regeneration**: Entity IDs auto-migrate on next reload
- **Automations/dashboards**: Will need updating if they reference the old buggy entity IDs

______________________________________________________________________

## Technical Details

### Files Modified

| File | Changes |
|------|---------|
| `config_flow.py` | Rewrote `_regenerate_entity_ids()` to use translated names |
| `__init__.py` | Added `_async_migrate_entity_ids()` auto-migration in setup |
| `tests/test_config_flow_direct.py` | Updated regeneration test assertions |
| `tests/test_init.py` | Added migration tests |

______________________________________________________________________

## Upgrade Notes

This is a **non-breaking** change for users who never used the "Regenerate entity IDs"
checkbox. For users who did use it, their entity IDs will be automatically corrected
on the next integration reload.
