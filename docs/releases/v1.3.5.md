# Release Notes - v1.3.5

[![GitHub Downloads](https://img.shields.io/github/downloads/alexdelprete/ha-abb-fimer-pvi-vsn-rest/v1.3.5/total?style=for-the-badge)](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/releases/tag/v1.3.5)

**Release Date**: 2026-02-16

**Focus**: Fix "Regenerate Entity IDs", Auto-Migration, and Custom Name Handling

______________________________________________________________________

## Overview

This release fixes the "Regenerate entity IDs" checkbox in integration options, which was
producing wrong entity ID suffixes. It also adds automatic migration for users who already
used the buggy regeneration in previous versions, clears stale custom entity names during
regeneration, and refactors the translation loading to use Home Assistant's native API.

______________________________________________________________________

## What's Changed

### Fix: Entity ID Regeneration Using Wrong Suffixes

When users set a custom device prefix (e.g., "ABB FIMER Inverter") and checked
"Regenerate entity IDs" in integration options, the generated entity IDs used raw
internal point names as suffixes instead of the translated display names that HA
natively uses.

**Before (buggy)**:

- `sensor.abb_fimer_inverter_watts` (raw point_name)
- `sensor.abb_fimer_inverter_alarm_st`
- `sensor.abb_fimer_inverter_watthours`

**After (fixed)**:

- `sensor.abb_fimer_inverter_power_ac` (translated name)
- `sensor.abb_fimer_inverter_alarm_status`
- `sensor.abb_fimer_inverter_energy_ac_produced_lifetime`

Additional fixes in the same method:

- **No-prefix case**: Previously skipped entities when no custom prefix was set. Now
  uses the default friendly device name for regeneration.
- **Domain preservation**: Previously hardcoded `sensor.` domain. Now preserves the
  original entity domain (sensor, binary_sensor, etc.).

### Fix: Custom Entity Names Cleared During Regeneration

When using "Regenerate entity IDs", the function now also clears any user-set custom
entity names. This ensures that HA uses the translation-based names (from
`translations/en.json`) for both the entity's display name and entity ID computation.

**Why this matters**: If an entity has a custom name (e.g., "Inverter Power AC" instead
of the default "Power AC"), HA's built-in "Recreate Entity IDs" feature on the device
page uses that custom name when computing what the entity ID should be. This creates a
mismatch between the actual entity ID and what HA thinks it should be, causing
"Recreate Entity IDs" to propose unnecessary renames.

The regeneration now:

- Clears custom names so entities revert to translation-based defaults
- Updates entity IDs using the correct translated suffixes
- Performs both operations in a single registry call for efficiency
- Logs each cleared custom name for traceability

### New: Auto-Migration for Existing Users

Users who previously used the buggy regeneration get their entity IDs automatically
corrected on the next integration load. The migration:

- Detects entities with raw point_name suffixes (the buggy pattern)
- Computes the correct entity ID using translated names
- Updates the entity registry automatically
- Is idempotent (safe to run on every load, no-op after first migration)
- Skips entities that were manually renamed or already use correct suffixes
- Logs "no migration needed" when all entity IDs are already correct

### Refactoring: HA Translation API

Replaced manual file I/O (`Path.read_text()` on `translations/en.json`) with Home
Assistant's built-in `async_get_translations()` API. This:

- Eliminates blocking file I/O in the event loop
- Uses HA's native translation loading infrastructure
- Shared helper `async_get_entity_translations()` in `helpers.py` for reuse across modules

______________________________________________________________________

## Upgrade Guide: Entity ID Troubleshooting

### Scenario 1: You never used "Regenerate entity IDs"

**Action needed**: None.

Your entity IDs were generated by HA's native mechanism and are already correct.
The auto-migration runs on every load but will find nothing to migrate and log
"no migration needed".

### Scenario 2: You used the buggy regeneration without custom prefixes

**What happens**: The auto-migration detects entities with raw point_name suffixes
and automatically corrects them on the first reload after updating.

**Action needed**: Update automations and dashboards that reference the old entity IDs.

**Example change**:

- Old: `sensor.abb_fimer_pvi_vsn_rest_inverter_0779093g823112_watts`
- New: `sensor.abb_fimer_pvi_vsn_rest_inverter_0779093g823112_power_ac`

Check your HA logs after reload for migration entries like:
`Migrated entity ID: sensor.xxx_watts -> sensor.xxx_power_ac`

### Scenario 3: You used the buggy regeneration with custom device prefixes

**What happens**: The auto-migration corrects entity IDs that still have raw
point_name suffixes. However, some entities may also have stale custom names
left over from previous manual renames or old integration behavior.

**Action needed**:

1. Update to v1.3.5 and reload the integration - auto-migration fixes entity IDs
2. Go to **Settings > Devices & Services > ABB/FIMER PVI VSN REST > Configure**
3. Check **"Regenerate entity IDs"** and submit
4. This clears any custom entity names AND regenerates entity IDs with correct suffixes
5. Update automations/dashboards referencing old entity IDs

### Scenario 4: HA's "Recreate Entity IDs" shows entities to rename

If you go to a device page and click "Recreate Entity IDs" and it shows entities
that would be renamed, this is typically caused by **custom entity names**.

**How to verify**: Click on one of the affected entities > Settings gear icon.
If the "Name" field shows a value (not empty/greyed out), it has a custom name.

**How to fix** (choose one):

- **Option A (recommended)**: Go to integration options > check "Regenerate entity IDs"
  > Submit. This clears all custom names and regenerates IDs in one step.
- **Option B (per-entity)**: Open each affected entity's settings > clear the "Name"
  field > Save. Repeat for each entity.

After fixing, "Recreate Entity IDs" on the device page should show
"No renamable entity IDs".

### Scenario 5: Fresh install (no previous versions)

**Action needed**: None. Everything works correctly out of the box.

Entity IDs are generated by HA using translated names, and no migration is needed.

______________________________________________________________________

## Root Cause

`_regenerate_entity_ids()` in `config_flow.py` used the raw `point_name` from the
unique_id as the entity ID suffix:

```python
new_entity_id = f"sensor.{slugify(custom_prefix)}_{point_name}"
```

But Home Assistant generates entity IDs using the **translated entity name** (from
`_attr_translation_key` via `translations/en.json`), not `suggested_object_id`.
The fix now loads English translations and uses the slugified translated name as
the suffix, matching HA's native entity ID generation convention.

______________________________________________________________________

## Impact on Existing Users

- **Users who never used "Regenerate entity IDs"**: No change
- **Users who used the buggy regeneration**: Entity IDs auto-migrate on next reload
- **Users with custom entity names**: Use "Regenerate entity IDs" to clear them
- **Automations/dashboards**: May need updating if they reference old buggy entity IDs

______________________________________________________________________

## Technical Details

### Files Modified

| File | Changes |
|------|---------|
| `config_flow.py` | Rewrote `_regenerate_entity_ids()` to use translated names and clear custom names |
| `__init__.py` | Added `_async_migrate_entity_ids()` auto-migration in setup, added no-op migration logging |
| `helpers.py` | Added `async_get_entity_translations()` shared helper using HA translation API |
| `tests/test_config_flow_direct.py` | Updated regeneration tests, added custom name clearing tests |
| `tests/test_init.py` | Added migration tests |

______________________________________________________________________

## Upgrade Notes

This is a **non-breaking** change for users who never used the "Regenerate entity IDs"
checkbox. For users who did use it, their entity IDs will be automatically corrected
on the next integration reload.

If HA's "Recreate Entity IDs" still shows entities to rename after updating, use
"Regenerate entity IDs" in the integration options to clear custom entity names
(see Scenario 4 above).
