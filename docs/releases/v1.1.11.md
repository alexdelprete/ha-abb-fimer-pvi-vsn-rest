# Release Notes - v1.1.11

**Release Date**: 2025-01-17

**Type**: Enhancement Release

**Focus**: Add attribute validation in sensor.py + fix vsn_client.py normalization

______________________________________________________________________

## Overview

This release adds comprehensive attribute validation to ensure mapping file data is correct for Home Assistant, and fixes bugs in the standalone test script.

**Key Improvements**:

- ‚úÖ Validates device_class and unit consistency using official HA standards
- ‚úÖ Handles exceptions for units without valid HA device_class (MOhm, kVAh)
- ‚úÖ Fixes insulation resistance icon display (mdi:omega now shows correctly)
- ‚úÖ Fixes vsn_client.py mapping URL and energy conversion

______________________________________________________________________

## Features Added

### üîç Attribute Validation in sensor.py

**Problem**: No validation of mapping file attributes before applying to entities

**Solution**: Added validation logic to catch mapping file bugs at runtime

**Implementation** ([sensor.py](../../custom_components/abb_fimer_pvi_vsn_rest/sensor.py)):

1. **DEVICE_CLASS_VALID_UNITS constant** (lines 26-79):

   - Maps each device_class to valid units per HA documentation
   - Based on: <https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes>
   - Includes all device classes used in integration

1. **DEVICE_CLASS_EXCEPTIONS constant** (lines 81-86):

   - Defines units that should NOT have a device_class
   - MOhm (insulation resistance): No HA device class supports MOhm
   - kVAh (apparent energy): HA has apparent power, not apparent energy

1. **Validation Logic** (lines 308-398):

   - Validates unit matches device_class before applying
   - Logs ERROR if invalid unit detected (indicates mapping file bug)
   - Applies defensive fix: uses first valid unit for device_class
   - Handles exceptions: removes incorrect device_class for MOhm/kVAh

**Benefits**:

- ‚úÖ Catches mapping file bugs at runtime with detailed error logs
- ‚úÖ Provides defensive fixes when validation fails
- ‚úÖ Respects mapping file as source of truth
- ‚úÖ Validates data is correct for Home Assistant

**Example Error Log**:

```text
ERROR: Invalid unit 'Wh' for device_class 'energy' on sensor day_wh (device: 077909-3G82-3112).
       Expected one of: ['J', 'kJ', 'MJ', 'GJ', 'mWh', 'Wh', 'kWh', 'MWh', 'GWh', 'TWh', ...].
       This is a mapping file bug that needs to be fixed.
WARNING: Applying defensive fix: using 'kWh' instead of 'Wh' for day_wh
```text

**Example Exception Handling**:

```text
WARNING: Sensor riso (device: xxx) has unit 'MOhm' which doesn't have a valid HA device_class.
         Removing device_class 'current' from mapping.
         Reason: Insulation resistance - no HA device class supports MOhm
```text

______________________________________________________________________

## Bugs Fixed

### üêõ Bug #1: Insulation Resistance Icon Not Displaying (Fixed)

**Problem**: Insulation resistance (MOhm) sensors showing generic icon instead of mdi:omega

**Root Cause**:

- Mapping file had `device_class="current"` for MOhm sensors
- MOhm is NOT a valid unit for "current" device_class (only A, mA are valid)
- Home Assistant overrides custom icon when device_class is set
- Custom `mdi:omega` icon was ignored

**Fix**:

- Added exception handling for MOhm in sensor.py
- Validation removes incorrect device_class with WARNING log
- Custom icon now displays correctly (no device_class override)

**Result**:

- ‚úÖ Insulation resistance sensors display `mdi:omega` icon correctly
- ‚úÖ No device_class (correct - HA doesn't support MOhm)
- ‚úÖ Unit: MOhm preserved

______________________________________________________________________

### üêõ Bug #2: vsn_client.py Mapping URL Wrong

**Problem**: Test script couldn't load mapping file (404 error)

**Root Cause**: URL was missing `abb_fimer_vsn_rest_client` directory in path

**Fix** ([vsn_client.py](../../scripts/vsn_client.py#L53)):

```python
# Before:
MAPPING_URL = ".../custom_components/.../data/vsn-sunspec-point-mapping.json"

# After:
MAPPING_URL = ".../custom_components/.../abb_fimer_vsn_rest_client/data/vsn-sunspec-point-mapping.json"
```text

**Result**: ‚úÖ Users can now successfully load mapping file

______________________________________________________________________

### üêõ Bug #3: vsn_client.py Missing Energy Conversion

**Problem**: Normalized JSON output showed energy values in Wh instead of kWh

**Root Cause**: `normalize_livedata()` function didn't apply Wh‚ÜíkWh conversion

**Fix** ([vsn_client.py](../../scripts/vsn_client.py#L481-L485)):

```python
# Convert energy sensors from Wh to kWh (matching normalizer.py logic)
if device_class == "energy" and point_value is not None:
    if isinstance(point_value, (int, float)) and point_value != 0:
        point_value = point_value / 1000  # Wh ‚Üí kWh
        unit = "kWh"
```text

**Result**: ‚úÖ Normalized JSON now shows correct kWh values

______________________________________________________________________

## Technical Details

### Files Modified

**Runtime Code**:

1. `custom_components/.../sensor.py` (3 changes)
   - Lines 26-79: Added DEVICE_CLASS_VALID_UNITS with official HA units
   - Lines 81-86: Added DEVICE_CLASS_EXCEPTIONS for MOhm/kVAh
   - Lines 339-353: Added exception handling logic
   - Lines 308-398: Added unit validation logic

**Test Scripts**: 2. `scripts/vsn_client.py` (2 changes)

- Line 53: Fixed mapping URL path
- Lines 481-485: Added energy conversion to normalize_livedata()

**Version Files**: 3. `custom_components/.../const.py` (version 1.1.11) 4. `custom_components/.../manifest.json` (version 1.1.11)

### Architecture

**Mapping File = Source of Truth**:

- sensor.py VALIDATES mapping data (doesn't override it)
- Validation catches bugs with detailed error logs
- Defensive fixes applied when validation fails

**Exception Handling**:

- Units without valid HA device_class are handled explicitly
- Invalid device_class removed with WARNING log
- Custom icons preserved (no device_class override)

______________________________________________________________________

## Breaking Changes

**None** - This is an enhancement and bug fix release.

______________________________________________________________________

## Migration Notes

**For Users**:

- No action required - validation runs automatically
- Check logs for WARNING/ERROR messages about attribute validation
- If you see errors, the integration applies defensive fixes automatically

**For Developers**:

- Attribute validation now catches mapping file bugs at runtime
- MOhm and kVAh sensors correctly handled as exceptions
- All device_class validations use official HA-supported units

______________________________________________________________________

## Upgrade Priority

**üîß RECOMMENDED - Upgrade When Convenient**

Benefits:

- Better error detection for mapping file bugs
- Insulation resistance icon displays correctly
- Test script works correctly for users

Impact: Low - validation adds safety, fixes are defensive

______________________________________________________________________

## Commits

- aa64629: fix: correct mapping URL and add energy conversion to vsn_client.py
- c0398c6: feat: add attribute validation in sensor.py for device_class/unit consistency
- a68b605: fix: correct device_class validation with official HA units + exception handling

______________________________________________________________________

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for the complete changelog.
