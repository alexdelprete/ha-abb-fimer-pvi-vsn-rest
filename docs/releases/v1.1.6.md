# Release v1.1.6

**Release Date**: 2025-11-17

**Type**: Patch Release (Architecture Refactoring)

**Focus**: Move protocol constants to client library for proper architectural separation

______________________________________________________________________

## Overview

This patch release refactors the codebase to move protocol-level constants from the integration layer to the client library. This improves code organization, enables DRY (Don't
Repeat Yourself) principles, and positions the client library for potential extraction as a standalone package.

**No user-facing changes** - This is an internal refactoring that maintains full backward compatibility.

______________________________________________________________________

## What's Changed

### üèóÔ∏è Architecture: Protocol Constants ‚Üí Client Library

**Problem**: Protocol-level constants (Aurora state mappings, REST API endpoints, epoch offsets) were defined in the integration layer (`const.py`), violating separation of
concerns and preventing the client library from being self-contained.

**Solution**: Move protocol knowledge to the client library where it belongs, maintaining backward compatibility through re-exports.

**Files Changed**:

**1. NEW: [abb_fimer_vsn_rest_client/constants.py](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/constants.py)**

Created new constants module in client library with:

- REST API endpoints (`ENDPOINT_STATUS`, `ENDPOINT_LIVEDATA`, `ENDPOINT_FEEDS`)
- Aurora protocol epoch offset (`AURORA_EPOCH_OFFSET = 946684800`)
- Aurora state mappings (4 dictionaries, 165 total state codes):
  - `GLOBAL_STATE_MAP` - 42 states (0-38, 98-101)
  - `DCDC_STATE_MAP` - 20 states (0-19)
  - `INVERTER_STATE_MAP` - 38 states (0-31, 40-47)
  - `ALARM_STATE_MAP` - 65 states (0-64)

**2. [abb_fimer_vsn_rest_client/__init__.py](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/__init__.py)**

```python
# Export protocol constants alongside exceptions
from .constants import (
    ALARM_STATE_MAP,
    AURORA_EPOCH_OFFSET,
    DCDC_STATE_MAP,
    ENDPOINT_FEEDS,
    ENDPOINT_LIVEDATA,
    ENDPOINT_STATUS,
    GLOBAL_STATE_MAP,
    INVERTER_STATE_MAP,
)
```text

**3. [abb_fimer_vsn_rest_client/auth.py](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/auth.py)**

- Replaced hardcoded `/v1/status` with `ENDPOINT_STATUS` constant (2 occurrences)
- Replaced hardcoded `/v1/livedata` with `ENDPOINT_LIVEDATA` constant (2 occurrences)

**4. [abb_fimer_vsn_rest_client/client.py](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/client.py)**

- Replaced hardcoded `/v1/livedata` with `ENDPOINT_LIVEDATA` constant (2 occurrences)

**5. [abb_fimer_vsn_rest_client/discovery.py](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/discovery.py)**

- Replaced hardcoded `/v1/status` with `ENDPOINT_STATUS` constant (2 occurrences)
- Replaced hardcoded `/v1/livedata` with `ENDPOINT_LIVEDATA` constant (2 occurrences)

**6. [const.py](../../custom_components/abb_fimer_pvi_vsn_rest/const.py)**

```python
# Import protocol constants from client library and re-export
from .abb_fimer_vsn_rest_client import (  # noqa: F401
    ALARM_STATE_MAP,
    AURORA_EPOCH_OFFSET,
    DCDC_STATE_MAP,
    GLOBAL_STATE_MAP,
    INVERTER_STATE_MAP,
)

# Integration-level glue: Maps SunSpec point names ‚Üí Aurora state maps
STATE_ENTITY_MAPPINGS = {
    "GlobalSt": GLOBAL_STATE_MAP,
    "DcSt1": DCDC_STATE_MAP,
    # ...
}
```text

- Removed 186 lines of duplicate state map definitions
- Imports from client library instead
- Re-exports for backward compatibility
- Keeps `STATE_ENTITY_MAPPINGS` (integration-specific glue)

**7. [sensor.py](../../custom_components/abb_fimer_pvi_vsn_rest/sensor.py)**

- No changes needed! Imports still work via const.py re-exports

______________________________________________________________________

## Benefits

### 1. **Clean Architectural Separation**

- **Client Library**: Protocol knowledge (Aurora state codes, REST endpoints, epoch offsets)
- **Integration Layer**: HA-specific logic (entity mappings, sensor creation, UI)

### 2. **DRY Principle**

- **Before**: 10+ hardcoded endpoint strings across 3 files
- **After**: Single constant definition, used consistently

### 3. **Reusability**

- Client library is now self-contained and can be extracted as standalone package
- All protocol knowledge travels with the client library

### 4. **Maintainability**

- Protocol changes (e.g., API version upgrade) affect client library only
- Clear dependency flow: Integration ‚Üí Client Library ‚Üí Protocol

### 5. **Backward Compatibility**

- Integration re-exports maintain all existing import paths
- sensor.py unchanged - no impact on sensor logic
- State mapping behavior identical

______________________________________________________________________

## Technical Details

### Dependency Flow

```text
Before Refactoring:
Integration const.py
  ‚îú‚îÄ Defines protocol constants
  ‚îî‚îÄ Sensor imports from const.py

After Refactoring:
Client Library constants.py
  ‚îî‚îÄ Defines protocol constants
       ‚Üì exported via __init__.py
Integration const.py
  ‚îú‚îÄ Imports from client library
  ‚îú‚îÄ Re-exports for integration use
  ‚îî‚îÄ Sensor imports from const.py (unchanged!)
```text

### Two-Layer Mapping

**Layer 1: Protocol Knowledge (Client Library)**

```python
# "What does Aurora state code 6 mean?"
GLOBAL_STATE_MAP[6] ‚Üí "Run"
```text

**Layer 2: Schema Mapping (Integration)**

```python
# "Which Aurora state map applies to SunSpec point 'GlobalSt'?"
STATE_ENTITY_MAPPINGS["GlobalSt"] ‚Üí GLOBAL_STATE_MAP
```text

This separation is correct because:

- **Aurora protocol is universal** ‚Üí Client library (reusable)
- **SunSpec ‚Üí Aurora mapping is HA-specific** ‚Üí Integration layer (glue)

### Example Runtime Flow

```python
# 1. API returns: {"GlobalSt": 6, "DCPwr": 5000}
# 2. Coordinator stores normalized data
# 3. Sensor processes value:
sensor_globalst.native_value
  ‚îú‚îÄ value = coordinator.data["GlobalSt"]  # 6
  ‚îú‚îÄ self._state_map = STATE_ENTITY_MAPPINGS["GlobalSt"]  # GLOBAL_STATE_MAP
  ‚îú‚îÄ state_text = GLOBAL_STATE_MAP.get(6)  # "Run"
  ‚îî‚îÄ return "Run"  # ‚úÖ Displays "Run" in HA UI
```text

______________________________________________________________________

## Breaking Changes

**None** - This is a pure refactoring that maintains full backward compatibility.

- ‚úÖ All imports still work (re-exports)
- ‚úÖ State mapping logic unchanged
- ‚úÖ Runtime behavior identical
- ‚úÖ No user-facing changes
- ‚úÖ No configuration changes needed
- ‚úÖ No migration required

______________________________________________________________________

## Migration Notes

**No action required** - The refactoring is transparent to users and existing code.

### For Users

- No changes needed
- Update normally via HACS or manual installation

### For Developers

If you've forked or extended this integration:

```python
# These imports still work (backward compatible):
from .const import AURORA_EPOCH_OFFSET, STATE_ENTITY_MAPPINGS

# New imports also available (if you want to use client library directly):
from .abb_fimer_vsn_rest_client import GLOBAL_STATE_MAP, ENDPOINT_STATUS
```text

______________________________________________________________________

## Commits

- [ee5a66e](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/ee5a66e) - refactor: Move protocol constants to client library

______________________________________________________________________

## Testing

**Static Analysis:**

- ‚úÖ Ruff linting passed on all modified files
- ‚úÖ No import errors detected
- ‚úÖ __all__ exports sorted correctly

**Recommended Runtime Validation:**

1. Integration loads without errors in HA
1. State sensors display text (e.g., "Run" not "6")
1. Numeric sensors display numbers correctly
1. sys_time sensor shows datetime (epoch conversion works)
1. No import errors in HA logs

______________________________________________________________________

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for the complete changelog.
