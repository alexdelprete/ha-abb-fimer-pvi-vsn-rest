**Release Date**: 2025-11-17

**Type**: Major Internal Improvement Release

**Focus**: Single source of truth for sensor metadata - Generator script extended with all fixes

---

## Overview

This release transforms the sensor mapping workflow by codifying ALL sensor fixes from v1.1.3-v1.1.7 into the generator script. The generator is now the **single source of truth** for sensor metadata, eliminating manual JSON/Excel editing and preventing future mapping inconsistencies.

**Key Achievement**: Precision field support added to generator, ensuring all 258 sensors have consistent decimal precision rules.

**User Impact**: No breaking changes for existing installations. All sensor attributes remain the same, but future mapping updates will be more reliable and consistent.

---

## What's Changed

### üèóÔ∏è Generator Script: Comprehensive Enhancement

**Problem**:
- Sensor fixes from v1.1.3-v1.1.7 were applied manually to JSON/Excel files
- Generator script was missing precision field support and recent sensor metadata
- Risk of losing fixes when regenerating mapping files
- No single source of truth for sensor attributes

**Solution**:
Extended the generator script (`generate_mapping.py`) to include ALL sensor metadata, making it the permanent source of truth.

**Files Changed**:

**1. [scripts/vsn-mapping-generator/generate_mapping.py](../../scripts/vsn-mapping-generator/generate_mapping.py)**

Added **180+ lines** of new code:

**A) New Helper Function: `_get_suggested_precision()`** (60 lines)

Intelligent precision assignment based on sensor characteristics:
- State sensors ‚Üí `""` (empty string) - Display text, not numbers
- Power/Energy counters ‚Üí `0` decimals (W, kW, Wh, kWh, VAh, s, B)
- Voltage/Temperature ‚Üí `1` decimal (V, mA, %, ¬∞C, ¬∞F, MB, GB, Ah)
- Current/Frequency ‚Üí `2` decimals (A, Hz, MOhm, MŒ©, kŒ©)
- Small resistance/Cycles ‚Üí `0` decimals (Œ©, Ohm, cycles, channels)
- Special case: `sys_load` ‚Üí `2` decimals (float 0.00-100.00)

**B) Extended SUNSPEC_TO_HA_METADATA Dictionary** (50+ new entries)

Added metadata for 50+ sensors across 8 categories:

**Cycle Counters (v1.1.5+)** - 3 sensors:
- `Chc`, `Dhc`, `CycleNum`
- `state_class="total_increasing"`, `precision=0`, `unit=""`

**State Sensors (v1.1.6+)** - 6 sensors:
- `GlobalSt`, `DcSt1`, `DcSt2`, `InverterSt`, `AlarmState`, `AlarmSt`
- `entity_category="diagnostic"`, `icon="mdi:information-box-outline"`, `precision=""`

**Integer Count Sensors (v1.1.7+)** - 3 sensors:
- `BattNum`, `NumOfMPPT`, `CountryStd`
- `precision=0`

**State/Flag Sensors (v1.1.5+)** - 6 sensors:
- `BatteryMode`, `BattExtCtrlState`, `BattExtCtrlEna`
- `PacDeratingFlags`, `SacDeratingFlags`, `ClockState`
- `entity_category="diagnostic"`, `precision=0`

**Resistance Sensor (v1.1.4+)** - 1 sensor:
- `Riso` - `unit="MOhm"`, `icon="mdi:omega"`, `precision=2`

**Current Sensors (v1.1.3+)** - 5 sensors:
- `Iba`, `Iin1`, `Iin2`, `IleakInv`, `IleakDC`
- `device_class="current"`, `unit="A"`, `precision=2`

**Voltage Sensors (v1.1.3+)** - 4 sensors:
- `Vba`, `ShU`, `Vin1`, `Vin2`
- `device_class="voltage"`, `unit="V"`, `precision=1`

**Power Sensors (v1.1.3+)** - 4 sensors:
- `Pba`, `MeterPgrid_L1`, `MeterPgrid_L2`, `MeterPgrid_L3`
- `device_class="power"`, `unit="W"`, `precision=0`

**Temperature Sensors (v1.1.3+)** - 3 sensors:
- `Tba`, `TcMax`, `TcMin`
- `device_class="temperature"`, `unit="¬∞C"`, `precision=1`

**Energy Sensors (v1.1.3+)** - 11 sensors:
- `ECt`, `EDt`, `E4_runtime`, `E4_7D`, `E4_30D`
- `E5_runtime`, `E5_7D`, `E5_30D`, `Ein1`, `Ein2`, `EBackup`
- `device_class="energy"`, `unit="Wh"`, `state_class="total_increasing"`, `precision=2`

**Other Sensors (v1.1.3+)** - 2 sensors:
- `Fcc` - Frequency (Hz, precision=2)
- `TSoc` - Battery SoC (%, precision=0)
- `SysTime` - Timestamp (precision=0)

**C) Updated Metadata Application Logic**

```python
# 7. Apply HA metadata from SUNSPEC_TO_HA_METADATA dictionary
if sunspec_name in SUNSPEC_TO_HA_METADATA:
    metadata = SUNSPEC_TO_HA_METADATA[sunspec_name]
    # Apply entity_category if specified
    if not row["entity_category"] and metadata.get("entity_category"):
        row["entity_category"] = metadata.get("entity_category")

# 8. Set Suggested Display Precision
if sunspec_name in SUNSPEC_TO_HA_METADATA and "precision" in SUNSPEC_TO_HA_METADATA[sunspec_name]:
    row["precision"] = SUNSPEC_TO_HA_METADATA[sunspec_name]["precision"]
else:
    # Auto-calculate based on units/device_class
    row["precision"] = _get_suggested_precision(...)
```

**D) Added "Suggested Display Precision" Column**

Updated Excel headers from 27 to 28 columns:
```python
EXCEL_HEADERS = [
    *MODEL_FLAGS,
    "REST Name (VSN700)",
    "REST Name (VSN300)",
    "SunSpec Normalized Name",
    "HA Name",
    # ... other columns ...
    "Entity Category",
    "Suggested Display Precision",  # ‚Üê NEW in v1.1.7
    "Available in Modbus",
    "Data Source",
    "Model_Notes",
]
```

**2. [scripts/vsn-mapping-generator/convert_to_json.py](../../scripts/vsn-mapping-generator/convert_to_json.py)**

Fixed runtime JSON path (missing directory level):
```python
# Before (WRONG):
data_path = repo_root / "custom_components" / "abb_fimer_pvi_vsn_rest" / "data" / "vsn-sunspec-point-mapping.json"

# After (CORRECT):
data_path = repo_root / "custom_components" / "abb_fimer_pvi_vsn_rest" / "abb_fimer_vsn_rest_client" / "data" / "vsn-sunspec-point-mapping.json"
```

**3. Generated Files - All 258 Sensors Updated**

**Excel**: `vsn-sunspec-point-mapping.xlsx`
- 28 columns (added "Suggested Display Precision")
- 258 rows with precision values

**JSON**: All 3 copies regenerated:
- `scripts/vsn-mapping-generator/output/vsn-sunspec-point-mapping.json`
- `docs/vsn-sunspec-point-mapping.json`
- `custom_components/.../data/vsn-sunspec-point-mapping.json`

**Precision Statistics**:
- 6 sensors: `""` (empty string) - State sensors
- 175 sensors: `0` - Power, energy, cycles, counts
- 40 sensors: `1` - Voltage, temperature, battery %
- 37 sensors: `2` - Current, frequency, resistance

**4. [custom_components/.../normalizer.py](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/normalizer.py)**

Documented Wh‚ÜíkWh conversion as defensive code:
```python
# Convert Wh to kWh for energy sensors (defensive code)
# NOTE: As of v1.1.7+, the mapping generator (generate_mapping.py) now sets kWh
# units in the mapping file via SUNSPEC_TO_HA_METADATA. This conversion serves
# as defensive code for edge cases where Wh units might still appear in the mapping
# or if the raw API data unexpectedly contains Wh values.
# Period counters (DayWH, WeekWH, MonthWH, YearWH) remain as Wh per SunSpec spec.
```

**5. [CLAUDE.md](../../CLAUDE.md) - Critical Documentation Updates**

Added **mandatory directives** to prevent future mistakes:

**A) Session Startup Checklist** (top of file):
```markdown
## ‚ö†Ô∏è CRITICAL: Read This First

**MANDATORY: At the beginning of EVERY session, you MUST:**
1. Read this entire CLAUDE.md file
2. Review recent git commits
3. Check the current state (git status)
```

**B) Sensor Mapping Workflow Section** (150+ lines):
- **The ONLY Way to Modify Sensor Attributes**: Use generator script, period
- **NEVER, EVER**: Edit JSON/Excel directly, add logic to runtime code
- **Why This Rule Exists**: Single source of truth, regeneration safety
- **Correct Workflow**: Edit generator ‚Üí Regenerate ‚Üí Test ‚Üí Commit
- **Examples**: Wrong vs Right comparison with code snippets
- **Attribute Location Table**: Where each attribute type is defined

**C) Updated "Don't Do" Section**:
```markdown
üö® CRITICAL - SENSOR MAPPING:
- ‚ùå NEVER edit JSON mapping files directly
- ‚ùå NEVER edit Excel mapping files directly
- ‚ùå NEVER add sensor attributes to runtime code
- ‚ùå ALWAYS use the generator script for ALL sensor changes
```

**D) Updated "Do" Section**:
```markdown
üö® CRITICAL - SENSOR MAPPING:
- ‚úÖ READ CLAUDE.md at the start of EVERY session
- ‚úÖ ALWAYS use generator script for sensor attribute changes
- ‚úÖ Edit scripts/vsn-mapping-generator/generate_mapping.py to modify sensors
- ‚úÖ Regenerate files after generator changes
```

**E) Updated Version**:
- Changed from v1.0.0-beta.22 to v1.1.7

---

## Benefits

### 1. **Single Source of Truth**
- Generator script (`generate_mapping.py`) is now the **ONLY** place to define sensor metadata
- All 258 sensors follow consistent rules
- No risk of manual edits being lost during regeneration

### 2. **Permanent Fix Codification**
- All fixes from v1.1.3-v1.1.7 now live in the generator
- Precision field support (v1.1.3+)
- Cycle counter metadata (v1.1.5+)
- State sensor metadata (v1.1.6+)
- Integer/flag sensor metadata (v1.1.7+)

### 3. **Consistency**
- Precision rules applied uniformly across all sensors
- No exceptions, no manual overrides needed
- Auto-calculated or explicitly specified in metadata

### 4. **Maintainability**
- Future sensor additions: Add to `SUNSPEC_TO_HA_METADATA`, regenerate
- Future sensor fixes: Update generator, regenerate
- No manual JSON/Excel editing required

### 5. **Documentation**
- CLAUDE.md now has **mandatory directives** preventing workflow violations
- Session startup checklist ensures documentation is read first
- Clear examples showing correct vs incorrect approaches

---

## Technical Details

### Precision Assignment Logic

**Priority Order**:
1. **Explicit in SUNSPEC_TO_HA_METADATA** (highest priority)
   - Sensor-specific precision defined in metadata dictionary
   - Example: `"Riso": {"precision": 2}`

2. **Unit-based auto-calculation** (via `_get_suggested_precision()`)
   - Power/Energy: W, kW, Wh, kWh ‚Üí `0`
   - Voltage/Temperature: V, ¬∞C, % ‚Üí `1`
   - Current/Frequency: A, Hz, MOhm ‚Üí `2`

3. **Device class fallback** (for sensors without units)
   - power, reactive_power, timestamp ‚Üí `0`
   - voltage, temperature ‚Üí `1`
   - current, frequency, energy ‚Üí `2`

4. **Default**: `0` (for unitless numeric sensors)

### State Sensor Special Handling

State sensors (GlobalSt, DcSt1, DcSt2, InverterSt, AlarmState, AlarmSt) get `precision=""` (empty string, not `0`):
- These display **text** (e.g., "Run"), not numbers (e.g., "6")
- Empty string precision signals they're text-based
- HA's state mapping converts integer codes to human-readable strings

### Generator Workflow

```bash
# Step 1: Generate Excel from raw VSN data
python scripts/vsn-mapping-generator/generate_mapping.py
# Creates: scripts/vsn-mapping-generator/output/vsn-sunspec-point-mapping.xlsx

# Step 2: Convert Excel to JSON (creates all 3 copies)
python scripts/vsn-mapping-generator/convert_to_json.py
# Creates:
#   - scripts/vsn-mapping-generator/output/vsn-sunspec-point-mapping.json
#   - docs/vsn-sunspec-point-mapping.json (docs copy)
#   - custom_components/.../data/vsn-sunspec-point-mapping.json (runtime copy)
```

### Mapping File Evolution

| Version | Columns | Precision Field | Notes |
|---------|---------|-----------------|-------|
| v1.1.2 | 26 | No | Manual Excel editing |
| v1.1.3 | 27 | Yes (manual) | Added manually to JSON |
| v1.1.7 | 28 | Yes (generated) | Generator creates precision field |

---

## Breaking Changes

**None** - This is an internal improvement that doesn't affect user-facing behavior.

- ‚úÖ All sensor attributes remain the same
- ‚úÖ No entity ID changes
- ‚úÖ No configuration changes needed
- ‚úÖ No migration required
- ‚úÖ Backward compatible

---

## Migration Notes

**For Users**:
- No action required
- Update normally via HACS or manual installation

**For Developers/Contributors**:
- **CRITICAL**: Never edit JSON or Excel files directly
- **ALWAYS** use generator script to modify sensor metadata:
  1. Edit `scripts/vsn-mapping-generator/generate_mapping.py`
  2. Add/modify entry in `SUNSPEC_TO_HA_METADATA` dictionary
  3. Run `python scripts/vsn-mapping-generator/generate_mapping.py`
  4. Run `python scripts/vsn-mapping-generator/convert_to_json.py`
  5. Test changes
  6. Commit generator + all generated files

See [CLAUDE.md](../../CLAUDE.md) section "‚ö†Ô∏è MANDATORY: Sensor Mapping Workflow" for complete instructions.

---

## Commits

- [d4181c9](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/d4181c9) - feat(mapping): extend generator with precision field and all v1.1.3-v1.1.7 fixes

---

## Testing

**Verified**:
- ‚úÖ All 258 sensors have precision field
- ‚úÖ 6 state sensors have `precision=""` (empty string)
- ‚úÖ 3 cycle counters have `state_class="total_increasing"`, `precision=0`
- ‚úÖ Power sensor (W): `precision=0`
- ‚úÖ Voltage sensors (V): `precision=1`
- ‚úÖ Current sensors (A): `precision=2`
- ‚úÖ Riso sensor: `unit="MOhm"`, `icon="mdi:omega"`, `precision=2`
- ‚úÖ Energy sensors: kWh ‚Üí `precision=0`, Wh with decimals ‚Üí `precision=2`
- ‚úÖ Integer count sensors: `precision=0`

**Generator Output**:
```
======================================================================
VSN-SunSpec Point Mapping Generator v2.0.9
Generated: 2025-11-17
======================================================================

‚úì Excel file created: vsn-sunspec-point-mapping.xlsx
  Total rows: 258
  Sheets: All Points, Summary, Changelog

‚úì JSON file created: vsn-sunspec-point-mapping.json
  Total entries: 258

Model Statistics:
  M1: 6 points
  M103: 23 points
  M160: 6 points
  M64061: 21 points
  VSN300-only: 47 points
  VSN700-only: 142 points
  ABB Proprietary: 14 points
======================================================================
```

---

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for the complete changelog.
