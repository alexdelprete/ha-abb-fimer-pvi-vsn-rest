# Release Notes - v1.0.0-beta.2 (Critical Bug Fixes)

**Release Date:** October 27, 2025

## ⚠️ CRITICAL UPDATE - Beta 1 Users MUST Upgrade

This release fixes **two critical bugs** that made v1.0.0-beta.1 essentially non-functional:

1. **VSN300 authentication completely broken**
2. **Integration couldn't load due to missing mapping file**

**If you're running v1.0.0-beta.1, you MUST update to v1.0.0-beta.2.**

---

## Critical Bug Fixes

### 1. Authentication Failure (VSN300)

**Problem:**
Authentication with VSN300 devices failed with error:
```
Authentication failed: Expected 401 challenge, got 200
```

**Root Cause:**

- Critical parameter order bug in `discovery.py`
- When calling `get_vsn300_digest_header()`, parameters were passed in wrong order:
  - Wrong: `(session, base_url, uri, username, password)`
  - Correct: `(session, base_url, username, password, uri, "GET", timeout)`
- This caused:
  - URI (e.g., "/v1/status") to be used as the username
  - Actual username to be used as password
  - Actual password to be used as URI (empty string!)
  - Requests went to root path `/` instead of `/v1/status`
  - Root path returned HTTP 200, not the expected 401 challenge

**Fixed:**

- `discovery.py` - `_fetch_status()` function (line 164-166)
- `discovery.py` - `_fetch_livedata()` function (line 215-217)
- Both now pass parameters in correct order

**Impact:**

- **v1.0.0-beta.1:** VSN300 authentication was completely broken
- **v1.0.0-beta.2:** Authentication works correctly with default credentials (guest/empty)

**Commit:** [c30da3e](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/c30da3e)

---

### 2. Mapping File Not Found

**Problem:**
Integration failed to load with error:
```
Mapping file not found: /config/docs/vsn-sunspec-point-mapping.json
```

**Root Cause:**

- The mapping file `vsn-sunspec-point-mapping.json` was in repository's `docs/` directory
- Not bundled with the integration when installed in Home Assistant
- Mapping loader tried to find it at repository root level, which works in development but fails in production
- Path calculation: `Path(__file__).parent.parent.parent.parent / "docs"` → `/config/docs/` (doesn't exist!)

**Fixed:**

- **Bundled the mapping file** in `custom_components/abb_fimer_pvi_vsn_rest/data/`
- **Updated `mapping_loader.py`** to look in bundled location:
  - Old: `Path(__file__).parent.parent.parent.parent / "docs" / "..."`
  - New: `Path(__file__).parent.parent / "data" / "..."`
  - Resolves to: `abb_fimer_pvi_vsn_rest/data/vsn-sunspec-point-mapping.json`

**Impact:**

- **v1.0.0-beta.1:** Integration couldn't load at all
- **v1.0.0-beta.2:** Mapping file loads correctly, integration works

**Commit:** [228dbcd](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/228dbcd)

---

## New Features

### GitHub Fallback for Mapping File

**Enhancement:**
Added automatic fallback to fetch mapping file from GitHub if local file is not found.

**How it works:**

1. Tries to load bundled local file first (primary method)
2. If not found, automatically fetches from GitHub:
   - URL: `https://raw.githubusercontent.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/master/docs/vsn-sunspec-point-mapping.json`
   - 30-second timeout
3. Caches downloaded file locally for future use
4. Provides clear logging at each step

**Benefits:**

- Automatic recovery if bundled file is missing
- Uses latest mapping from GitHub when needed
- Offline-capable after first successful download
- Robust against file deletion or corruption

**Commit:** [06986e2](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/06986e2)

---

## Other Improvements

### CI/CD Fixes

**Release Workflow:**

- Fixed workflow to dynamically discover integration directory name
- No longer hardcoded to legacy `abb_powerone_pvi_sunspec` name
- Now works correctly for `abb_fimer_pvi_vsn_rest` and any future renames

**Commit:** [56639b1](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/56639b1)

**Gitignore:**

- Added `scripts/test_output_*.json` pattern to ignore test output files

**Commit:** [7b2c318](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/7b2c318)

---

## Installation

Same as v1.0.0-beta.1. See [README.md](../../README.md) for details.

**HACS (Recommended):**

1. Add this repository as a custom repository in HACS
2. Install "ABB/FIMER PVI VSN REST" from HACS
3. Restart Home Assistant
4. Add integration via UI

**Manual:**

1. Copy the `custom_components/abb_fimer_pvi_vsn_rest` directory to your `custom_components` folder
2. Restart Home Assistant
3. Add integration via UI

---

## Migration from v1.0.0-beta.1

**Critical:** If you installed v1.0.0-beta.1, it was likely non-functional. Follow these steps:

### Step 1: Remove Old Integration (if configured)

If you somehow managed to configure it (unlikely due to bugs):

1. Go to Settings → Devices & Services
2. Find "ABB/FIMER PVI VSN REST"
3. Click the three dots → Delete

### Step 2: Update to v1.0.0-beta.2

**Via HACS:**

1. Go to HACS → Integrations
2. Find "ABB/FIMER PVI VSN REST"
3. Click "Update"
4. Restart Home Assistant

**Manual:**

1. Replace the `custom_components/abb_fimer_pvi_vsn_rest` directory
2. Restart Home Assistant

### Step 3: Configure Integration

1. Go to Settings → Devices & Services → Add Integration
2. Search for "ABB/FIMER PVI VSN REST"
3. Configure:
   - **Host:** Your VSN300/VSN700 IP or hostname
   - **Username:** `guest` (default)
   - **Password:** Leave empty (default)
4. Click Submit

Authentication and device discovery should now work correctly!

---

## Testing Recommendations

### Verify Authentication Works

1. Check Home Assistant logs for:
   ```
   Detected VSN300 (digest auth in WWW-Authenticate)
   ```
   or
   ```
   Detected VSN700 (basic auth in WWW-Authenticate)
   ```

2. Verify no errors like:
   - ❌ "Expected 401 challenge, got 200"
   - ❌ "Mapping file not found"

### Verify Device Discovery

1. Go to Settings → Devices & Services
2. Click on your VSN integration
3. Verify you see:
   - Datalogger device (with serial number)
   - Inverter device(s) linked to datalogger
   - Sensors for each device

### Verify Data Collection

1. Click on an inverter device
2. Check that sensors show values:
   - Power (W)
   - Voltage (V)
   - Current (A)
   - Energy (Wh)
   - etc.

---

## Known Issues

No new known issues in this release. The critical bugs from v1.0.0-beta.1 are fixed.

**For reporting issues:**

- GitHub Issues: https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues
- GitHub Discussions: https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions

---

## Technical Details

### Files Changed

1. **custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/discovery.py**
   - Fixed parameter order in `_fetch_status()` (line 164-166)
   - Fixed parameter order in `_fetch_livedata()` (line 215-217)

2. **custom_components/abb_fimer_pvi_vsn_rest/data/vsn-sunspec-point-mapping.json** (new)
   - 124KB mapping file bundled with integration
   - Contains 252 point mappings (112 VSN300, 177 VSN700)

3. **custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/mapping_loader.py**
   - Updated default path to bundled `data/` directory
   - Added `_fetch_from_github()` async method for fallback
   - Enhanced `_load_mappings()` with automatic GitHub fetch

4. **.github/workflows/release.yml**
   - Dynamic integration directory discovery
   - No longer hardcoded to legacy repo name

5. **.gitignore**
   - Added `scripts/test_output_*.json` pattern

6. **manifest.json, const.py**
   - Version bumped to 1.0.0-beta.2

### Test Coverage

All fixes verified with live VSN300 device:

- Hostname: `abb-vsn300.axel.dom`
- Logger S/N: `111033-3N16-1421`
- Inverter S/N: `077909-3G82-3112`
- Model: `PVI-10.0-OUTD`
- Firmware: `1.9.2`

Test script (`test_vsn_client.py`) passed all 5 tests:

1. ✓ Device detection (VSN300)
2. ✓ /v1/status endpoint
3. ✓ /v1/livedata endpoint (2 devices discovered)
4. ✓ /v1/feeds endpoint
5. ✓ Data normalization (53 points total)

---

## Documentation

- **[CHANGELOG.md](../../CHANGELOG.md)** - Complete changelog
- **[README.md](../../README.md)** - Installation and usage guide
- **[CLAUDE.md](../../CLAUDE.md)** - Developer guidelines
- **[v1.0.0-beta.1 Release Notes](v1.0.0-beta.1.md)** - Previous release

---

## Links

- **Full Changelog:** [v1.0.0-beta.2](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/blob/master/CHANGELOG.md#100-beta2---2025-10-27)
- **GitHub Release:** [v1.0.0-beta.2](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/releases/tag/v1.0.0-beta.2)
- **Compare Changes:** [v1.0.0-beta.1...v1.0.0-beta.2](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.0.0-beta.1...v1.0.0-beta.2)
- **Repository:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest

---

Generated with [Claude Code](https://claude.com/claude-code)
