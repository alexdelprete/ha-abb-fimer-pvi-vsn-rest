# v1.0.0-beta.15 Release Notes

**Release Date**: 2025-01-31

## Overview

This release fixes a critical bug where device types were incorrectly detected as "unknown" instead of their actual types (inverter, datalogger, etc.), and implements friendly device naming with the modern Home Assistant `_attr_suggested_object_id` pattern to decouple entity IDs from display names.

## Key Changes

### Critical Bug Fix: Device Type Detection

**Problem**: The normalizer was discarding the `device_type` field from VSN API responses, causing all devices to be labeled as "unknown" in entity IDs.

**Impact**:
- Entity IDs: `sensor.abb_vsn_rest_unknown_0779093g823112_ac_power` ❌
- Should be: `sensor.abb_vsn_rest_inverter_0779093g823112_ac_power` ✓

**Root Cause**: The normalizer at `normalizer.py:200` only preserved the `points` data structure and discarded device-level metadata including `device_type` and `timestamp`.

**Fix**: Updated normalizer to preserve device metadata:
```python
normalized["devices"][actual_device_id] = {
    "device_type": device_data.get("device_type", "unknown"),
    "timestamp": device_data.get("timestamp"),
    "points": normalized_points,
}
```

### User-Friendly Device Names

**Problem**: Device names were showing technical identifiers in the UI instead of user-friendly names:
- Before: `abb_vsn_rest_unknown_0779093g823112` ❌
- Before: `abb_vsn_rest_datalogger_1110333n161421` ❌

**Solution**: Implemented the "Manufacturer Type Model (Serial)" format using `_attr_suggested_object_id` to maintain stable entity IDs while displaying friendly names.

**New Format**:
- Device Name: `Power-One Inverter PVI-3.0-TL-OUTD (077909-3G)` ✓
- Device Name: `ABB Datalogger VSN300 (111033-3N)` ✓
- Entity ID: `sensor.abb_vsn_rest_inverter_0779093g823112_ac_power` (technical, stable)
- Friendly Name: `Power-One Inverter PVI-3.0-TL-OUTD (077909-3G) AC Power` ✓

**Technical Implementation**:
1. Added `_format_device_name()` helper function with format: `"{Manufacturer} {Type} {Model} ({Serial})"`
2. Set `_attr_suggested_object_id` to control entity_id generation independently
3. Used formatted friendly name in `device_info["name"]` for display only
4. Serial format: First 8 chars with hyphen (e.g., "077909-3G") for readability

### Modern Home Assistant Pattern

This release properly implements the modern HA entity naming pattern using `_attr_suggested_object_id`:

**How it works**:
- `_attr_suggested_object_id`: Controls the entity_id (technical identifier)
- `device_info["name"]`: Display name in UI (user-friendly)
- `_attr_name`: Entity-specific display name
- Result: `entity_id` stays stable, `friendly_name` is readable

**Example**:
```python
# Entity ID controlled by suggested_object_id:
self._attr_suggested_object_id = "inverter_0779093g823112_ac_power"
# Result: sensor.abb_vsn_rest_inverter_0779093g823112_ac_power

# Display name friendly:
device_info["name"] = "Power-One Inverter PVI-3.0-TL-OUTD (077909-3G)"
self._attr_name = "AC Power"
# Result friendly_name: "Power-One Inverter PVI-3.0-TL-OUTD (077909-3G) AC Power"
```

## Files Changed

### Core Integration Files:
- `custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/normalizer.py`:
  - Line 200-204: Preserve device_type and timestamp in normalized data

- `custom_components/abb_fimer_pvi_vsn_rest/sensor.py`:
  - Lines 58-95: Added `_format_device_name()` helper function
  - Line 220: Added `_attr_suggested_object_id` for entity_id control
  - Lines 231-234: Store device components for formatting
  - Lines 423-433: Use `_format_device_name()` for device display names
  - Line 391: Fixed ruff error (removed unnecessary assignment)

### Configuration:
- `custom_components/abb_fimer_pvi_vsn_rest/manifest.json`: Version bump to 1.0.0-beta.15
- `custom_components/abb_fimer_pvi_vsn_rest/const.py`: VERSION = "1.0.0-beta.15"

### Documentation:
- `CHANGELOG.md`: Added v1.0.0-beta.15 entry
- `docs/releases/v1.0.0-beta.15.md`: This file

## Breaking Changes

### For New Installations

**Entity IDs will be correct**:
- Device type will be "inverter" instead of "unknown"
- Entity ID template: `sensor.abb_vsn_rest_{device_type}_{serial}_{point_name}`
- Example: `sensor.abb_vsn_rest_inverter_0779093g823112_ac_power` ✓

### For Existing Users (Beta.14)

**Entity IDs remain stable** (locked by unique_id):
- Entity IDs: Keep "unknown" in the ID (e.g., `sensor.abb_vsn_rest_unknown_0779093g823112_ac_power`)
- Friendly names: **Updated** to friendly format automatically
- Device names: **Updated** to friendly format (e.g., "Power-One Inverter PVI-3.0-TL-OUTD (077909-3G)")

**Migration Options**:
1. **Live with "unknown" in entity IDs**: Everything works, just cosmetic
2. **Delete and re-add integration**: Gets correct entity IDs with "inverter"
3. **Wait for v1.0.0**: Will provide migration path to clean up entity IDs

## Technical Details

### Device Type Flow

**Before (broken)**:
```
VSN API → device_type: "inverter_3phases"
    ↓
Normalizer → DISCARDED ❌
    ↓
Sensor → device_type: "unknown" (default)
    ↓
Entity ID → sensor.abb_vsn_rest_unknown_..._ac_power ❌
```

**After (fixed)**:
```
VSN API → device_type: "inverter_3phases"
    ↓
Normalizer → PRESERVED ✓
    ↓
Sensor → device_type: "inverter" (simplified)
    ↓
Entity ID → sensor.abb_vsn_rest_inverter_..._ac_power ✓
```

### Device Name Format

**Components**:
- **Manufacturer**: From SunSpec M1 Common Model `C_Mn` point (e.g., "Power-One", "ABB", "FIMER")
- **Type**: Simplified and capitalized (e.g., "Inverter", "Datalogger", "Meter")
- **Model**: From discovered device model (e.g., "PVI-3.0-TL-OUTD", "VSN300")
- **Serial**: First 8 chars formatted with hyphen (e.g., "077909-3G")

**Format**: `"{Manufacturer} {Type} {Model} ({Serial})"`

**Examples**:
- `"Power-One Inverter PVI-3.0-TL-OUTD (077909-3G)"`
- `"ABB Datalogger VSN300 (111033-3N)"`
- `"FIMER Meter ABC-123 (456789-0A)"`
- `"ABB Inverter 077909-3G"` (fallback if no model)

### _attr_suggested_object_id Pattern

**Purpose**: Decouples entity_id generation from friendly display names.

**HA Behavior**:
1. First registration: `suggested_object_id` influences initial entity_id
2. After registration: entity_id locked by unique_id (stable)
3. Display names: Derived from `device_info["name"]` + `_attr_name` (can change)

**Benefits**:
- Stable, predictable entity IDs (technical identifiers)
- User-friendly display names (manufacturer, model, readable serial)
- No breaking changes when improving display names
- Follows modern Home Assistant best practices

## Migration Notes

### For Users

**Upgrading from Beta.14**:

**Option 1: No Action Required** (Recommended for now)
- Your existing entity IDs remain stable (locked by unique_id)
- Device and friendly names automatically improve
- Entity IDs will contain "unknown" but everything works

**Option 2: Clean Install** (Get correct entity IDs now)
1. Remove integration in HA UI
2. Delete `.storage/core.entity_registry` entries for this integration
3. Re-add integration
4. Result: All entity IDs correct with "inverter" instead of "unknown"

**Option 3: Wait for v1.0.0** (Recommended)
- v1.0.0 will provide entity_id migration utility
- One-click fix to rename all entity IDs from "unknown" → "inverter"
- Preserves history and dashboard configurations

### For Developers

**Testing Checklist**:
- [x] device_type flows from VSN API → normalizer → sensor
- [x] Entity IDs follow correct template (inverter not unknown)
- [x] Device names show friendly format
- [x] Friendly names combine device + entity names
- [x] _attr_suggested_object_id controls entity_id
- [x] All ruff checks pass
- [x] No breaking changes for existing users

## Verification

### Code Quality
- [x] Python syntax valid (py_compile passed)
- [x] Ruff checks passed (all errors fixed)
- [x] Fixed pre-existing RET504 error in sensor.py
- [x] Follows CLAUDE.md guidelines
- [x] Modern HA `has_entity_name=True` pattern
- [x] Uses `_attr_suggested_object_id` correctly

### Testing
- [ ] Tested with VSN300 livedata
- [ ] Tested with VSN700 livedata
- [ ] Verified device type detection
- [ ] Verified friendly names
- [ ] Verified entity IDs

## Benefits

1. **Correct Device Types**: Devices now properly identified (inverter, datalogger, etc.)
2. **Professional Display**: Device names match physical product labels
3. **Readable Serials**: Hyphenated format (077909-3G) easier to scan than compact (0779093g823112)
4. **Manufacturer Visible**: Shows actual manufacturer from firmware (Power-One, ABB, FIMER)
5. **Stable Entity IDs**: Technical identifiers remain stable despite UI improvements
6. **Modern Pattern**: Uses recommended HA `_attr_suggested_object_id` approach

## Known Issues

**For Beta.14 Users**: Entity IDs will contain "unknown" instead of "inverter" due to unique_id locking. This is cosmetic only and will be addressed with migration utility in v1.0.0.

## Next Steps

For v1.0.0 (stable release):
- Entity ID migration utility for Beta users
- Additional testing with various VSN/inverter combinations
- Performance optimizations
- Enhanced error handling
- Final documentation review

---

**Full Changelog**: [v1.0.0-beta.14...v1.0.0-beta.15](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.0.0-beta.14...v1.0.0-beta.15)
