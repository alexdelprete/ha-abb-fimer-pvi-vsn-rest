# v1.0.0-beta.5 - Entity ID Improvements & Device Info Fixes

**Release Date:** 2025-01-27

Fifth beta release focusing on entity ID standardization, diagnostic entity support, and device information improvements.

---

## ‚ö†Ô∏è BREAKING CHANGES

### Entity ID Changes

**ALL entity IDs have been updated for consistency and readability.** Existing installations will see entity ID changes requiring reconfiguration.

**Entity ID Patterns:**
- **With Model Number**: `abb_{model}_{human_readable_label}`
- **Without Model Number**: `abb_vsn_{human_readable_label}`

**Examples:**

| Old Entity ID | New Entity ID | Description |
|--------------|---------------|-------------|
| `abb_m103_phvphbc` | `abb_m103_phase_voltage_bc` | Phase Voltage BC |
| `abb_m103_hza` | `abb_m103_frequency_phase_a` | Frequency Phase A |
| `abb_m64061_daywh` | `abb_m64061_daily_energy` | Daily Energy |
| `abb_m64061_alarmstate` | `abb_m64061_alarm_state` | Alarm State (space fix) |
| `abb_mn` | `abb_m1_mn` | Manufacturer (M1 prefix added) |
| `abb_e0_energy_yearly` | `abb_vsn_e0_energy_yearly` | VSN prefix added |
| `abb_flash_free` | `abb_vsn_flash_free` | VSN prefix added |

**Migration Required:** You'll need to update any automations, scripts, or dashboards referencing these entity IDs.

---

## ‚ú® What's New

### Diagnostic Entities

Added M1 Common Model and VSN system monitoring points as diagnostic entities. These static/infrequently-changing points are now:
- **Excluded from HA Recorder** - Saves database space
- **Hidden from standard entity lists** - Visible in advanced view only
- **Useful for troubleshooting** - Device info and datalogger health monitoring

**M1 Common Model Points (Device Identification):**
- `C_Mn` - Manufacturer
- `C_Md` - Model
- `C_Opt` - Options/Features
- `C_SN` - Serial Number
- `C_Vr` - Firmware Version
- `C_DA` - Device Address

**VSN System Monitoring Points (Datalogger Health):**
- `fw_ver` - VSN firmware version
- `uptime` - Datalogger uptime (seconds)
- `sys_load` - System load percentage
- `free_ram` - Available RAM (KB)
- `flash_free` - Available flash storage (KB)
- `store_size` - Data store size (KB)

### Entity Category Support

Added complete entity category pipeline support:
- New "Entity Category" column in Excel mapping file
- Integrated throughout: Excel ‚Üí JSON ‚Üí normalizer ‚Üí sensor platform
- Sensors marked as `diagnostic` automatically get `EntityCategory.DIAGNOSTIC`

---

## üîß Improvements

### Sensor Labels

Enhanced label generation for 21 VSN300-specific SunSpec points:
- M103: Phase voltages, per-phase frequencies, peak power
- M64061: State codes, leakage currents, isolation, temperature, periodic energy

**Before:** "(M103) PhVphBC"
**After:** "Phase Voltage BC"

### Entity ID Generation

Three major fixes ensure consistency:

1. **VSN Prefix for Non-Model Points**
   - Points without SunSpec model number now get `abb_vsn_` prefix
   - Distinguishes VSN-aggregated/system points from SunSpec model points
   - Affects 69 points (periodic energy, system monitoring, VSN totals)

2. **M1 Common Model Prefix**
   - Added missing `m1` prefix to M1 Common Model point entity IDs
   - Root cause: Model was set after entity ID generation
   - Fixed with early detection of `C_` prefix
   - Affects 6 points

3. **M64061 Label-Based IDs**
   - Generate entity IDs from human-readable labels instead of technical names
   - Fixes "alarmstate" ‚Üí "alarm_state" (proper word separation)
   - Affects M64061 periodic and non-periodic points

### Integration Title Format

Changed hub/integration title to use parentheses for consistency with device names:
- **Before:** `VSN300 - 111033-3N16-1421` (hyphen)
- **After:** `VSN300 (111033-3N16-1421)` (parentheses)

All names now use consistent "Model (Serial)" format.

### Mapping Files

Updated VSN-SunSpec mapping files:
- Excel: 260 ‚Üí 277 rows (17 new diagnostic points)
- JSON: Added `entity_category` field (141.1 KB)
- All entity IDs regenerated with improved patterns

---

## üêõ Bug Fixes

### VSN Datalogger Device Model

Fixed datalogger device showing "Model: unknown" in Home Assistant Device Info.

**Root Cause:** During discovery, `device_model` was never set for datalogger devices:
- VSN700: Only checked `device_data.get("device_model")` which returned None
- VSN300: Explicitly skipped dataloggers with `and not is_datalogger`

**Solution:** Set `device_model = vsn_model` for dataloggers ("VSN300" or "VSN700")

**Result:** Device Info now shows proper model instead of "unknown"

### "No Mapping Found" Warnings

Eliminated 12 unmapped point warnings in logs:
- M1 Common Model points (6)
- VSN system monitoring points (6)

All previously unmapped diagnostic points now properly mapped and visible as diagnostic entities.

### String Sensor Attributes

Fixed string sensors being treated as numeric (beta.4 regression fix continued).
- All numeric attributes explicitly set to `None` for string sensors
- Prevents HA from inferring numeric type

---

## üìã Technical Details

### Files Modified

**Component:**
- `sensor.py` - Entity category support, diagnostic entities
- `abb_fimer_vsn_rest_client/discovery.py` - Datalogger device model, integration title format
- `abb_fimer_vsn_rest_client/mapping_loader.py` - Entity category field
- `abb_fimer_vsn_rest_client/normalizer.py` - Entity category propagation

**Scripts & Mapping:**
- `scripts/generate_mapping_excel.py` - Label generation, entity ID generation, M1 detection, M64061 improvements
- `scripts/generate_mapping_json.py` - Entity category statistics
- `docs/vsn-sunspec-point-mapping.xlsx` - Regenerated (277 rows, 18 diagnostic entities)
- `docs/vsn-sunspec-point-mapping.json` - Regenerated (141.1 KB)

**Documentation:**
- `README.md` - Updated version to beta.5
- `CHANGELOG.md` - Comprehensive documentation of all changes

### Commits

- [2467355](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/2467355) - feat: Add M1 and system monitoring as diagnostic entities
- [532f349](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/532f349) - fix: Improve sensor labels for VSN300-specific points
- [2a649cf](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/2a649cf) - fix: Generate entity IDs from human-readable labels
- [b2e7838](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/b2e7838) - fix: Add abb_vsn_ prefix and fix M1/M64061 entity IDs
- [f378c50](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/f378c50) - fix: Set VSN datalogger device model to vsn_model
- [ae75f9f](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/ae75f9f) - fix: Use parentheses in integration title

---

## üéØ Known Issues

- **Beta Release** - Please report any issues on [GitHub](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues)
- **Entity ID Migration** - Breaking change requires reconfiguration of automations/scripts/dashboards
- **Limited VSN700 Testing** - Tested primarily on VSN300 devices

---

## üì• Installation

### HACS (Recommended)
1. Add custom repository: `https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest`
2. Install "ABB/FIMER PVI VSN REST"
3. Restart Home Assistant
4. Add integration via UI: Settings ‚Üí Devices & Services ‚Üí Add Integration

### Manual
1. Download `abb_fimer_pvi_vsn_rest.zip` from this release
2. Extract to `custom_components/`
3. Restart Home Assistant
4. Add integration via UI

---

## üôè Feedback

- **Issues**: https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues
- **Discussions**: https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions

---

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
