# Release Notes - v1.2.2

**Release Date**: 2025-12-05

**Focus**: Complete Support for Devices Without Authentication

______________________________________________________________________

## Overview

This release completes the fix for Issue #25 that was only partially fixed in v1.2.1. Users with VSN devices that have authentication disabled can now fully use the integration.

Thanks to **@wannabuy** for continued testing and feedback on [Issue #25](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues/25).

______________________________________________________________________

## Bug Fixes

### Complete Support for Devices Without Authentication

**Problem in v1.2.1**: While v1.2.1 fixed the device detection to handle HTTP 200 responses (no authentication required), subsequent data fetching still failed. The error message
was:

```text
Client error: Expected 401 challenge response, got 200
```text

**Root Cause**: The `requires_auth` state was correctly detected but not tracked through the entire data flow:

| Stage | v1.2.1 Status | Issue | |-------|---------------|-------| | Detection | ✅ Fixed | HTTP 200 → correctly detected VSN300 | | Status fetch | ❌ Broken | Called
`get_vsn300_digest_header()` → expected 401 | | Livedata fetch | ❌ Broken | Called `get_vsn300_digest_header()` → expected 401 | | Feeds fetch | ❌ Broken | Called
`get_vsn300_digest_header()` → expected 401 |

**Complete Fix Applied**:

The `requires_auth` flag is now tracked throughout the entire codebase:

1. **Detection** (`auth.py`):

   - `detect_vsn_model()` now returns a tuple: `(model, requires_auth)`
   - When HTTP 200 is received, `requires_auth=False`
   - When HTTP 401 is received, `requires_auth=True`

1. **Discovery** (`discovery.py`):

   - `DiscoveryResult` dataclass now includes `requires_auth` field
   - `_fetch_status()` and `_fetch_livedata()` accept `requires_auth` parameter
   - When `requires_auth=False`, no authentication headers are sent

1. **Client** (`client.py`):

   - `ABBFimerVSNRestClient` stores `requires_auth` attribute
   - `get_livedata()` skips authentication when `requires_auth=False`

1. **Config Flow** (`config_flow.py`):

   - `requires_auth` is stored in config entry data for persistence

1. **Scripts**:

   - Both `vsn_rest_client.py` and `test_vsn_client.py` follow the same pattern

______________________________________________________________________

## Technical Details

### Files Modified

| File | Changes | |------|---------| | `const.py` | Added `CONF_REQUIRES_AUTH` constant | | `auth.py` | `detect_vsn_model()` returns `tuple[str, bool]` | | `discovery.py` | Added
`requires_auth` field to `DiscoveryResult`, updated fetch functions | | `client.py` | Added `requires_auth` attribute, conditional auth in `get_livedata()` | | `config_flow.py` |
Store `requires_auth` in config entry data | | `__init__.py` | Pass `requires_auth` to client constructor | | `scripts/vsn-rest-client/vsn_rest_client.py` | Same pattern for
standalone script | | `scripts/test_vsn_client.py` | Same pattern for test script |

### Authentication Flow (Updated)

```text
Request /v1/status (unauthenticated)
        │
        ├─── HTTP 401 ───────────────────────────────────────┐
        │    │                                               │
        │    ├── WWW-Authenticate: X-Digest... ─→ VSN300     │
        │    │   requires_auth = True                        │
        │    │                                               │
        │    └── Try Basic auth ─→ HTTP 200 ─→ VSN700        │
        │        requires_auth = True                        │
        │                                                    │
        └─── HTTP 200 ───────────────────────────────────────┤
             │                                               │
             ├── Analyze status data structure               │
             │   ├── WIFI LOGGER CARD → VSN300               │
             │   ├── MAC address loggerId → VSN700           │
             │   └── Key count heuristics                    │
             │                                               │
             └── requires_auth = False                       │
                                                             │
                         ┌───────────────────────────────────┘
                         │
                         ▼
              Track requires_auth throughout:
              - Discovery (fetch status, livedata)
              - Client (runtime data fetching)
              - Config entry (persistence)
```text

### Backward Compatibility

- Existing config entries without `requires_auth` default to `True`
- Use `.get(CONF_REQUIRES_AUTH, True)` everywhere
- No migration needed for existing installations

______________________________________________________________________

## Testing

### Standalone Script

Users can test the fix using the updated standalone script:

```bash
# Download
wget https://raw.githubusercontent.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/master/scripts/vsn-rest-client/vsn_rest_client.py

# Run
python vsn_rest_client.py 192.168.1.100
```text

**Expected output for devices without authentication**:

```text
[VSN Detection] No authentication required (HTTP 200). Detecting model from status data structure.
[VSN Detection] Detected VSN300 (board_model='WIFI LOGGER CARD')
✓ Device detected: VSN300
  - Requires authentication: False
✓ Status endpoint successful
✓ Livedata endpoint successful
✓ Feeds endpoint successful
```text

______________________________________________________________________

## Upgrade Notes

This is a non-breaking bug fix release. Simply update to the latest version.

**For users with unauthenticated VSN devices**: The integration should now work correctly. If you previously had issues with v1.2.1, please try again with v1.2.2.

______________________________________________________________________

## Related Issues

- Fixes [Issue #25](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues/25) - Support for devices without authentication
