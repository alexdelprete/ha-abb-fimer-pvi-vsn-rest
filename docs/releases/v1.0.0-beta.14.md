# v1.0.0-beta.14 Release Notes

**Release Date**: 2025-01-31

## Overview

This release focuses on cleanup and consistency by removing duplicate columns from the mapping file and standardizing all references to use HA-prefixed column names. This change has **zero functional impact** but improves code clarity and maintainability.

## Key Changes

### Mapping Column Cleanup

**Removed Duplicate Columns**:
- ❌ "Units" → ✅ "HA Unit of Measurement"
- ❌ "State Class" → ✅ "HA State Class"
- ❌ "Device Class" → ✅ "HA Device Class"

**Rationale**: These columns represent Home Assistant concepts (`SensorDeviceClass`, `SensorStateClass`, `unit_of_measurement`). Using the "HA" prefix makes this explicit and removes confusion about whether SunSpec values needed transformation to HA values (they don't—they're identical).

**Impact**:
- Excel file: 29 columns → 26 columns
- JSON entries: Removed 3 duplicate keys from all 210 mappings
- Code: All references updated to use HA-prefixed names
- Functionality: **Zero change** (duplicate columns were never used)

### Code Updates

All code locations that referenced the old column names have been updated:

#### Scripts Updated:
1. **`scripts/generate_mapping_excel.py`**:
   - Removed duplicate column headers
   - Removed duplicate data assignments
   - Updated comments to reflect HA-prefixed columns

2. **`scripts/analyze_and_deduplicate_mapping.py`**:
   - Removed duplicate column references from column groups
   - Updated to only reference HA-prefixed columns

3. **`scripts/vsn_client.py`**:
   - Updated `.get()` calls to use HA-prefixed names
   - Changed: `mapping.get("Units")` → `mapping.get("HA Unit of Measurement")`
   - Changed: `mapping.get("State Class")` → `mapping.get("HA State Class")`
   - Changed: `mapping.get("Device Class")` → `mapping.get("HA Device Class")`

#### Integration Code Updated:
1. **`mapping_loader.py`**:
   - Updated documentation comments (removed duplicate column references)
   - Updated data extraction calls to use HA-prefixed names
   - Changed: `row.get("Units")` → `row.get("HA Unit of Measurement")`
   - Changed: `row.get("State Class")` → `row.get("HA State Class")`
   - Changed: `row.get("Device Class")` → `row.get("HA Device Class")`

### JSON Regeneration

Both mapping JSON files have been regenerated from the cleaned Excel file:
- `docs/vsn-sunspec-point-mapping.json`
- `custom_components/abb_fimer_pvi_vsn_rest/data/vsn-sunspec-point-mapping.json`

**Changes**:
- Removed duplicate keys ("Units", "State Class", "Device Class")
- Retained only HA-prefixed versions
- All 210 entries updated
- Smaller file size (~10% reduction)

### Documentation Updates

**`docs/MAPPING_FORMAT.md`** - Comprehensive refresh:
- Updated Excel file reference: `vsn-sunspec-point-mapping-v2.xlsx`
- Updated JSON example with HA-prefixed fields
- Updated field table with only HA-prefixed columns
- Corrected statistics (210 unique mappings)
- Updated script references (`convert_excel_to_json_v2.py`)
- Added model distribution statistics
- Updated workflow and maintenance sections
- Updated "See Also" section with current scripts

## Files Changed

### Configuration:
- `custom_components/abb_fimer_pvi_vsn_rest/manifest.json`: Version bump to 1.0.0-beta.14
- `custom_components/abb_fimer_pvi_vsn_rest/const.py`: VERSION = "1.0.0-beta.14"

### Mapping Files:
- `docs/vsn-sunspec-point-mapping-v2.xlsx`: Removed 3 duplicate columns
- `docs/vsn-sunspec-point-mapping.json`: Regenerated without duplicate keys
- `custom_components/abb_fimer_pvi_vsn_rest/data/vsn-sunspec-point-mapping.json`: Regenerated

### Scripts:
- `scripts/generate_mapping_excel.py`: Updated headers and data assignments
- `scripts/analyze_and_deduplicate_mapping.py`: Removed duplicate column references
- `scripts/vsn_client.py`: Updated to use HA-prefixed column names
- `scripts/remove_duplicate_columns.py`: New utility script (one-time use)

### Integration Code:
- `custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/mapping_loader.py`: Updated data extraction

### Documentation:
- `CHANGELOG.md`: Added v1.0.0-beta.14 entry
- `docs/MAPPING_FORMAT.md`: Comprehensive update
- `docs/releases/v1.0.0-beta.14.md`: This file

## Technical Details

### Column Mapping Changes

**Before (29 columns)**:
```
..., Category, Units, HA Unit of Measurement, State Class, HA State Class,
Device Class, HA Device Class, Entity Category, ...
```

**After (26 columns)**:
```
..., Category, HA Unit of Measurement, HA State Class, HA Device Class,
Entity Category, ...
```

### JSON Structure Example

**Before**:
```json
{
  "Label": "Amps",
  "Category": "Inverter",
  "Units": "A",
  "HA Unit of Measurement": "A",
  "State Class": "measurement",
  "HA State Class": "measurement",
  "Device Class": "current",
  "HA Device Class": "current"
}
```

**After**:
```json
{
  "Label": "Amps",
  "Category": "Inverter",
  "HA Unit of Measurement": "A",
  "HA State Class": "measurement",
  "HA Device Class": "current"
}
```

## Migration Notes

### For Developers

**No action required**. This is a purely internal cleanup:
- All code updated to use new column names
- JSON regenerated automatically
- No API changes
- No entity ID changes
- No entity behavior changes

### For Users

**No action required**. This release has:
- ✅ No entity ID changes
- ✅ No sensor value changes
- ✅ No configuration changes
- ✅ No breaking changes

## Verification

### Testing Checklist

- [x] Excel file opens correctly with 26 columns
- [x] JSON files contain only HA-prefixed fields (no duplicates)
- [x] All Python scripts reference HA-prefixed columns
- [x] Integration code updated consistently
- [x] Documentation reflects new structure
- [x] Version bumped in manifest.json and const.py

### Code Quality

- [x] All `.get()` calls updated to HA-prefixed names
- [x] Comments updated to reflect HA-prefixed columns
- [x] Documentation examples use new structure
- [x] No references to old column names remain

## Benefits

1. **Clearer Intent**: HA prefix makes it explicit these are Home Assistant concepts
2. **Reduced Confusion**: No question about whether transformation is needed
3. **Smaller Files**: JSON files ~10% smaller without duplicate keys
4. **Better Maintenance**: Single source of truth for each value
5. **Code Clarity**: Consistent naming throughout codebase

## Known Issues

None.

## Next Steps

For the next release, we'll focus on:
- Additional sensor metadata improvements
- Performance optimizations
- Enhanced error handling

---

**Full Changelog**: [v1.0.0-beta.13...v1.0.0-beta.14](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.0.0-beta.13...v1.0.0-beta.14)
