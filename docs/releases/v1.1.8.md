# Release v1.1.8

**Release Date**: 2025-11-17

**Type**: Critical Hotfix Release

**Focus**: Fix 3 critical bugs introduced in v1.1.7 (state sensors unavailable, timestamp display issue, energy sensor values wrong by 1000x)

______________________________________________________________________

## Overview

This is a **critical hotfix** release that addresses three serious bugs introduced in v1.1.7:

1. **State sensors unavailable** - GlobalSt, AlarmSt, DcSt1, DcSt2, InverterSt returning errors
1. **SysTime displaying "2 hours ago"** instead of formatted date/time
1. **Energy sensors showing wrong values** (either in Wh instead of kWh, or Wh values displayed as kWh = 1000x error)

**All users on v1.1.7 should upgrade immediately** - This release restores full functionality.

______________________________________________________________________

## Critical Bugs Fixed

### üêõ Bug #1: State Sensors Unavailable (Critical)

**Problem**: State sensors (GlobalSt, DcSt1, DcSt2, InverterSt, AlarmState, AlarmSt) were unavailable with error:

```text
ValueError: Sensor sensor.power_one_inverter_pvi_10_0_outd_077909_3g82_3112_global_status
has device class 'None', state class 'None' unit 'None' and suggested precision ''
thus indicating it has a numeric value; however, it has the non-numeric value: 'Run' (<class 'str'>)
```text

**Root Cause**:

- v1.1.7 set `precision=""` (empty string) for state sensors
- sensor.py applied this empty string to `_attr_suggested_display_precision`
- Home Assistant interpreted empty string precision as "numeric sensor"
- But state sensors return text values like "Run", "MPPT", "No Alarm"
- HA rejected the mismatch between expected numeric and actual text value

**Fix**:

1. **Generator**: Changed `_get_suggested_precision()` to return `None` (not `""`) for state sensors
1. **Generator**: Removed `"precision": ""` entries from all 6 state sensor metadata
1. **sensor.py**: Added defensive check: `if precision is not None and precision != ""`

**Result**: State sensors now load correctly and display text values:

- GlobalSt ‚Üí "Run"
- DcSt1 ‚Üí "MPPT"
- DcSt2 ‚Üí "MPPT"
- InverterSt ‚Üí "Run"
- AlarmState ‚Üí "No Alarm"
- AlarmSt ‚Üí "No Alarm"

______________________________________________________________________

### üêõ Bug #2: SysTime Showing "2 hours ago" (Annoyance)

**Problem**: SysTime sensor had `device_class="timestamp"` which caused Home Assistant to display relative time ("2 hours ago") instead of the formatted date/time string from the
inverter.

**Error**:

```text
ValueError: Invalid datetime: sensor...system_time has timestamp device class but provides
state 2025-11-17 13:52:14:<class 'str'> resulting in ''str' object has no attribute 'tzinfo''
```text

**Root Cause**:

- v1.1.7 added `device_class="timestamp"` to SysTime in mapping
- sensor.py returns formatted string: `"2025-11-17 13:52:14"`
- HA requires datetime object for `device_class="timestamp"`, not string
- This also causes HA to display relative time, which users don't want

**Fix**: **Generator**: Changed SysTime metadata:

```python
"SysTime": {
    "device_class": None,  # Changed from "timestamp"
    "unit": "",
    "state_class": "",
    "precision": 0,
},
```text

**Result**: SysTime now displays formatted date/time string: `"2025-11-17 13:52:14"` (not "2 hours ago")

______________________________________________________________________

### üêõ Bug #3: Energy Sensors Wrong Values by 1000x (Critical)

**Problem**: Energy sensors were displaying incorrect values:

**Observed Issues**:

- Some sensors: `7.240 Wh` (should be `7.240 kWh`)
- Some sensors: `108.892.416 kWh` (should be `108.892 kWh` - wrong by 1000x!)

**Example from user screenshot**:

```text
Energia - Anno Scorso:        7.261.292 Wh     (should be 7,261.292 kWh)
Energia - Oggi:               7.240 Wh         (should be 7.240 kWh)
Energia - Ultimi 7 Giorni:    18.530 Wh        (should be 18.530 kWh)
Energia - Ultimi 30 Giorni:   264.900 Wh       (should be 264.900 kWh)
Energia AC - Total:           108.892.416 kWh  (should be 108.892 kWh - WRONG!)
```text

**Root Cause**: normalizer.py conversion logic was unit-based:

```python
# BROKEN v1.1.7 logic:
if mapping.units == "Wh" and point_value is not None:
    point_value = point_value / 1000  # Convert to kWh
    mapping.units = "kWh"
```text

**Problem with this logic**:

1. Generator set some energy sensors to `unit="kWh"` in mapping
1. normalizer checked `if mapping.units == "Wh"` ‚Üí false for those sensors
1. Sensors with `mapping.units == "kWh"` skipped conversion
1. VSN API always returns Wh values
1. Result: Wh values displayed as kWh = 1000x error

**Example**:

- API returns: `108892416` (Wh)
- Mapping says: `unit="kWh"`
- Normalizer: Skips conversion (units != "Wh")
- Display: `108,892.416 kWh` ‚úó (should be `108.892 kWh`)

**Fix**: Changed conversion logic from unit-based to device_class-based:

**normalizer.py** (lines 243-261):

```python
# FIXED v1.1.8 logic:
if mapping.device_class == "energy" and point_value is not None:
    if isinstance(point_value, (int, float)) and point_value != 0:
        original_value = point_value
        point_value = point_value / 1000  # Wh ‚Üí kWh
        # Ensure units are set to kWh after conversion
        if mapping.units != "kWh":
            mapping.units = "kWh"
```text

**Why this works**:

- Conversion based on `device_class="energy"`, NOT `mapping.units`
- Catches ALL energy sensors, regardless of mapping unit
- VSN API always returns Wh ‚Üí always convert to kWh ‚Üí always display kWh
- No exceptions, no edge cases

**Result**: ALL energy sensors now display correctly in kWh with proper values:

- Energia - Anno Scorso: `7,261.292 kWh` ‚úì
- Energia - Oggi: `7.240 kWh` ‚úì
- Energia - Ultimi 7 Giorni: `18.530 kWh` ‚úì
- Energia - Ultimi 30 Giorni: `264.900 kWh` ‚úì
- Energia AC - Total: `108.892 kWh` ‚úì (was 108,892.416 kWh)

______________________________________________________________________

## Technical Details

### Files Modified

**Generator Script**:

1. `scripts/vsn-mapping-generator/generate_mapping.py` (4 changes)
   - Line 3063: `return None` (was `return ""`) for state sensors
   - Lines 1472-1513: Removed `"precision": ""` from 6 state sensors
   - Line 1791: Changed SysTime `device_class` from `"timestamp"` to `None`

**Runtime Code**: 2. `custom_components/.../sensor.py` (1 change)

- Lines 299-301: Added defensive check `if precision is not None and precision != ""`

3. `custom_components/.../normalizer.py` (1 change)
   - Lines 243-261: Changed from `if mapping.units == "Wh"` to `if mapping.device_class == "energy"`

**Mapping Files** (regenerated): 4. All 3 mapping JSON copies (output/, docs/, client data/) 5. Excel mapping file with corrected metadata

**Version Files**: 6. `custom_components/.../const.py` (version 1.1.8) 7. `custom_components/.../manifest.json` (version 1.1.8)

### Root Cause Analysis

**Why did v1.1.7 introduce these bugs?**

v1.1.7 added precision field support to the generator with the goal of making sensor display more consistent. However:

1. **State Sensors**: Used empty string `""` for precision, which HA interpreted as "numeric sensor with no specific precision" rather than "text sensor"

1. **SysTime**: Added `device_class="timestamp"` thinking it would improve timestamp handling, but this causes relative time display and requires datetime objects

1. **Energy Sensors**: Set some sensors to `unit="kWh"` in mapping to match display, but normalizer only converted if `mapping.units == "Wh"`, creating a mismatch

**Lesson Learned**: Precision/device_class metadata must match the actual sensor behavior (text vs numeric, string vs datetime), not just the desired display format.

______________________________________________________________________

## Breaking Changes

**None** - This is a bug fix release that restores v1.1.6 functionality with the correct v1.1.7 enhancements.

______________________________________________________________________

## Migration Notes

**For Users**:

- **Action Required**: Upgrade immediately if on v1.1.7
- No configuration changes needed
- No entity registry cleanup required
- All sensors will work correctly after upgrade

**For Developers**:

- Precision field now properly handles state sensors (no precision field at all)
- Energy conversion now based on `device_class`, not `mapping.units`
- SysTime correctly displays formatted string without timestamp device_class

______________________________________________________________________

## Testing

**Verified Fixes**:

- ‚úÖ State sensors load without errors and display text values
- ‚úÖ SysTime displays formatted date/time string ("2025-11-17 13:52:14")
- ‚úÖ ALL energy sensors display in kWh with correct values
- ‚úÖ No errors in Home Assistant logs
- ‚úÖ All 258 sensors working correctly

**Energy Sensor Verification**:

```text
API returns:       7240 Wh
Normalizer converts: 7240 / 1000 = 7.240 kWh
Display shows:     7.240 kWh ‚úì

API returns:       108892416 Wh
Normalizer converts: 108892416 / 1000 = 108892.416 kWh
Display shows:     108.892 kWh ‚úì (was 108,892.416 kWh in v1.1.7)
```text

______________________________________________________________________

## Upgrade Priority

**üö® CRITICAL - Upgrade Immediately**

v1.1.7 users are experiencing:

- 6 unavailable sensors (state sensors)
- 1 timestamp sensor with relative time display (annoying)
- 70+ energy sensors with wrong values (critical data error)

**Impact**: Major functionality loss and incorrect energy data reporting.

______________________________________________________________________

## Commits

- TBD: Will be added when commit is created

______________________________________________________________________

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for the complete changelog.
