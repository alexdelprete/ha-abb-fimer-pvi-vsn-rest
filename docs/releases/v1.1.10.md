# Release Notes - v1.1.10

**Release Date**: 2025-11-17

**Type**: Critical Hotfix Release

**Focus**: Fix energy sensors still showing Wh instead of kWh after v1.1.9 (normalizer bug)

______________________________________________________________________

## Overview

This is a **critical hotfix** release that addresses a bug in v1.1.9 where energy sensors still displayed Wh instead of kWh even after fresh installation.

**Issue**: After v1.1.9 upgrade, users reported that 4 energy sensors (DayWH, WeekWH, MonthWH, YearWH) still showed Wh units:

- Energia - Anno Scorso: 7.262.658 Wh (should be 7.262 kWh)
- Energia - Oggi: 8.606 Wh (should be 8.606 kWh)
- Energia - Ultimi 7 Giorni: 19.896 Wh (should be 19.896 kWh)
- Energia - Ultimi 30 Giorni: 266.266 Wh (should be 266.266 kWh)

**All users on v1.1.9 should upgrade immediately** - This release fixes the energy sensor unit display bug.

______________________________________________________________________

## Critical Bug Fixed

### üêõ Bug: Energy Sensors Still Showing Wh Instead of kWh (Critical)

**Problem**: Despite v1.1.9 changes:

1. Generator set `unit="kWh"` in mapping ‚úì
1. Normalizer converted values Wh‚ÜíkWh ‚úì

Energy sensors STILL displayed in Wh after fresh installation (not a caching issue).

**User Verification**:

- User deleted integration completely
- Restarted Home Assistant
- Reinstalled integration
- Energy sensors still showed Wh (confirmed NOT a cache issue)

**Root Cause Analysis**:

The normalizer code was trying to modify the PointMapping dataclass attribute:

```python
# v1.1.9 CODE (BROKEN):
if mapping.device_class == "energy" and point_value is not None:
    if isinstance(point_value, (int, float)) and point_value != 0:
        point_value = point_value / 1000  # Wh ‚Üí kWh ‚úì
        if mapping.units != "kWh":
            mapping.units = "kWh"  # ‚Üê Trying to modify dataclass attribute

normalized_point = {
    ...
    "units": mapping.units,  # ‚Üê Still showing original value "Wh"!
}
```text

**Why This Failed**:

The `mapping` object is a `PointMapping` dataclass instance. When we try to modify `mapping.units = "kWh"`, the modification either:

1. Doesn't work at all (dataclass is frozen or immutable in some contexts), OR
1. Works but gets overwritten/lost before being used in `normalized_point`

The result: `normalized_point["units"]` still contained the original "Wh" value from the mapping file.

**The Fix**:

Use a local variable instead of modifying the dataclass object:

**normalizer.py** (lines 243-270):

```python
# v1.1.10 CODE (FIXED):
# Determine the unit to use (convert Wh to kWh for energy sensors)
unit_to_use = mapping.units  # Default to mapping unit

if mapping.device_class == "energy" and point_value is not None:
    if isinstance(point_value, (int, float)) and point_value != 0:
        original_value = point_value
        point_value = point_value / 1000  # Wh ‚Üí kWh ‚úì
        unit_to_use = "kWh"  # ‚Üê Use local variable, not mapping attribute
        _LOGGER.debug(
            "Converted energy sensor %s from Wh to kWh: %s Wh ‚Üí %s kWh",
            point_name,
            original_value,
            point_value,
        )

# Create normalized point entry
normalized_point = {
    "value": point_value,
    "label": mapping.label,
    "description": mapping.description,
    "ha_display_name": mapping.ha_display_name,
    "units": unit_to_use,  # ‚Üê Use local variable, always correct!
    "device_class": mapping.device_class,
    "state_class": mapping.state_class,
    ...
}
```text

**Why This Works**:

1. `unit_to_use` is a local variable (not modifying dataclass)
1. Defaults to `mapping.units` for non-energy sensors
1. Gets set to `"kWh"` for all energy sensors after conversion
1. `normalized_point["units"] = unit_to_use` always uses the correct value
1. No reliance on dataclass attribute modification

**Result**: Energy sensors now correctly display in kWh:

- Energia - Anno Scorso: `7.262 kWh` ‚úì
- Energia - Oggi: `8.606 kWh` ‚úì
- Energia - Ultimi 7 Giorni: `19.896 kWh` ‚úì
- Energia - Ultimi 30 Giorni: `266.266 kWh` ‚úì

______________________________________________________________________

## Technical Details

### Files Modified

**Runtime Code**:

1. `custom_components/.../normalizer.py` (1 change)
   - Lines 243-270: Use local variable `unit_to_use` instead of modifying `mapping.units`
   - Added v1.1.10 fix comment

**Version Files**: 2. `custom_components/.../const.py` (version 1.1.10) 3. `custom_components/.../manifest.json` (version 1.1.10)

### Root Cause Summary

**The Issue**: Modifying dataclass attributes doesn't work reliably in this context.

**The Solution**: Use local variables for runtime value transformations instead of modifying source objects.

**Lesson Learned**: When converting values at runtime, use local variables to track the converted state rather than trying to modify the source data structure. This is especially
important with dataclasses which may be frozen or immutable.

______________________________________________________________________

## Breaking Changes

**None** - This is a bug fix release that completes the energy sensor unit fix correctly.

______________________________________________________________________

## Migration Notes

**For Users**:

- **Action Required**: Upgrade immediately if on v1.1.9
- No integration deletion needed (this fix works on existing installations)
- No configuration changes needed
- Energy sensors will display correctly after upgrade and HA reload

**For Developers**:

- Energy sensor unit conversion now uses local variable pattern
- This pattern should be used for all runtime value transformations
- Avoid modifying dataclass attributes during normalization

______________________________________________________________________

## Testing

**Verified Fixes**:

- ‚úÖ DayWH, WeekWH, MonthWH, YearWH display in kWh (tested by user)
- ‚úÖ Fresh installation shows kWh (not Wh)
- ‚úÖ No entity registry cache issues
- ‚úÖ All 258 sensors working correctly

**Energy Sensor Verification** (from user test):

```text
Before v1.1.10:
  Energia - Oggi: 8.606 Wh ‚úó

After v1.1.10:
  Energia - Oggi: 8.606 kWh ‚úì
```text

**Data Flow Verification**:

```text
1. VSN API returns:        8606 (Wh value)
2. Normalizer converts:    8606 / 1000 = 8.606 kWh
3. unit_to_use set to:     "kWh"
4. normalized_point:       {"value": 8.606, "units": "kWh"}
5. sensor.py receives:     8.606 kWh
6. HA displays:            "8.606 kWh" ‚úì
```text

______________________________________________________________________

## Upgrade Priority

**üö® CRITICAL - Upgrade Immediately**

v1.1.9 users are experiencing:

- 4 energy sensors displaying wrong units (Wh instead of kWh)
- Confusing energy data presentation

**Impact**: Energy sensors show Wh instead of kWh, making values appear 1000x larger than they actually are when interpreted as kWh.

______________________________________________________________________

## Commits

- f861331: fix(critical): v1.1.10 - use local variable for energy sensor units

______________________________________________________________________

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for the complete changelog.
