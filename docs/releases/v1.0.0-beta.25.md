# Release v1.0.0-beta.25

**Release Date**: 2025-11-12

**Type**: Critical Bug Fix Release

**Focus**: Fix entity ID generation (correctly this time!)

---

## Overview

This release **properly** fixes the entity ID generation issue by implementing the correct approach: using `has_entity_name=True` with technical device names. Beta.24's fix was incorrect - it set `has_entity_name=False`, but Home Assistant completely ignores `suggested_object_id` in that mode.

---

## Critical Bug Fix

### üêõ Entity ID Generation - The REAL Fix

**What We Learned After Beta.24**:

- `suggested_object_id` ONLY works when `has_entity_name=True`
- When `has_entity_name=False`, Home Assistant ignores `suggested_object_id` entirely
- Beta.24's approach was fundamentally broken

**The Correct Solution (Beta.25)**:

1. Set `has_entity_name=True` (required for `suggested_object_id` to work)
2. Use technical device names: `abb_fimer_pvi_vsn_rest_datalogger_1110333n161421`
3. Set `suggested_object_id=point_name` (just the measurement name)
4. Home Assistant combines them into predictable entity IDs

**Result**:
```
Entity ID: sensor.abb_fimer_pvi_vsn_rest_datalogger_1110333n161421_wlan0_essid ‚úÖ
Entity Name (on device page): "WiFi SSID" ‚úÖ
Device Name: "abb_fimer_pvi_vsn_rest_datalogger_1110333n161421" (technical but acceptable)
Friendly Name: "abb_fimer_pvi_vsn_rest_datalogger_1110333n161421 WiFi SSID"
```

---

## Technical Details

### Changes Made

**1. sensor.py line 210: Set has_entity_name to True**
```python
# FROM (beta.24 - WRONG):
self._attr_has_entity_name = False

# TO (beta.25 - CORRECT):
self._attr_has_entity_name = True
```

**2. sensor.py line 244: Simplify suggested_object_id**
```python
# FROM (beta.24):
self._attr_suggested_object_id = (
    f"{DOMAIN}_{device_type_simple}_{device_sn_compact}_{point_name}"
)

# TO (beta.25):
self._attr_suggested_object_id = point_name
```

**3. sensor.py line 549: Use technical device names**
```python
# FROM (beta.24 - friendly names):
device_name = _format_device_name(
    manufacturer=manufacturer,
    device_type_simple=self._device_type_simple,
    device_model=device_model,
    device_sn_original=self._device_id,
)
# Result: "ABB Datalogger VSN300 (111033-3N16-1421)"

# TO (beta.25 - technical names):
device_name = f"{DOMAIN}_{self._device_type_simple}_{self._device_sn_compact}"
# Result: "abb_fimer_pvi_vsn_rest_datalogger_1110333n161421"
```

### How It Works Now

**Home Assistant's Entity ID Generation with has_entity_name=True**:
```python
entity_id = slugify(device_name + " " + suggested_object_id)
```

**Example**:

- device_name: "abb_fimer_pvi_vsn_rest_datalogger_1110333n161421"
- suggested_object_id: "wlan0_essid"
- Result: `sensor.abb_fimer_pvi_vsn_rest_datalogger_1110333n161421_wlan0_essid` ‚úÖ

**Entity Names on Device Page**:

- Displayed as: "WiFi SSID" ‚úÖ (clean and friendly)

**Full Friendly Names**:

- Displayed as: "abb_fimer_pvi_vsn_rest_datalogger_1110333n161421 WiFi SSID"
- (Technical prefix but includes entity name)

**Device Names**:

- Device list shows: "abb_fimer_pvi_vsn_rest_datalogger_1110333n161421"
- (Technical but includes serial for identification)

---

## Migration Guide

### ‚ö†Ô∏è BREAKING CHANGE - Manual Migration Required

**All entity IDs will change again.** This is the final fix (based on proper understanding of HA's entity naming system).

**Migration Steps**:

1. **Delete the integration**:
   - Settings ‚Üí Devices & Services
   - Find "ABB/FIMER PVI VSN REST"
   - Click the three dots ‚Üí Delete

2. **Restart Home Assistant** (recommended):
   ```bash
   # Ensures all entity registry changes are persisted
   ```

3. **Re-add the integration**:
   - Settings ‚Üí Devices & Services ‚Üí Add Integration
   - Search for "ABB/FIMER PVI VSN REST"
   - Configure with your VSN datalogger details

4. **Update dashboards and automations** with new entity IDs

### Entity ID Changes

**Beta.24 (broken)**:
```
sensor.abb_fimer_datalogger_vsn300_111033_3n16_1421_wifi_ssid
```

**Beta.25 (correct)**:
```
sensor.abb_fimer_pvi_vsn_rest_datalogger_1110333n161421_wlan0_essid
```

**Differences**:

- ‚úÖ Domain prefix added: `abb_fimer_pvi_vsn_rest_`
- ‚úÖ Serial compacted: `111033_3n16_1421` ‚Üí `1110333n161421`
- ‚úÖ Point name from mapping: `wifi_ssid` ‚Üí `wlan0_essid`
- ‚úÖ No device model in entity ID

---

## What Changed from Beta.24

**Beta.24 Approach (WRONG)**:

- `has_entity_name = False`
- `suggested_object_id` set but ignored by HA
- Entity IDs generated from device_name + entity_name
- Result: Unpredictable entity IDs

**Beta.25 Approach (CORRECT)**:

- `has_entity_name = True` ‚úÖ
- `suggested_object_id = point_name` ‚úÖ
- Technical device names ‚úÖ
- Result: Predictable entity IDs

---

## Trade-offs

**What You Get**:

- ‚úÖ Perfect entity IDs matching your requirements
- ‚úÖ Clean entity names on device pages ("WiFi SSID", "AC Power")
- ‚úÖ Predictable and consistent naming
- ‚úÖ Namespace isolation with domain prefix

**What You Accept**:

- ‚ö†Ô∏è Device names are technical in device list
- ‚ö†Ô∏è Full friendly names include technical device prefix
- (But this is a reasonable trade-off for predictable entity IDs)

---

## Why Beta.24 Was Wrong

After deeper investigation of Home Assistant core code, we discovered:

```python
# From entity_platform.py in HA core:
def async_calculate_suggested_object_id(entity, device):
    if device and entity.has_entity_name:  # <-- CRITICAL CHECK
        # Only here is suggested_object_id actually used!
        calculated_object_id = f"{device_name} {entity.suggested_object_id}"
    else:
        # When False, suggested_object_id is completely ignored
        calculated_object_id = entity.name  # Uses name instead!
```

**Lesson Learned**: Always verify assumptions against actual HA source code behavior.

---

## Compatibility

- **Home Assistant**: 2024.1.0 or later
- **Python**: 3.11 or later
- **VSN Dataloggers**: VSN300, VSN700
- **Inverters**: ABB, FIMER, Power-One PVI series

---

## Known Issues

None - This release implements the correct entity naming pattern as designed by Home Assistant.

---

## Will Future Updates Change Entity IDs Again?

**NO.** Entity IDs are now stable because:

1. We're using the correct HA pattern (`has_entity_name=True` + `suggested_object_id`)
2. `unique_id` remains stable (most important for entity identity)
3. Beta phase is for fixing exactly these kinds of issues
4. After beta ‚Üí v1.0.0, entity IDs will be frozen

**For Users Upgrading from Beta.24 to Beta.25**:

- Entity IDs will NOT automatically update (HA preserves existing IDs)
- You must remove and reinstall to get new entity IDs
- This is expected HA behavior and is actually protective of your configurations

**For New Installations**:

- Will get correct entity IDs from the start
- No migration needed

---

## Apology and Explanation

We sincerely apologize for the back-and-forth with entity ID formats. The progression was:

1. **Beta.13-23**: Wrong (`has_entity_name=True` without technical device names)
2. **Beta.24**: Still wrong (`has_entity_name=False` with `suggested_object_id` being ignored)
3. **Beta.25**: Correct (`has_entity_name=True` with technical device names) ‚úÖ

The mistakes were due to misunderstanding how Home Assistant's entity naming system works. We've now verified the implementation against HA core source code and extensive testing.

**This is the final entity ID format.** Beta phase exists precisely to fix these issues before v1.0.0 release.

---

## What's Next

### Planned for v1.0.0-beta.26+

- Focus on stability and bug fixes
- No more entity ID format changes
- Prepare for v1.0.0 stable release

---

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for complete version history.

---

## Contributors

- **Development**: Claude Code (AI Assistant)
- **Project Maintainer**: @alexdelprete
- **Testing & Validation**: @alexdelprete

---

ü§ñ This release was generated with [Claude Code](https://claude.com/claude-code)
