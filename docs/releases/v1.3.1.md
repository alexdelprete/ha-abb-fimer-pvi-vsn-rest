# Release Notes - v1.3.1

[![GitHub Downloads](https://img.shields.io/github/downloads/alexdelprete/ha-abb-fimer-pvi-vsn-rest/v1.3.1/total?style=for-the-badge)](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/releases/tag/v1.3.1)

**Release Date**: 2026-01-04

**Focus**: Bug Fixes and Test Infrastructure Improvements

______________________________________________________________________

## Overview

This release fixes an important bug in the configuration flow and significantly improves the test infrastructure for better CI/CD reliability.

______________________________________________________________________

## Bug Fixes

### Config Flow: "Already Configured" Detection Fixed

Fixed a bug where the "already_configured" abort was not working correctly when trying to add a device that was already configured.

**Problem**: When attempting to add a device that was already configured, users would see a generic "Unknown error" instead of the expected "already_configured" abort message.

**Root Cause**: The `AbortFlow` exception raised by `_abort_if_unique_id_configured()` was being caught
by the broad `except Exception` handler in the config flow, which converted it to an "unknown" error.

**Fix**: Added explicit `except AbortFlow: raise` handlers before the broad exception handlers in both `async_step_user` and `async_step_reconfigure` methods.

### Startup Notifications Disabled by Default

Startup failure notifications are now disabled by default to reduce notification noise for users who don't need them. Users can enable them in the integration options if desired.

### Options Dialog UI Improvements

Compacted the options dialog layout to eliminate unnecessary scrollbars on smaller screens.

______________________________________________________________________

## New Features

### Configurable Failure Notifications

Added the ability to configure failure notifications and recovery scripts:

- **Enable/Disable Repair Notifications**: Control whether repair notifications are shown when the device becomes unavailable
- **Enable/Disable Startup Notifications**: Control whether notifications are shown on startup failures (disabled by default)
- **Configurable Failures Threshold**: Set the number of consecutive failures before a repair notification is created
- **Recovery Script**: Optionally configure a script to run when the device recovers

______________________________________________________________________

## Test Infrastructure Improvements

This release includes significant improvements to the test infrastructure:

- **Full HA Integration Tests**: Tests now run with the full Home Assistant integration test framework
- **97% Code Coverage**: Comprehensive test coverage for all integration components
- **CI/CD Reliability**: Fixed test infrastructure to work correctly in CI environment

______________________________________________________________________

## Technical Details

### Files Modified

| File | Changes |
|------|---------|
| `config_flow.py` | Added `AbortFlow` exception handling to prevent incorrect error messages |
| `const.py` | Added new configuration constants for notifications |
| `coordinator.py` | Added failure tracking and recovery script execution |
| `__init__.py` | Updated to support new configuration options |
| `tests/*` | Comprehensive test suite improvements |

### New Configuration Options

```python
CONF_ENABLE_REPAIR_NOTIFICATION = "enable_repair_notification"
CONF_ENABLE_STARTUP_NOTIFICATION = "enable_startup_notification"
CONF_FAILURES_THRESHOLD = "failures_threshold"
CONF_RECOVERY_SCRIPT = "recovery_script"
```

______________________________________________________________________

## Upgrade Notes

This is a non-breaking patch release. Simply update to the latest version.

**For existing users**: Your current configuration will continue to work. The new notification options
will use their default values (repair notifications enabled, startup notifications disabled).

______________________________________________________________________

## Full Changelog

### Bug Fixes

- fix(config_flow): re-raise AbortFlow exceptions in config flow
- fix(notifications): disable startup notifications by default

### Features

- feat(notifications): add startup failure notifications option
- feat: add configurable repair notifications and recovery script

### UI/UX Improvements

- style(ui): compact options dialog to eliminate scrollbar
- style(translations): compact options dialog text for better UX

### Test Infrastructure

- fix(tests): enable full HA integration tests in CI
- fix(tests): use MockConfigEntry for integration tests
- fix(tests): correct test assertions for config flow tests
- test: comprehensive test suite for 97%+ coverage

### Documentation

- docs: add connection failure notifications to README
