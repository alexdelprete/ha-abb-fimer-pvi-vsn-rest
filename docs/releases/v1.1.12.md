# Release Notes - v1.1.12

**Release Date**: 2025-01-17

**Type**: Bug Fix Release

**Focus**: Resolve duplicate sensors by prioritizing VSN300 (SunSpec) naming

______________________________________________________________________

## Overview

This release fixes duplicate sensor entries by implementing VSN name normalization that prioritizes VSN300 (SunSpec-based) names as canonical when merging sensors that exist in
both VSN300 and VSN700 models.

**Key Improvements**:

- Merged 5 duplicate sensor pairs (265 points → 253 unique points)
- Fixed insulation resistance icon display (mdi:omega now shows correctly)
- Resolved CRITICAL unit mismatches in leakage current sensors (A vs mA - 1000x difference)
- Standardized units across VSN300/VSN700 with runtime value conversion
- Consistent metadata using SunSpec standard naming

______________________________________________________________________

## Bugs Fixed

### Bug #1: Duplicate Sensor Entries with Inconsistent Metadata

**Problem**: Same sensors existed twice with different names, units, and metadata:

- Insulation Resistance: `Isolation_Ohm1` (VSN300, MΩ, no icon) vs `Riso` (VSN700, MOhm, omega icon)
- Leakage Current Inverter: `ILeakDcAc` (VSN300, mA) vs `IleakInv` (VSN700, A) - **CRITICAL 1000x unit mismatch**
- Leakage Current DC: `ILeakDcDc` (VSN300, mA) vs `IleakDC` (VSN700, A) - **CRITICAL 1000x unit mismatch**
- Ground Voltage: `VGnd` (VSN300) vs `Vgnd` (VSN700)
- Battery SoC: `Soc` (VSN300) vs `TSoc` (VSN700)

**Root Cause**: Generator script created separate entries for VSN300 and VSN700 variants of the same sensor without normalization.

**Fix**: Implemented VSN name normalization in generator script:

```python
# scripts/vsn-mapping-generator/generate_mapping.py
VSN_NAME_NORMALIZATION = {
    # VSN700 proprietary → VSN300 SunSpec (canonical)
    "Riso": "Isolation_Ohm1",
    "IleakInv": "ILeakDcAc",
    "IleakDC": "ILeakDcDc",
    "Vgnd": "VGnd",
    "TSoc": "Soc",
}
```text

**Result**:

- ✅ Reduced from 265 to 253 unique sensor entries (5 duplicates merged)
- ✅ Each merged sensor has both VSN300 and VSN700 REST names
- ✅ VSN300 (SunSpec) name is canonical for entity naming
- ✅ Consistent metadata across both VSN models

______________________________________________________________________

### Bug #2: Insulation Resistance Icon Not Displaying (Fixed in v1.1.11, Regression in Mapping)

**Problem**: Insulation resistance entity showing generic icon instead of mdi:omega in entity registry.

**Root Cause**: After v1.1.11 attribute validation fix, mapping file still had separate entries with inconsistent metadata - VSN300 entry had no icon, VSN700 entry had omega icon.

**Fix**: Merged `Riso` (VSN700) into `Isolation_Ohm1` (VSN300) with omega icon preserved.

**Result**:

- ✅ Single `isolation_ohm1` sensor with both REST names
- ✅ Unit: MOhm (text format, no device_class per v1.1.11)
- ✅ Icon: mdi:omega displays correctly

______________________________________________________________________

### Bug #3: Leakage Current Unit Mismatch (CRITICAL)

**Problem**: Leakage current sensors had different units in VSN300 vs VSN700:

- VSN300: Reports in **mA** (milliamps)
- VSN700: Reports in **A** (amps) - **1000x larger values!**

This caused incorrect sensor values for VSN700 users.

**Root Cause**: VSN300 and VSN700 use different units for the same physical measurement.

**Fix**: Implemented runtime value conversion in normalizer:

```python
# custom_components/.../normalizer.py
A_TO_MA_POINTS = {
    "IleakInv",  # VSN700 - Inverter leakage current (A → mA)
    "IleakDC",   # VSN700 - DC leakage current (A → mA)
}

if vsn_model == "VSN700" and point_name in A_TO_MA_POINTS:
    point_value = point_value * 1000  # A to mA
```text

**Result**:

- ✅ Both `ileakdcac` and `ileakdcdc` sensors standardized to **mA**
- ✅ VSN700 values automatically converted from A to mA at runtime
- ✅ Consistent units across both VSN models

______________________________________________________________________

## Technical Details

### Files Modified

**Generator Script**:

1. `scripts/vsn-mapping-generator/generate_mapping.py` (4 changes):
   - Lines 363-397: Added VSN_NAME_NORMALIZATION dictionary (VSN700→VSN300 mapping)
   - Lines 1607-1613: Moved insulation resistance metadata from "Riso" to "Isolation_Ohm1" key
   - Lines 1636-1647: Changed leakage current units to mA (from A)
   - Lines 2961-2974: Added normalize_vsn700_name() helper function
   - Lines 3542-3543, 3662, 3751-3752: Applied normalization in VSN700/VSN300/M64061 processing

**Runtime Code**:

2. `custom_components/.../normalizer.py` (1 change):

   - Lines 28-33: Added A_TO_MA_POINTS registry
   - Lines 187-202: Added A→mA conversion logic for VSN700 leakage current

1. `custom_components/.../sensor.py` (1 change):

   - Lines 83-87: Added MΩ (Unicode variant) to DEVICE_CLASS_EXCEPTIONS

**Mapping Files** (all 3 copies regenerated):

4. `custom_components/.../data/vsn-sunspec-point-mapping.json`
1. `docs/vsn-sunspec-point-mapping.json`
1. `docs/vsn-sunspec-point-mapping.xlsx`
1. `scripts/vsn-mapping-generator/output/vsn-sunspec-point-mapping.json`
1. `scripts/vsn-mapping-generator/output/vsn-sunspec-point-mapping.xlsx`

**Version Files**:

9. `custom_components/.../const.py` (version 1.1.12)
1. `custom_components/.../manifest.json` (version 1.1.12)

**Documentation**:

11. `CLAUDE.md` (added VSN Name Normalization section)

### Architecture

**VSN300 Names Are Canonical**:

- VSN300 REST API names follow the SunSpec international standard
- VSN700 REST API names are ABB/FIMER proprietary
- During deduplication, VSN700 names normalize TO VSN300 names
- Merged entries use VSN300 name as SunSpec normalized name
- Both REST names preserved in mapping for runtime lookup

**Normalization Flow**:

1. Generator script applies VSN_NAME_NORMALIZATION to VSN700 point names
1. VSN700 "Riso" becomes "Isolation_Ohm1" for deduplication key
1. Deduplication merges rows with same SunSpec normalized name
1. Merged entry has both VSN300 and VSN700 REST names
1. Runtime uses appropriate REST name based on VSN model detected

**Value Conversion**:

- Applied at runtime in normalizer, not in mapping
- Only affects VSN700 leakage current sensors (A→mA)
- Logged at DEBUG level for visibility
- Mapping file remains source of truth for units

______________________________________________________________________

## Merged Sensor Entries

All 5 duplicate pairs successfully merged:

1. **Isolation_Ohm1**:

   - VSN300 REST: `m64061_1_Isolation_Ohm1`
   - VSN700 REST: `Riso`
   - Unit: `MOhm`
   - Icon: `mdi:omega`
   - Entity: `sensor.{device}_isolation_ohm1`

1. **ILeakDcAc** (Inverter Leakage Current):

   - VSN300 REST: `m64061_1_ILeakDcAc`
   - VSN700 REST: `IleakInv`
   - Unit: `mA` (A→mA conversion for VSN700)
   - Entity: `sensor.{device}_ileakdcac`

1. **ILeakDcDc** (DC Leakage Current):

   - VSN300 REST: `m64061_1_ILeakDcDc`
   - VSN700 REST: `IleakDC`
   - Unit: `mA` (A→mA conversion for VSN700)
   - Entity: `sensor.{device}_ileakdcdc`

1. **VGnd** (Ground Voltage):

   - VSN300 REST: `m64061_1_VGnd`
   - VSN700 REST: `Vgnd`
   - Unit: `V`
   - Entity: `sensor.{device}_vgnd`

1. **Soc** (Battery State of Charge):

   - VSN700 REST: `Soc` (canonical, VSN300 doesn't have this point)
   - Unit: `%`
   - Entity: `sensor.{device}_soc`

______________________________________________________________________

## Breaking Changes

**None** - This is a bug fix release.

Existing entities will continue to work. However, if you had duplicate sensors from VSN300 and VSN700 entries, you may notice:

- Duplicate entities will be removed on next restart
- Remaining entity will have consolidated metadata
- Leakage current values may change for VSN700 users (corrected from A to mA)

______________________________________________________________________

## Migration Notes

**For Users**:

- No action required - duplicate resolution happens automatically
- VSN700 users: Leakage current sensor values will change (divided by 1000, corrected to mA)
- Insulation resistance icon will display correctly (mdi:omega)
- Check for any automations using old duplicate entities (unlikely)

**For Developers**:

- VSN name normalization is applied at generator time, not runtime
- VSN300 (SunSpec) names are canonical for all merged sensors
- Runtime value conversion only affects VSN700 leakage current (A→mA)
- All sensor attribute changes MUST go through generator script (MANDATORY workflow)

______________________________________________________________________

## Upgrade Priority

**RECOMMENDED - Upgrade When Convenient**

Benefits:

- Fixes duplicate sensors (cleaner entity list)
- Correct leakage current values for VSN700 users (CRITICAL unit fix)
- Insulation resistance icon displays correctly
- Consistent metadata across VSN300/VSN700

Impact: Low - automatic deduplication, defensive fixes applied

______________________________________________________________________

## Commits

- TBD: feat(generator): add VSN name normalization for duplicate detection
- TBD: feat(normalizer): add A→mA conversion for VSN700 leakage current
- TBD: fix(sensor): add MΩ Unicode variant to device_class exceptions
- TBD: docs(CLAUDE.md): document VSN name normalization architecture
- TBD: chore(release): bump version to v1.1.12

______________________________________________________________________

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for the complete changelog.
