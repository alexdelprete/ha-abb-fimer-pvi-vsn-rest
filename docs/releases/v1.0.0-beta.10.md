# v1.0.0-beta.10 - Entity ID Template Redesign (BREAKING CHANGE)

**Release Date:** 2025-01-29

## ⚠️ BREAKING CHANGES

**ALL entity IDs have changed.** This release completely redesigns the entity ID format to include full device context, preventing ID collisions in multi-device systems and providing clear device identification.

### What Changed

**Old Format:**
```
sensor.{serial}_{point}
sensor.manufacturer
sensor.device_address
sensor.0779093g823112_watts
```

**New Format:**
```
sensor.abb_vsn_rest_{device_type}_{serial}_{model}_{point}
sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_product_number
sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_device_address
sensor.abb_vsn_rest_inverter_0779093g823112_m103_watts
```

### Migration Required

**Impact:**
- ✅ All entities will be recreated with new IDs
- ✅ Entity history will NOT be preserved (fresh start)
- ⚠️ Dashboards need updating with new entity IDs
- ⚠️ Automations need updating with new entity IDs
- ⚠️ Scripts need updating with new entity IDs
- ✅ Entity friendly names (display names) remain unchanged

**Migration Steps:**
1. Update integration to v1.0.0-beta.10
2. Restart Home Assistant
3. Note down old entity IDs from your dashboards/automations
4. Find corresponding new entity IDs in Developer Tools → States
5. Update all references in dashboards, automations, scripts
6. Old entities will be marked as "unavailable" - you can safely delete them

---

## Overview

This release implements a comprehensive entity ID template redesign to support multi-device systems and provide clear device identification. The new format includes device type, serial number, and model information directly in the entity ID.

---

## New Entity ID Template

### Format

```
abb_vsn_rest_(device_type)_(device_sn_compacted)_(model)_(pointname)
```

### Components

1. **Prefix:** Always `abb_vsn_rest`
2. **Device Type:** `inverter`, `datalogger`, `meter`, `battery` (simple, lowercase)
3. **Device S/N:** Compacted (remove `-`, `:`, `_`), lowercase
4. **Model:**
   - SunSpec points: `m1`, `m103`, `m160`, `m64061`, `m203`, `m802`, etc.
   - VSN-only points: `vsn300`, `vsn700`
5. **Point Name:** Simplified, lowercase (e.g., `watts`, `dc_current_1`, `uptime`)

---

## Examples

### Inverter Sensors (PVI-10.0-OUTD, S/N: 077909-3G82-3112)

**SunSpec Common Model (M1) - Diagnostic:**
- `sensor.abb_vsn_rest_inverter_0779093g823112_m1_manufacturer`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m1_model`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m1_serial_number`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m1_version`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m1_device_address`

**SunSpec Inverter Model (M103):**
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_watts`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_amps`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_phase_voltage_an`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_hz`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_pf`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_cabinet_temperature`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_daily_energy`

**SunSpec MPPT Model (M160):**
- `sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_current_1`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_voltage_1`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_power_1`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_current_2`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m160_dc_voltage_2`

**ABB Proprietary Model (M64061) - Diagnostic:**
- `sensor.abb_vsn_rest_inverter_0779093g823112_m64061_alarm_state`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m64061_ground_resistance`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m64061_isolation_resistance`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m64061_leakage_current_dc_ac`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m64061_daily_energy`

### VSN300 Datalogger Sensors (S/N: 111033-3N16-1421)

**System Monitoring - Diagnostic:**
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_uptime`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_firmware_version`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_flash_free`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_ram_free`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_system_load`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_flash_used`

**Device Info - Diagnostic:**
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_product_number`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_serial_number`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_device_type`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_wifi_network_name`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_wifi_local_ip_address`

### VSN700 Datalogger Sensors (MAC: AC:1F:0F:B0:50:B5)

**System Monitoring - Diagnostic:**
- `sensor.abb_vsn_rest_datalogger_ac1f0fb050b5_vsn700_uptime`
- `sensor.abb_vsn_rest_datalogger_ac1f0fb050b5_vsn700_firmware_version`
- `sensor.abb_vsn_rest_datalogger_ac1f0fb050b5_vsn700_flash_free`

### Multi-Device System Example

**System with 2 inverters + 1 VSN300:**

**Inverter 1 (077909-3G82-3112):**
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_watts`
- `sensor.abb_vsn_rest_inverter_0779093g823112_m103_daily_energy`

**Inverter 2 (088812-4H93-4223):**
- `sensor.abb_vsn_rest_inverter_0888124h934223_m103_watts`
- `sensor.abb_vsn_rest_inverter_0888124h934223_m103_daily_energy`

**VSN300 Datalogger (111033-3N16-1421):**
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_uptime`
- `sensor.abb_vsn_rest_datalogger_1110333n161421_vsn300_firmware_version`

✅ No entity ID collisions! Each device has unique, identifiable entity IDs.

### Meter Sensors (M203, S/N: 099923-5J04-5334)

- `sensor.abb_vsn_rest_meter_0999235j045334_m203_watts`
- `sensor.abb_vsn_rest_meter_0999235j045334_m203_amps`
- `sensor.abb_vsn_rest_meter_0999235j045334_m203_daily_energy`

### Battery Sensors (M802, S/N: 116839-3P72-3921)

- `sensor.abb_vsn_rest_battery_1168393p723921_m802_soc`
- `sensor.abb_vsn_rest_battery_1168393p723921_m802_watts`
- `sensor.abb_vsn_rest_battery_1168393p723921_m802_watthours`

---

## Technical Implementation

### Phase 1: Mapping File Generation

**Updated:** `scripts/generate_mapping_excel.py`

Created `generate_simplified_point_name()` function to generate only the point name component (without device context):
- Input: Label from SunSpec (e.g., "Watts", "DC Current #1")
- Output: Simplified point name (e.g., "watts", "dc_current_1")

**Mapping "HA Name" Changes:**
- Before: `abb_m103_w`, `abb_m160_dca_1`, `abb_vsn_uptime`
- After: `watts`, `dc_current_1`, `uptime`

**New Tool:** `scripts/convert_excel_to_json.py`
- Automated Excel → JSON conversion
- Copies JSON to integration data folder
- Ensures consistency between docs and integration

### Phase 2: Dynamic Entity ID Generation

**Updated:** `custom_components/abb_fimer_pvi_vsn_rest/sensor.py`

**Added 4 Helper Functions:**

1. **`_compact_serial_number(serial: str) -> str`**
   - Removes separators (`-`, `:`, `_`)
   - Converts to lowercase
   - Example: `"077909-3G82-3112"` → `"0779093g823112"`

2. **`_simplify_device_type(device_type: str) -> str`**
   - Simplifies device types to basic categories
   - `"inverter_3phases"` → `"inverter"`
   - `"inverter_1phase"` → `"inverter"`
   - `"meter"` → `"meter"`
   - `"battery"` → `"battery"`

3. **`_determine_model_for_entity_id(point_model, vsn_model, is_datalogger) -> str`**
   - SunSpec models: `"M103"` → `"m103"`, `"M160"` → `"m160"`
   - Datalogger/VSN-only points: Use VSN model → `"vsn300"` or `"vsn700"`
   - ABB Proprietary: `"vsn700"` (they're VSN700-only)

4. **`_build_entity_id(...) -> str`**
   - Assembles full entity ID from components
   - Template: `abb_vsn_rest_{device_type}_{sn}_{model}_{point}`

**Updated `VSNSensor.__init__()`:**
- Detects if sensor belongs to datalogger device
- Compacts device serial number
- Determines appropriate model for entity ID
- Builds full entity ID dynamically
- Sets `unique_id` to match entity_id
- Adds debug logging for troubleshooting

**Key Code:**
```python
# Determine datalogger
is_datalogger = False
for discovered_device in coordinator.discovered_devices:
    if discovered_device.device_id == device_id and discovered_device.is_datalogger:
        is_datalogger = True
        break

# Simplify device type
device_type_simple = "datalogger" if is_datalogger else _simplify_device_type(device_type)

# Compact serial number
device_sn_compact = _compact_serial_number(device_id)

# Determine model
model_for_id = _determine_model_for_entity_id(point_model, coordinator.vsn_model, is_datalogger)

# Build entity ID
entity_id = _build_entity_id(device_type_simple, device_sn_compact, model_for_id, point_name)
self._attr_unique_id = entity_id
```

---

## Benefits

### 1. Prevents Entity ID Collisions
**Before:** Multiple devices could create conflicting entity IDs
- Inverter 1: `sensor.manufacturer` ❌ Conflict!
- Inverter 2: `sensor.manufacturer` ❌ Conflict!

**After:** Each device has unique entity IDs
- Inverter 1: `sensor.abb_vsn_rest_inverter_0779093g823112_m1_manufacturer` ✅
- Inverter 2: `sensor.abb_vsn_rest_inverter_0888124h934223_m1_manufacturer` ✅

### 2. Clear Device Identification
Entity IDs now contain complete context:
- **Device Type:** Know if it's inverter, datalogger, meter, battery
- **Serial Number:** Identify specific device
- **Model:** Know which SunSpec model or VSN model
- **Point:** Know what's being measured

### 3. Better Organization
Entities naturally group by device in HA entity lists:
- All `abb_vsn_rest_inverter_0779093g823112_*` entities appear together
- All `abb_vsn_rest_datalogger_1110333n161421_*` entities appear together

### 4. Multi-Device Support
Seamlessly supports systems with:
- Multiple inverters (each with unique serial)
- Multiple meters
- Multiple batteries
- Multiple dataloggers (VSN300 + VSN700 in same system)

### 5. Future-Proof
New devices can be added without worrying about entity ID conflicts.

---

## Files Modified

### Integration Code
1. **sensor.py** (+150 lines)
   - Added 4 helper functions
   - Updated VSNSensor.__init__() with new entity ID logic
   - Added debug logging

2. **const.py**
   - Version: 1.0.0-beta.9 → 1.0.0-beta.10

3. **manifest.json**
   - Version: 1.0.0-beta.9 → 1.0.0-beta.10

### Scripts
4. **generate_mapping_excel.py** (~100 lines modified)
   - Updated generate_simplified_point_name() function
   - Removed all direct HA Name generation with prefixes
   - Updated 3 code paths to use new function

5. **convert_excel_to_json.py** (NEW, +70 lines)
   - Automated Excel → JSON conversion
   - Copies to integration data folder
   - Ensures consistency

### Documentation
6. **CHANGELOG.md**
   - Added v1.0.0-beta.10 section
   - Breaking change warning
   - Updated version links

### Mapping Files
7. **docs/vsn-sunspec-point-mapping.xlsx** (Regenerated)
8. **docs/vsn-sunspec-point-mapping.json** (Regenerated)
9. **custom_components/.../data/vsn-sunspec-point-mapping.json** (Regenerated)

---

## Code Quality

- **Ruff Checks:** All passed ✓
- **Type Hints:** All helper functions properly typed
- **Documentation:** Comprehensive docstrings for all new functions
- **Debug Logging:** Added for entity ID generation process
- **Error Handling:** Graceful fallbacks for edge cases

---

## Testing

**Recommended Test Scenarios:**

1. **Single Inverter + VSN300:**
   - ✅ Verify inverter entities use `m103`, `m160`, `m64061` models
   - ✅ Verify datalogger entities use `vsn300` model
   - ✅ Verify no entity ID conflicts

2. **Multiple Inverters:**
   - ✅ Verify each inverter has unique entity IDs based on serial
   - ✅ Verify all inverters visible and functional

3. **VSN700 System:**
   - ✅ Verify datalogger entities use `vsn700` model
   - ✅ Verify ABB Proprietary points use `vsn700` model

4. **Mixed System (meter + battery + inverters):**
   - ✅ Verify device_type correctly categorizes devices
   - ✅ Verify no entity ID conflicts across device types

**Verification Steps:**
1. Check Developer Tools → States for new entity IDs
2. Verify entity_id format matches template
3. Verify unique_id matches entity_id
4. Verify friendly names unchanged
5. Verify diagnostic entities properly categorized

---

## Troubleshooting

### Entity IDs Too Long

**Issue:** Some entity IDs are quite long (60+ characters)

**Example:** `sensor.abb_vsn_rest_inverter_0779093g823112_m103_phase_voltage_an`

**Solution:** This is expected and acceptable. Home Assistant supports long entity IDs. The length provides clarity and prevents conflicts.

### Old Entities Still Showing

**Issue:** After update, old entities show as "unavailable"

**Solution:** This is expected. Old entities use old unique_ids and won't be reused. Safe to delete them via:
1. Developer Tools → States
2. Find old unavailable entities
3. Click entity → Settings icon → Delete

### Can't Find New Entity IDs

**Issue:** Not sure what the new entity ID is for an old entity

**Solution:**
1. Check friendly name (unchanged) in Developer Tools → States
2. Search by friendly name (e.g., "AC Power")
3. New entity ID will be listed

### Entity History Lost

**Issue:** Historical data not showing for new entities

**Solution:** This is expected (BREAKING CHANGE). Entity IDs changed, so history is not linked. Consider this a fresh start. If historical data is critical, consider:
- Exporting old data before upgrading
- Using HA database tools to migrate history (advanced)

---

## Migration Guide

### Step-by-Step Migration

**1. Before Upgrading:**
- Document your current dashboards (screenshots recommended)
- List all automations using VSN entities
- Export entity history if needed

**2. Upgrade:**
- Update integration to v1.0.0-beta.10 via HACS
- Restart Home Assistant

**3. After Upgrade:**
- Go to Developer Tools → States
- Note new entity IDs for your devices
- Update dashboards with new entity IDs
- Update automations with new entity IDs
- Delete old unavailable entities

**4. Verify:**
- Check all sensors are reporting values
- Test dashboards
- Test automations
- Monitor logs for any issues

### Finding Entity ID Mappings

**Old to New Mapping Pattern:**

| Old Entity ID | New Entity ID |
|---------------|---------------|
| `sensor.manufacturer` | `sensor.abb_vsn_rest_datalogger_{sn}_vsn300_manufacturer` |
| `sensor.device_address` | `sensor.abb_vsn_rest_inverter_{sn}_m1_device_address` |
| `sensor.watts` | `sensor.abb_vsn_rest_inverter_{sn}_m103_watts` |
| `sensor.dc_current_1` | `sensor.abb_vsn_rest_inverter_{sn}_m160_dc_current_1` |
| `sensor.uptime` | `sensor.abb_vsn_rest_datalogger_{sn}_vsn300_uptime` |

Replace `{sn}` with your actual compacted serial number.

---

## Known Issues

**None reported.**

This is a **beta release** - please report any issues on GitHub:
- **Issues:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues
- **Discussions:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions

---

## Commits

**Phase 1: Mapping Generation (e14d8a5)**
- feat: Generate simplified point names in mapping files
- Updated generate_mapping_excel.py
- Created convert_excel_to_json.py
- Regenerated all mapping files

**Phase 2: Dynamic Entity ID Generation (f205559)**
- feat!: Implement dynamic entity ID generation with full device context
- Added helper functions to sensor.py
- Updated VSNSensor.__init__()
- Version bump to 1.0.0-beta.10
- Updated CHANGELOG.md

**Full Changelog:** [v1.0.0-beta.9...v1.0.0-beta.10](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.0.0-beta.9...v1.0.0-beta.10)

---

## Credits

**Contributors:**
- @alexdelprete - Project maintainer
- Claude Code - Development assistance

**Special Thanks:**
- Home Assistant community for feedback
- Early adopters for testing

---

## Links

- **Repository:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest
- **Issues:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues
- **Discussions:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions
- **CHANGELOG:** [CHANGELOG.md](../../CHANGELOG.md)

---

🤖 Generated with [Claude Code](https://claude.com/claude-code)
