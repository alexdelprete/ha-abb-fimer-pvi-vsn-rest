# Release Notes - v1.0.0-beta.4

**Release Date:** October 27, 2025

## Overview

This release fixes three critical issues discovered in v1.0.0-beta.3:

1. **Options Flow Crash** - Configuration/reconfiguration failed with TypeError
1. **State Class for String Sensors** - Integration crashed on sensors with string values
1. **Device Registration Order** - Via_device warning for HA 2025.12

**All users on v1.0.0-beta.3 should upgrade to v1.0.0-beta.4.**

**Note:** v1.0.0-beta.3 contained incorrect version strings in manifest.json and const.py (showed "1.0.0-beta.2"). This is corrected in v1.0.0-beta.4.

______________________________________________________________________

## Critical Fixes

### 1. Options Flow Crash (Critical)

**Problem:** Configuration/reconfiguration completely broken:

```text
TypeError: ABBFimerPVIVSNRestOptionsFlowHandler() takes no arguments
Config flow could not be loaded: 500 Internal Server Error
```text

**Root Cause:**

- Regression from commit 47c8ead (beta.3) which removed `__init__` from OptionsFlowHandler
- `async_get_options_flow()` still tried to pass `config_entry` as argument
- Incomplete fix caused configuration to crash

**Solution:**

- Removed `config_entry` argument from OptionsFlowHandler instantiation
- Changed from: `ABBFimerPVIVSNRestOptionsFlowHandler(config_entry)`
- Changed to: `ABBFimerPVIVSNRestOptionsFlowHandler()`
- Framework provides `config_entry` automatically via property

**Impact:**

- **v1.0.0-beta.3:** Cannot open configuration, 500 error
- **v1.0.0-beta.4:** Configuration works correctly

**Changes:**

- **config_flow.py:** Line 295 - removed argument

**Commit:** [580b63d](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/580b63d)

______________________________________________________________________

### 2. State Class for String Sensors (Critical)

**Problem:** Integration crashed during sensor registration:

```text
ValueError: Sensor sensor.vsn300_111033_3n16_1421_type has device class 'None',
state class 'measurement' unit '' and suggested precision 'None' thus indicating
it has a numeric value; however, it has the non-numeric value: 'WIFI LOGGER CARD'
(<class 'str'>)
```text

**Affected Sensors:**

- `type`: "WIFI LOGGER CARD" (device type)
- `sn`: "111033-3N16-1421" (serial number)
- `pn`: Part numbers
- `wlan_0_essid`: WiFi SSID names
- `wlan_0_ipaddr_local`: IP addresses

**Root Cause:**

- Mapping file had `state_class='measurement'` for string-value sensors
- Home Assistant strictly requires sensors with `state_class` to have numeric values only
- Integration blindly applied `state_class` from mapping without validation
- Non-numeric sensors rejected by HA during registration

**Solution:** Validate value type before setting state_class:

1. **Check initial value:** Get value from point_data during `__init__`
1. **Type validation:** Use `isinstance(value, (int, float))` to check if numeric
1. **Conditional assignment:** Only set `_attr_state_class` if value is numeric
1. **Debug logging:** Log when skipping state_class for non-numeric values

**Impact:**

- **v1.0.0-beta.3:** Crash on sensor registration, 5+ sensors failed
- **v1.0.0-beta.4:** All sensors register successfully

**Changes:**

- **sensor.py:** Lines 132-154 - added numeric value validation
- Only numeric sensors get state_class
- String sensors work correctly without state_class

**Commit:** [6d4588d](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/6d4588d)

______________________________________________________________________

### 3. Device Registration Order Warning

**Problem:** Home Assistant warning about device hierarchy:

```text
Detected that custom integration 'abb_fimer_pvi_vsn_rest' calls
`device_registry.async_get_or_create` referencing a non existing
`via_device` ('abb_fimer_pvi_vsn_rest', '111033-3N16-1421').
This will stop working in Home Assistant 2025.12.0
```text

**Root Cause:**

- All sensors created and added simultaneously via `async_add_entities()`
- When HA processes entities, may try to register inverter device before datalogger
- Inverter `device_info` includes `via_device` pointing to datalogger
- If datalogger not registered yet, HA warns about non-existing via_device

**Solution:** Refactored sensor creation for proper device hierarchy:

1. **First pass:** Identify datalogger device ID from discovered_devices
1. **Second pass:** Separate sensors into two lists:
   - `datalogger_sensors`: sensors belonging to datalogger
   - `other_sensors`: sensors belonging to inverters
1. **Registration:** Call `async_add_entities(datalogger_sensors + other_sensors)`
   - Datalogger sensors processed first → datalogger device registered
   - Then inverter sensors processed → can reference datalogger via via_device

**Impact:**

- **v1.0.0-beta.3:** Warning logged, will break in HA 2025.12
- **v1.0.0-beta.4:** No warnings, proper device hierarchy

**Changes:**

- **sensor.py:** Lines 38-85 - two-pass sensor creation with ordering
- Enhanced logging shows sensor counts by type

**Commit:** [306541a](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/306541a)

______________________________________________________________________

## Installation

### HACS (Recommended)

1. Go to HACS → Integrations
1. Find "ABB/FIMER PVI VSN REST"
1. Click "Update" to v1.0.0-beta.4
1. Restart Home Assistant
1. Integration will reload automatically

### Manual Installation

1. Download `abb_fimer_pvi_vsn_rest.zip` from [GitHub Releases](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/releases/tag/v1.0.0-beta.4)
1. Extract to `custom_components/abb_fimer_pvi_vsn_rest`
1. Restart Home Assistant
1. Integration will reload automatically

______________________________________________________________________

## Migration from v1.0.0-beta.3

**No configuration changes required.** Simply update and restart.

**What to check after upgrade:**

1. Open integration configuration - should work without errors
1. Check all sensors are loading (especially type, sn, pn, wlan sensors)
1. Check HA logs - no via_device warnings
1. Verify correct version displayed: v1.0.0-beta.4

______________________________________________________________________

## Known Issues

**Version String in v1.0.0-beta.3:**

- v1.0.0-beta.3 release contained incorrect version strings
- manifest.json and const.py showed "1.0.0-beta.2" instead of "1.0.0-beta.3"
- Fixed in v1.0.0-beta.4 with correct version
- If you see "1.0.0-beta.2" in your integration, you're actually running beta.3

No other known issues. Please report any issues on [GitHub Issues](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues).

______________________________________________________________________

## Technical Details

### Changes Summary

**Files Modified:**

- `custom_components/abb_fimer_pvi_vsn_rest/config_flow.py`
- `custom_components/abb_fimer_pvi_vsn_rest/sensor.py`
- `custom_components/abb_fimer_pvi_vsn_rest/manifest.json`
- `custom_components/abb_fimer_pvi_vsn_rest/const.py`

**Lines Changed:**

- Added: ~50 lines (validation, ordering, logging)
- Modified: ~8 lines (argument removal, type checks)

### Sensor State Class Logic

The new state_class validation logic:

```python
# Check if initial value is numeric
initial_value = point_data.get("value")
is_numeric = isinstance(initial_value, (int, float))

if is_numeric:
    # Safe to set state_class
    self._attr_state_class = SensorStateClass(state_class_str)
else:
    # Skip state_class for string values
    _LOGGER.debug("Skipping state_class for non-numeric value")
```text

### Device Registration Order

Ensures proper hierarchy:

```python
# Datalogger sensors first
datalogger_sensors = [...]
# Inverter sensors second
other_sensors = [...]

# Register in order
async_add_entities(datalogger_sensors + other_sensors)
```text

______________________________________________________________________

## Comparison: Beta.3 vs Beta.4

| Issue | v1.0.0-beta.3 | v1.0.0-beta.4 | |-------|---------------|---------------| | Options Flow | ❌ Crash (500 error) | ✅ Works correctly | | String Sensors | ❌ Crash
(ValueError) | ✅ Register successfully | | Device Hierarchy | ⚠️ Warning (will break 2025.12) | ✅ No warnings | | Version String | ❌ Shows "beta.2" | ✅ Shows "beta.4" |

______________________________________________________________________

## Feedback & Support

- **Issues:** <https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues>
- **Discussions:** <https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions>

______________________________________________________________________

**Full Changelog:** [v1.0.0-beta.3...v1.0.0-beta.4](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.0.0-beta.3...v1.0.0-beta.4)
