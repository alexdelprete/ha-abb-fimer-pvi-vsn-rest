# Release v1.0.0-beta.29

**Release Date**: 2025-11-13

**Type**: Bug Fix Release

**Focus**: Fix beta.28 regressions - both fixes didn't work as intended

---

## Overview

This release fixes two critical bugs that persisted in beta.28 despite attempted fixes:

1. **device_type attribute** - Still showing "unknown" for datalogger entities (beta.28 fix didn't work)
2. **sys_time sensor** - Showing "32 seconds ago" instead of actual date/time (beta.28 fix caused relative time display)

Both issues required deeper investigation to identify the true root causes. Beta.28's approaches were partially correct but didn't address the underlying problems.

---

## Bug Fixes

### üêõ device_type - Still "unknown" After Beta.28

**Problem**: Despite beta.28's injection fix, datalogger entities still showed `device_type: unknown` in attributes.

**Beta.28 Attempt**:

- Added injection logic in client.py to inject device_type from discovered_devices into livedata before normalization
- Modified client to accept discovered_devices list
- Assumption: discovered_devices had correct device_type

**Why Beta.28 Didn't Work**:

Beta.28 assumed the discovered_devices list contained datalogger entries with `device_type="datalogger"`, but this wasn't true!

**Investigation Results**:

Discovery.py processes devices in two phases:

**Phase 1** (lines 291-322): Create synthetic datalogger from status.json
```python
datalogger_device = DiscoveredDevice(
    device_id=logger_id,
    raw_device_id=logger_sn,
    device_type="datalogger",  # ‚úì Correct here
    ...
)
```

**Phase 2** (lines 325-408): Process devices from livedata.json

- Line 327: Identifies datalogger: `is_datalogger = ":" in raw_device_id`
- Line 355: Gets device_type: `device_type = device_data.get("device_type", "unknown")`
- Lines 359-361: Checks `if is_datalogger:` but **only sets device_model**, not device_type!

```python
if is_datalogger:
    # Datalogger: Use VSN model as device model
    device_model = vsn_model  # "VSN300" or "VSN700"
    # MISSING: device_type = "datalogger"
```

**Result**: Datalogger in livedata gets device_type="unknown" from line 355.

**Beta.28 Injection Logic**: Tried to inject device_type but was injecting "unknown" because that's what the discovered_device had!

**Root Cause**: Discovery.py line 359-361 correctly identifies datalogger entries from livedata but forgets to set `device_type = "datalogger"`.

**Solution**:

Add one line in [discovery.py:362](d:\\OSILifeDrive\\Dev\\HASS\\ha-abb-fimer-pvi-vsn-rest\\custom_components\\abb_fimer_pvi_vsn_rest\\abb_fimer_vsn_rest_client\\discovery.py#L362):

```python
if is_datalogger:
    # Datalogger: Use VSN model as device model
    device_model = vsn_model  # "VSN300" or "VSN700"
    device_type = "datalogger"  # Override "unknown" from livedata
```

**Result**:

- ‚úÖ Datalogger from livedata correctly gets device_type="datalogger"
- ‚úÖ Beta.28's injection logic now injects the correct value
- ‚úÖ Normalized data has correct device_type
- ‚úÖ Sensor attributes show `device_type: "datalogger"`

---

### üïê sys_time - Shows "32 seconds ago" Instead of Date

**Problem**: Beta.28 fix caused sys_time to show relative time ("32 seconds ago") instead of actual date/time string.

**Beta.28 Attempt**:

- Added `device_class: "timestamp"` to mapping file to trigger conversion code
- Conversion code requires `device_class == SensorDeviceClass.TIMESTAMP` to execute
- Assumption: timestamp device_class would show formatted date/time

**Why Beta.28 Didn't Work**:

Home Assistant's timestamp device_class is **DESIGNED** to display relative time ("X ago", "X minutes ago", etc.). This is intentional behavior that cannot be overridden while using the timestamp device_class.

**The Catch-22**:

- Need `device_class: "timestamp"` ‚Üí Conversion runs ‚Üí datetime object created ‚Üí HA forces relative time display
- Remove `device_class: "timestamp"` ‚Üí Conversion doesn't run ‚Üí Raw integer displayed

**Root Cause**: Cannot have both timestamp device_class AND formatted date/time display. It's fundamentally incompatible with HA's design.

**Historical Context**:

Looking at git history:

- **Beta 21**: Removed `device_class: "timestamp"` because it caused relative time display
- **Beta 28**: Added it back to enable conversion (Aurora epoch ‚Üí datetime)
- **Beta 29**: Need different approach entirely

**Solution**:

Stop using timestamp device_class. Instead:

1. **Remove device_class** from mapping file ([vsn-sunspec-point-mapping.json:544](d:\\OSILifeDrive\\Dev\\HASS\\ha-abb-fimer-pvi-vsn-rest\\custom_components\\abb_fimer_pvi_vsn_rest\\data\\vsn-sunspec-point-mapping.json#L544))
   ```json
   "HA Device Class": "",
   ```

2. **Modify conversion logic** to check point_name instead of device_class ([sensor.py:415-433](d:\\OSILifeDrive\\Dev\\HASS\\ha-abb-fimer-pvi-vsn-rest\\custom_components\\abb_fimer_pvi_vsn_rest\\sensor.py#L415-L433)):
   ```python
   # Convert Aurora timestamps for sys_time sensor
   # Return formatted string to show actual date/time instead of relative time ("X ago")
   if self._point_name == "sys_time" and isinstance(value, (int, float)) and value > 0:
       try:
           # Get HA's configured timezone
           tz = ZoneInfo(self.hass.config.time_zone)
           # Add Aurora epoch offset to convert to Unix timestamp, then to datetime
           dt = datetime.fromtimestamp(value + AURORA_EPOCH_OFFSET, tz=tz)
           # Return as formatted string (not datetime object) to avoid relative time display
           return dt.strftime("%Y-%m-%d %H:%M:%S")
       except (ValueError, OSError, KeyError) as err:
           _LOGGER.warning(...)
           return None
   ```

**Result**:

- ‚úÖ Conversion runs based on point_name check (not device_class)
- ‚úÖ Returns formatted string: "2025-11-13 10:15:32"
- ‚úÖ No device_class ‚Üí HA displays as-is (not relative time)
- ‚úÖ User sees actual date/time string

---

## Technical Details

### File Changes Summary

| File | Lines | Change |
|------|-------|--------|
| discovery.py | 362 | Add device_type assignment for datalogger |
| sensor.py | 415-433 | Modify conversion to check point_name instead of device_class |
| sensor.py | 425 | Return formatted string instead of datetime object |
| vsn-sunspec-point-mapping.json | 544 | Remove device_class timestamp |
| manifest.json | 13 | Version bump to 1.0.0-beta.29 |
| const.py | 4 | Version bump to 1.0.0-beta.29 |

### Before & After Examples

#### device_type Attribute

**Before (beta.28)**:
```
Entity: sensor.abb_datalogger_vsn300_111033_3n16_1421_firmware_version
Attributes:
  device_type: unknown
  vsn300_rest_name: N/A
  vsn700_rest_name: N/A
```

**After (beta.29)**:
```
Entity: sensor.abb_datalogger_vsn300_111033_3n16_1421_firmware_version
Attributes:
  device_type: datalogger
  vsn300_rest_name: N/A
  vsn700_rest_name: N/A
```

#### sys_time Sensor

**Before (beta.28)**:
```
Entity ID: sensor.power_one_inverter_pvi_10_0_outd_077909_3g82_3112_sys_time
Value: "32 seconds ago"
Device Class: timestamp
Display: Relative time (by HA design)
```

**After (beta.29)**:
```
Entity ID: sensor.power_one_inverter_pvi_10_0_outd_077909_3g82_3112_sys_time
Value: "2025-11-13 10:15:32"
Device Class: (empty)
Display: Actual date/time string
```

---

## Why Beta.28 Fixes Didn't Work

### Issue 1: device_type

**Beta.28's Logic**: Inject device_type from discovered_devices before normalization
**Assumption**: discovered_devices has correct device_type
**Reality**: discovered_devices from livedata had device_type="unknown"
**Missing**: Discovery.py never set device_type for datalogger entries from livedata

**Beta.29 Fix**: Set device_type in discovery at the source, making beta.28's injection actually work.

### Issue 2: sys_time

**Beta.28's Logic**: Add device_class: "timestamp" to trigger conversion
**Assumption**: Timestamp device_class shows formatted date/time
**Reality**: Timestamp device_class forces relative time display ("X ago")
**Incompatibility**: HA's design doesn't allow both timestamp device_class and formatted display

**Beta.29 Fix**: Remove device_class, check point_name directly, return formatted string.

---

## Migration Guide

### ‚ö†Ô∏è NO BREAKING CHANGES

This release **does not** require any migration:

- ‚úÖ No entity ID changes
- ‚úÖ No configuration changes
- ‚úÖ No entity registry cleanup needed

Simply upgrade to beta.29 and restart Home Assistant. The fixes take effect immediately.

### Upgrade Steps

1. **Download beta.29** via HACS or manual installation
2. **Restart Home Assistant**
3. **Verify the fixes**:
   - Check datalogger entities show `device_type: datalogger` in attributes (not "unknown")
   - Check `sys_time` displays as formatted date/time "2025-11-13 10:15:32" (not "X ago")

---

## Compatibility

- **Home Assistant**: 2024.1.0 or later
- **Python**: 3.11 or later
- **VSN Dataloggers**: VSN300, VSN700
- **Inverters**: ABB, FIMER, Power-One PVI series

---

## Known Issues

None - This release properly fixes the beta.28 regressions.

---

## What's Next

### Planned for v1.0.0-beta.30+

- Continue bug fixes and improvements based on user feedback
- Move towards stable v1.0.0 release once beta testing is complete
- Additional sensor refinements as needed

---

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for complete version history.

---

## Contributors

- **Bug Reports & Testing**: @alexdelprete (maintainer)
- **Development**: Claude Code (AI Assistant)
- **Project Maintainer**: @alexdelprete

---

## References

- **device_type issue**: Beta.27 attempted fix, beta.28 injection approach, beta.29 source fix
- **sys_time issue**: Beta.21 removed timestamp device_class, beta.28 added it back (caused relative time), beta.29 formatted string approach
- **This release**: v1.0.0-beta.29 (November 13, 2025)

---

ü§ñ This release was generated with [Claude Code](https://claude.com/claude-code)
