# v1.0.0-beta.21 - Entity Display Fixes & Icon Support

**Release Date**: 2025-11-10

## Overview

This release fixes multiple entity display issues including diagnostic icons, state entity mappings, timestamp display format, unit validation errors, and entity naming
improvements.

## Highlights

### üé® Diagnostic Entity Icons Now Display

**Problem**: Diagnostic entities and VAh entities had icons defined in the mapping file but they weren't displaying in Home Assistant.

**Root Cause**: The icon data flow was broken at three points - icons weren't being loaded from the mapping file, passed through the normalizer, or applied to sensor entities.

**Solution**: Implemented complete icon support across the data flow chain:

1. **mapping_loader.py**: Added `icon` field to `PointMapping` dataclass and loaded from JSON
1. **normalizer.py**: Passed icon through to normalized point data
1. **sensor.py**: Applied icon to entity via `self._attr_icon`

**Impact**:

- ‚úÖ 51 diagnostic entities now display information icon (‚ÑπÔ∏è `mdi:information-box-outline`)
- ‚úÖ 3 VAh entities (E2_runtime, E2_7D, E2_30D) display lightning bolt icon (‚ö° `mdi:lightning-bolt`)

**Files Changed**:

- [mapping_loader.py:43](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/mapping_loader.py#L43) - Added icon field to dataclass
- [mapping_loader.py:188-189](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/mapping_loader.py#L188-L189) - Load icon from JSON
- [normalizer.py:202](../../custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/normalizer.py#L202) - Pass icon to normalized data
- [sensor.py:324-328](../../custom_components/abb_fimer_pvi_vsn_rest/sensor.py#L324-L328) - Apply icon to entity

### üîß State Entity Mappings Fixed

**Problem**: Four Aurora protocol state entities were showing numeric codes (e.g., "6", "2") instead of descriptive text (e.g., "Run", "MPPT").

**Root Cause**: Dictionary key mismatch in `STATE_ENTITY_MAPPINGS`. The keys used old naming ("GlobState", "DC1State") but actual SunSpec normalized names were different
("GlobalSt", "DcSt1").

**Solution**: Updated all dictionary keys to match actual SunSpec normalized names from the mapping file.

**Before**:

```python
STATE_ENTITY_MAPPINGS = {
    "GlobState": GLOBAL_STATE_MAP,    # ‚ùå Mismatch
    "DC1State": DCDC_STATE_MAP,       # ‚ùå Mismatch
    "DC2State": DCDC_STATE_MAP,       # ‚ùå Mismatch
    "InvState": INVERTER_STATE_MAP,   # ‚ùå Mismatch
    ...
}
```text

**After**:

```python
STATE_ENTITY_MAPPINGS = {
    "GlobalSt": GLOBAL_STATE_MAP,      # ‚úÖ Correct
    "DcSt1": DCDC_STATE_MAP,           # ‚úÖ Correct
    "DcSt2": DCDC_STATE_MAP,           # ‚úÖ Correct
    "InverterSt": INVERTER_STATE_MAP,  # ‚úÖ Correct
    ...
}
```text

**Impact**:

- ‚úÖ `global_st` now shows "Run" instead of 6
- ‚úÖ `dc_st1` now shows "MPPT" instead of 2
- ‚úÖ `dc_st2` now shows "MPPT" instead of 2
- ‚úÖ `inverter_st` now shows "Run" instead of 2

**Files Changed**:

- [const.py:220-229](../../custom_components/abb_fimer_pvi_vsn_rest/const.py#L220-L229) - Fixed STATE_ENTITY_MAPPINGS keys

### üïê System Time Display Format Fixed

**Problem**: `sys_time` entity was showing "1 minute ago" (relative time) instead of formatted date/time like "2025-11-05 12:04:30".

**Root Cause**: Had `device_class: timestamp` which triggers Home Assistant's relative time display by design.

**Solution**: Removed timestamp device_class so the datetime value displays as formatted text.

**Impact**:

- ‚úÖ `sys_time` now displays as "2025-11-05 12:04:30" instead of "1 minute ago"
- ‚úÖ Still shows the inverter's system clock accurately
- ‚úÖ Timestamp conversion (Aurora epoch ‚Üí datetime) continues to work correctly

**Files Changed**:

- [generate_mapping.py:393-394](../../scripts/vsn-mapping-generator/generate_mapping.py#L393-L394) - Removed timestamp device_class

### ‚úÖ Unit Validation Errors Fixed

**Problem**: Home Assistant was showing validation errors for `wlan0_link_quality` entity: "unit '%' is not valid for device_class 'signal_strength'".

**Root Cause**: WiFi link quality is naturally a percentage (0-100%), but HA's signal_strength device_class expects dB or dBm units.

**Solution**: Removed signal_strength device_class since the entity is fundamentally a percentage measurement, not a signal strength in decibels.

**Impact**:

- ‚úÖ No more validation errors in Home Assistant logs
- ‚úÖ `wlan0_link_quality` correctly displays as percentage without inappropriate device_class

**Note**: The data_size validation errors mentioned by the user were actually from cached old entities with truncated serial numbers (from before beta.20). These will disappear
after deleting the old entities or removing/re-adding the integration.

**Files Changed**:

- [generate_mapping.py:650-651](../../scripts/vsn-mapping-generator/generate_mapping.py#L650-L651) - Removed signal_strength device_class from wlan0_link_quality

### üìù Removed Redundant "Device" Prefix from M1 Entities

**Problem**: Four M1 (Common Model) diagnostic entities had redundant "Device" prefix in their display names when shown in the Diagnostic section.

**Example**:

- Before: "Device manufacturer name", "Device model identifier", "Device firmware version", "Device configuration options"
- After: "Manufacturer name", "Model identifier", "Firmware version", "Configuration options"

**Rationale**: In Home Assistant's Diagnostic section, it's already clear these are device properties, so the "Device" prefix is redundant and verbose.

**Impact**:

- ‚úÖ Cleaner, more concise entity names in Diagnostic section
- ‚úÖ Better readability in device info cards
- ‚úÖ Consistent with Home Assistant UI conventions

**Files Changed**:

- [generate_mapping.py:928-932](../../scripts/vsn-mapping-generator/generate_mapping.py#L928-L932) - Updated DESCRIPTION_IMPROVEMENTS dictionary

## Technical Details

### Icon Data Flow Implementation

The icon feature required changes across three layers:

```text
vsn-sunspec-point-mapping.json
  ‚Üí PointMapping.icon (mapping_loader.py)
  ‚Üí normalized_point["icon"] (normalizer.py)
  ‚Üí sensor._attr_icon (sensor.py)
  ‚Üí Home Assistant entity icon
```text

### State Mapping Lookup Logic

The sensor code uses SunSpec normalized names for state mapping lookups:

```python
# sensor.py initialization
self._sunspec_name = point_data.get("sunspec_name", "")
self._state_mapping = STATE_ENTITY_MAPPINGS.get(self._sunspec_name)

# sensor.py native_value property
if self._state_mapping and isinstance(value, int):
    state_text = self._state_mapping.get(value)
    if state_text:
        return state_text
    return f"Unknown ({value})"
```text

The fix ensures the dictionary keys match what the sensor code is looking up.

### Mapping File Regeneration

All mapping fixes required regenerating the mapping files:

1. Updated `generate_mapping.py` with fixes
1. Ran `python generate_mapping.py` to create Excel
1. Ran `python convert_to_json.py` to create JSON
1. JSON automatically copied to integration data folder

## Files Changed

### Integration Core Files

- `custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/mapping_loader.py` - Icon field support
- `custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/normalizer.py` - Icon field passthrough
- `custom_components/abb_fimer_pvi_vsn_rest/sensor.py` - Icon application to entities
- `custom_components/abb_fimer_pvi_vsn_rest/const.py` - State mapping key fixes
- `custom_components/abb_fimer_pvi_vsn_rest/manifest.json` - Version bump to 1.0.0-beta.21

### Mapping Generator Files

- `scripts/vsn-mapping-generator/generate_mapping.py` - Multiple fixes (wlan0_link_quality, sys_time, M1 descriptions)
- `custom_components/abb_fimer_pvi_vsn_rest/data/vsn-sunspec-point-mapping.json` - Regenerated with all fixes
- `scripts/vsn-mapping-generator/output/vsn-sunspec-point-mapping.json` - Regenerated
- `scripts/vsn-mapping-generator/output/vsn-sunspec-point-mapping.xlsx` - Regenerated

### Documentation

- `docs/releases/v1.0.0-beta.21.md` - Release notes (NEW)

## Breaking Changes

None. This release is fully backward compatible with beta.20.

## Upgrade Notes

After upgrading to beta.21:

1. **Reload the integration** in Home Assistant (Settings ‚Üí Devices & Services ‚Üí ABB/FIMER PVI VSN REST ‚Üí 3-dot menu ‚Üí Reload)

1. **For users upgrading from pre-beta.20 versions**: If you still see validation errors about "bytes" units, you have orphaned entities with old truncated serial numbers. Either:

   - Delete the old entities individually, OR
   - Remove and re-add the integration for a clean slate

1. **Verify the fixes**:

   - ‚úÖ Diagnostic entities show information icon (‚ÑπÔ∏è)
   - ‚úÖ State entities show text ("Run", "MPPT") instead of numbers
   - ‚úÖ System time shows formatted date/time instead of "X ago"
   - ‚úÖ No validation errors in logs
   - ‚úÖ M1 entities have clean names without "Device" prefix

## Known Issues

None reported for this release.

## Credits

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>

## Related Releases

- [v1.0.0-beta.20](v1.0.0-beta.20.md) - Device Name Fix & Aurora Protocol Documentation
- [v1.0.0-beta.19](v1.0.0-beta.19.md) - Comprehensive Entity Improvements & Aurora Protocol Integration
