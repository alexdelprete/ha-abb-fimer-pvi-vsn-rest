# Release v1.0.0-beta.28

**Release Date**: 2025-11-13

**Type**: Bug Fix Release

**Focus**: Fix beta.27 regressions - sys_time and device_type issues

______________________________________________________________________

## Overview

This release fixes two critical bugs reported immediately after beta.27 installation:

1. **sys_time sensor** - Showing raw number (816350692) instead of formatted date/time
1. **device_type attribute** - Still showing "unknown" for datalogger entities after beta.27 fix

Both issues were investigated and root causes identified. The fixes ensure proper data flow through the discovery ‚Üí client ‚Üí normalizer ‚Üí sensor pipeline.

______________________________________________________________________

## Bug Fixes

### üêõ sys_time - Raw Number Instead of Date/Time

**Problem**: The `sys_time` sensor was displaying raw numbers like `816350692` instead of a formatted timestamp.

**Root Cause**:

- Timestamp conversion code exists in sensor.py (lines 418-435)
- But the conversion requires `device_class == SensorDeviceClass.TIMESTAMP` to execute:

```python
if (
    getattr(self, "_attr_device_class", None) == SensorDeviceClass.TIMESTAMP
    and isinstance(value, (int, float))
    and value > 0
):
    # Convert Aurora epoch to datetime...
```text

- The mapping file (vsn-sunspec-point-mapping.json line 544) had `"HA Device Class": ""` (empty)
- Without device_class set, the condition at line 418 fails and conversion never runs
- Raw Aurora epoch seconds were returned directly

**Solution**: Update mapping file to set device_class to "timestamp".

**Code Change**
([vsn-sunspec-point-mapping.json:544](d:%5COSILifeDrive%5CDev%5CHASS%5Cha-abb-fimer-pvi-vsn-rest%5Ccustom_components%5Cabb_fimer_pvi_vsn_rest%5Cdata%5Cvsn-sunspec-point-mapping.json#L544)):

```json
"HA Device Class": "timestamp",
```text

**Result**:

- ‚úÖ Normalizer sets device_class from mapping file
- ‚úÖ Sensor conversion code executes (line 418 condition passes)
- ‚úÖ Raw value (816350692) converted using Aurora epoch offset (946684800)
- ‚úÖ Displays as formatted timestamp with timezone: "2025-11-13 10:15:32+01:00"

______________________________________________________________________

### üîß device_type - Still "unknown" After Beta.27 Fix

**Problem**: Despite beta.27 creating a synthetic datalogger device with `device_type="datalogger"`, sensor entities still showed `device_type: unknown` in attributes.

**Root Cause**: Beta.27 created the synthetic datalogger in discovery.py:

```python
# Beta.27 fix - discovery.py lines 291-322
datalogger_device = DiscoveredDevice(
    device_id=logger_id,
    device_type="datalogger",  # ‚úì Correct here
    ...
)
devices.append(datalogger_device)
```text

However, this device was added to `discovered_devices` list but **not propagated to normalized data**.

**Data Flow Problem**:

1. Discovery creates synthetic datalogger ‚Üí `device_type="datalogger"` ‚úì
1. Client calls `get_livedata()` ‚Üí returns raw data from VSN API
1. Livedata **doesn't contain device_type for datalogger** (it's not in that endpoint)
1. Normalizer processes livedata ‚Üí sets `device_type="unknown"` for missing field
1. Sensor reads from normalized data ‚Üí gets `"unknown"` ‚úó

**The Issue**: Discovery result and normalized data are separate data structures that don't communicate.

**Solution**: Inject device_type from discovered_devices into raw livedata before normalization.

**Implementation**:

**1. Update client.__init__ to accept discovered_devices**
([client.py:35,56](d:%5COSILifeDrive%5CDev%5CHASS%5Cha-abb-fimer-pvi-vsn-rest%5Ccustom_components%5Cabb_fimer_pvi_vsn_rest%5Cabb_fimer_vsn_rest_client%5Cclient.py#L35)):

```python
def __init__(
    self,
    session: aiohttp.ClientSession,
    base_url: str,
    username: str = "guest",
    password: str = "",
    vsn_model: str | None = None,
    timeout: int = 10,
    discovered_devices: list[Any] | None = None,  # NEW parameter
):
    ...
    self._discovered_devices = discovered_devices or []  # Store list
```text

**2. Inject device_type in get_normalized_data()**
([client.py:185-200](d:%5COSILifeDrive%5CDev%5CHASS%5Cha-abb-fimer-pvi-vsn-rest%5Ccustom_components%5Cabb_fimer_pvi_vsn_rest%5Cabb_fimer_vsn_rest_client%5Cclient.py#L185-L200)):

```python
raw_data = await self.get_livedata()

# Inject device_type from discovered devices into raw_data before normalization
# This is needed because the datalogger doesn't appear in livedata with device_type
if self._discovered_devices:
    for discovered_device in self._discovered_devices:
        # Match by device_id (with or without formatting)
        for device_id, device_data in raw_data.items():
            # Check both raw and cleaned versions of device IDs
            if device_id in (discovered_device.device_id, discovered_device.raw_device_id):
                # Inject device_type from discovery
                if discovered_device.device_type:
                    device_data["device_type"] = discovered_device.device_type
                    _LOGGER.debug(
                        "Injected device_type '%s' for device %s from discovery",
                        discovered_device.device_type,
                        device_id,
                    )

normalized_data = self._normalizer.normalize(raw_data)
```text

**3. Pass discovered_devices to client**
([__init__.py:116](d:%5COSILifeDrive%5CDev%5CHASS%5Cha-abb-fimer-pvi-vsn-rest%5Ccustom_components%5Cabb_fimer_pvi_vsn_rest%5C__init__.py#L116)):

```python
# Initialize REST client with discovered VSN model and devices
client = ABBFimerVSNRestClient(
    session=session,
    base_url=base_url,
    username=username,
    password=password,
    vsn_model=discovery_result.vsn_model,
    timeout=10,
    discovered_devices=discovery_result.devices,  # NEW parameter
)
```text

**Result**:

- ‚úÖ Client receives discovered_devices list during initialization
- ‚úÖ After fetching raw livedata, device_type injected from discovery
- ‚úÖ Normalizer processes enriched raw data with device_type
- ‚úÖ Normalized data contains correct device_type
- ‚úÖ Sensor reads `device_type: "datalogger"` from normalized data
- ‚úÖ Entity attributes show proper device type

**New Data Flow** (Fixed):

1. Discovery creates synthetic datalogger ‚Üí `device_type="datalogger"` ‚úì
1. Client receives discovered_devices during initialization ‚úì
1. Client calls `get_livedata()` ‚Üí raw data from API
1. **Client injects device_type into raw data from discovered_devices** ‚úì
1. Normalizer processes enriched raw data ‚Üí `device_type="datalogger"` ‚úì
1. Sensor reads from normalized data ‚Üí gets `"datalogger"` ‚úì

______________________________________________________________________

## Technical Details

### File Changes Summary

| File | Lines | Change | |------|-------|--------| | vsn-sunspec-point-mapping.json | 544 | Set device_class to "timestamp" for sys_time | | client.py | 35 | Added
discovered_devices parameter to __init__ | | client.py | 56 | Store discovered_devices list | | client.py | 185-200 | Inject device_type from discovery before normalization | |
__init__.py | 116 | Pass discovered_devices to client initialization | | manifest.json | 13 | Version bump to 1.0.0-beta.28 | | const.py | 4 | Version bump to 1.0.0-beta.28 |

### Before & After Examples

#### sys_time Sensor

**Before (beta.27)**:

```text
Entity ID: sensor.power_one_inverter_pvi_10_0_outd_077909_3g82_3112_sys_time
Value: 816350692
Device Class: (empty)
Display: Raw number shown
```text

**After (beta.28)**:

```text
Entity ID: sensor.power_one_inverter_pvi_10_0_outd_077909_3g82_3112_sys_time
Value: 2025-11-13T10:15:32+01:00
Device Class: timestamp
Display: "Nov 13, 2025, 10:15:32 AM"
```text

#### Datalogger device_type Attribute

**Before (beta.27)**:

```text
Entity: sensor.abb_datalogger_vsn300_111033_3n16_1421_firmware_version
Attributes:
  device_type: unknown
  vsn300_rest_name: N/A
  vsn700_rest_name: N/A
```text

**After (beta.28)**:

```text
Entity: sensor.abb_datalogger_vsn300_111033_3n16_1421_firmware_version
Attributes:
  device_type: datalogger
  vsn300_rest_name: N/A
  vsn700_rest_name: N/A
```text

______________________________________________________________________

## Migration Guide

### ‚ö†Ô∏è NO BREAKING CHANGES

This release **does not** require any migration:

- ‚úÖ No entity ID changes
- ‚úÖ No configuration changes
- ‚úÖ No entity registry cleanup needed

Simply upgrade to beta.28 and restart Home Assistant. The fixes take effect immediately.

### Upgrade Steps

1. **Download beta.28** via HACS or manual installation
1. **Restart Home Assistant**
1. **Verify the fixes**:
   - Check `sys_time` displays as formatted date/time (not raw number)
   - Check datalogger entities show `device_type: datalogger` in attributes (not "unknown")

______________________________________________________________________

## Compatibility

- **Home Assistant**: 2024.1.0 or later
- **Python**: 3.11 or later
- **VSN Dataloggers**: VSN300, VSN700
- **Inverters**: ABB, FIMER, Power-One PVI series

______________________________________________________________________

## Known Issues

None - This release fixes the beta.27 regressions.

______________________________________________________________________

## What's Next

### Planned for v1.0.0-beta.29+

- Continue bug fixes and improvements based on user feedback
- Move towards stable v1.0.0 release once beta testing is complete
- Additional sensor refinements as needed

______________________________________________________________________

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for complete version history.

______________________________________________________________________

## Contributors

- **Bug Reports & Testing**: @alexdelprete (maintainer)
- **Development**: Claude Code (AI Assistant)
- **Project Maintainer**: @alexdelprete

______________________________________________________________________

## References

- **sys_time issue**: Identified in beta.27 user testing (November 13, 2025)
- **device_type issue**: Beta.27 attempted fix but data not propagated to normalized data
- **This release**: v1.0.0-beta.28 (November 13, 2025)

______________________________________________________________________

ü§ñ This release was generated with [Claude Code](https://claude.com/claude-code)
