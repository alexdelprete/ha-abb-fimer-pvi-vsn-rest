# v1.0.0-beta.19 - Comprehensive Entity Improvements & Aurora Protocol Integration

**Release Date**: 2025-11-04

## Overview

This release brings comprehensive entity improvements with proper device classes, icons, and Aurora protocol integration for better data accuracy and user experience.

## Highlights

### üìä Device Class Mapping Improvements

**Core Improvements:**

- Added device_class for **59 measurement entities** (182 ‚Üí 123 without device_class)
- Fixed 39 energy entities (Wh) with proper energy device_class and state_class
- Fixed 10 power entities (W) with correct power device_class
- Fixed battery metrics (Soc, Soh) capitalization
- Fixed house metrics (HousePgrid_L1/L2/L3, HouseIgrid_L1/L2/L3)

**Additional Device Classes:**

- Added `data_size` device_class for bytes entities
- Added `duration` device_class for uptime measurements
- Added `signal_strength` device_class for wlan0_link_quality
- Fixed Isolation_Ohm1 unit from Œ© to MŒ© (verified from feeds data)
- Verified CountryStd diagnostic category fix

### üé® Icon Support

Added comprehensive icon support to the mapping system (27 columns total):

- ‚ö° **Energy icon** (`mdi:lightning-bolt`) for 3 VAh apparent energy entities
  - E2_runtime, E2_7D, E2_30D
- ‚ÑπÔ∏è **Diagnostic icon** (`mdi:information-box-outline`) for all 51 diagnostic entities
  - Device info (Manufacturer, Model, Serial Number, Firmware)
  - Configuration (Country Std, Device Address, Product Number)
  - Status entities (AlarmSt, Dc St1/St2, Options, Global St, Inverter St)

All special entity types now have appropriate visual indicators in Home Assistant.

### üïê Aurora Protocol Integration

#### Timestamp Correction

Fixed **SysTime** timestamp conversion using Aurora protocol epoch:

- **Problem**: SysTime was displaying dates from 1993 instead of 2023
- **Cause**: Aurora protocol uses Jan 1, 2000 epoch, not Unix epoch (Jan 1, 1970)
- **Solution**: Added `AURORA_EPOCH_OFFSET` constant (946684800 seconds)
- **Implementation**: `datetime.fromtimestamp(value + AURORA_EPOCH_OFFSET, tz=tz)`
- **Result**: Timestamps now display correct dates

**Technical Details:**

```python
# const.py
AURORA_EPOCH_OFFSET = 946684800  # Jan 1, 2000 00:00:00 UTC
```

**Reference**: [ABB Aurora Solar Inverter Library - utils.h](https://github.com/xreef/ABB_Aurora_Solar_Inverter_Library/blob/master/include/utils.h#L8)

#### State Mapping for Status Entities

Implemented automatic translation of 6 status entities from integer codes to human-readable text:

| Entity | Description | States | Example Values |
|--------|-------------|--------|----------------|
| **GlobState** | Global operational state | 42 | "Run", "Wait Sun / Grid", "Ground Fault" |
| **DC1State** | DC string 1 state | 20 | "MPPT", "Ramp Start", "DcDc OFF" |
| **DC2State** | DC string 2 state | 20 | "MPPT", "Ramp Start", "DcDc OFF" |
| **InvState** | Inverter state | 38 | "Run", "Stand By", "Checking Grid" |
| **AlarmState** | Alarm (VSN700) | 65 | "No Alarm", "Ground Fault", "Grid Fail" |
| **AlarmSt** | Alarm (VSN300) | 65 | "No Alarm", "Ground Fault", "Grid Fail" |

**Features:**

- Status entities now display descriptive text instead of raw integer codes
- Raw state codes preserved in entity attributes (`raw_state_code`) for debugging
- Unknown codes display as "Unknown (code)" for visibility
- Total of 195 state descriptions across all maps (42 + 20 + 20 + 38 + 65 + 65)

**Implementation Details:**

```python
# const.py - State mapping dictionaries
GLOBAL_STATE_MAP = {0: "Sending Parameters", 6: "Run", ...}  # 42 states
DCDC_STATE_MAP = {0: "DcDc OFF", 2: "MPPT", ...}  # 20 states
INVERTER_STATE_MAP = {0: "Stand By", 2: "Run", ...}  # 38 states
ALARM_STATE_MAP = {0: "No Alarm", 18: "Ground Fault", ...}  # 65 states

STATE_ENTITY_MAPPINGS = {
    "GlobState": GLOBAL_STATE_MAP,
    "DC1State": DCDC_STATE_MAP,
    "DC2State": DCDC_STATE_MAP,
    "InvState": INVERTER_STATE_MAP,
    "AlarmState": ALARM_STATE_MAP,
    "AlarmSt": ALARM_STATE_MAP,
}
```

**Reference**: [ABB Aurora Solar Inverter Library - statesNaming.h](https://github.com/xreef/ABB_Aurora_Solar_Inverter_Library/blob/master/include/statesNaming.h)

## Statistics

### Entity Classification

- ‚úÖ 258 total entities mapped
- ‚úÖ 135 entities with device_class (measurement entities)
- ‚úÖ 51 diagnostic entities (with information icons)
- ‚úÖ 3 VAh entities (with energy icons)
- ‚úÖ 6 status entities (with human-readable states)

### Remaining Entities

The 120 entities without device_class are either:

- Diagnostic/text entities (configuration, identifiers)
- Special measurement types (MŒ©, RPM, channels, cycles) without standard HA device classes

## Technical Improvements

### Mapping Generator (generate_mapping.py)

- Added Aurora protocol state mapping constants
- Implemented automatic icon assignment for diagnostic entities
- Enhanced metadata validation and consistency
- Expanded to 27 columns (added "HA Icon" field)

### Integration Code

**const.py:**

- Added `AURORA_EPOCH_OFFSET` constant (946684800)
- Added 4 state mapping dictionaries (GLOBAL_STATE_MAP, DCDC_STATE_MAP, INVERTER_STATE_MAP, ALARM_STATE_MAP)
- Added `STATE_ENTITY_MAPPINGS` configuration dictionary

**sensor.py:**

- Implemented state translation logic in `native_value` property
- Fixed timestamp conversion with Aurora epoch offset
- Enhanced entity attributes with `raw_state_code` for debugging
- Added state mapping lookup during sensor initialization

## Breaking Changes

None. This release is fully backward compatible with beta.18.

## Upgrade Notes

No special upgrade steps required. The integration will automatically:

- Apply correct timestamps to SysTime entity
- Translate status entity integers to human-readable text
- Display custom icons for VAh and diagnostic entities

## Known Issues

None reported for this release.

## Credits

Special thanks to the [xreef/ABB_Aurora_Solar_Inverter_Library](https://github.com/xreef/ABB_Aurora_Solar_Inverter_Library) project for Aurora protocol documentation.

## Files Changed

- `custom_components/abb_fimer_pvi_vsn_rest/const.py` - Added Aurora constants and state maps
- `custom_components/abb_fimer_pvi_vsn_rest/sensor.py` - Implemented state translation and timestamp fix
- `custom_components/abb_fimer_pvi_vsn_rest/data/vsn-sunspec-point-mapping.json` - Updated with icons and metadata
- `custom_components/abb_fimer_pvi_vsn_rest/manifest.json` - Version bump to 1.0.0-beta.19
- `scripts/vsn-mapping-generator/generate_mapping.py` - Added icon support and enhanced pipeline
- `scripts/vsn-mapping-generator/output/*` - Regenerated mapping files

## Next Steps

Future improvements to consider:

- Map remaining 5 unmapped status entities (BatteryMode, gridExtCtrlState, ClockState, FRT_state, DI_status)
- Add state color coding based on severity (errors in red, warnings in yellow, normal in green)
- Consider enum sensor type for better state handling in HA frontend
