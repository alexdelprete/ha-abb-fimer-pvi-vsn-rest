# Release Notes - v1.1.9

**Release Date**: 2025-11-17

**Type**: Critical Hotfix Release

**Focus**: Fix 2 critical bugs from v1.1.8 (energy sensors showing Wh instead of kWh, SysTime precision error)

---

## Overview

This is a **critical hotfix** release that addresses two bugs from v1.1.8:

1. **Energy sensors showing Wh instead of kWh** - DayWH, WeekWH, MonthWH, YearWH displaying wrong units
2. **SysTime sensor unavailable with precision error** - ValueError about numeric vs string value

**All users on v1.1.8 should upgrade immediately** - This release fixes the remaining issues from v1.1.7/v1.1.8.

---

## Critical Bugs Fixed

### üêõ Bug #1: Energy Sensors Showing Wh Instead of kWh (Critical)

**Problem**:
Four energy sensors were displaying in Wh instead of kWh after v1.1.8:

```
Energia - Anno Scorso (Last Year):     7.262.065 Wh  (should be 7.262 kWh)
Energia - Oggi (Today):                8.013 Wh      (should be 8.013 kWh)
Energia - Ultimi 7 Giorni (Last 7 Days): 19.303 Wh  (should be 19.303 kWh)
Energia - Ultimi 30 Giorni (Last 30 Days): 265.673 Wh (should be 265.673 kWh)
```

**Root Cause**:
- v1.1.8 fixed the normalizer to convert ALL energy sensors from Wh to kWh (device_class-based)
- The normalizer correctly converted values: `7262065 Wh / 1000 = 7262.065 kWh` ‚úì
- BUT the generator had these 4 sensors defined with `unit="Wh"` in SUNSPEC_TO_HA_METADATA
- Result: Values were converted to kWh but displayed with Wh unit label (misleading!)

**Example of the issue**:
- API returns: `7262065` (Wh value)
- Normalizer converts: `7262065 / 1000 = 7262.065` ‚úì
- But mapping says: `unit="Wh"` ‚úó
- Display shows: `7262.065 Wh` ‚úó (wrong unit label!)

**Fix**:
Changed generator script to set `unit="kWh"` for these 4 sensors:

**Generator Script** (`scripts/vsn-mapping-generator/generate_mapping.py` lines 976-980):
```python
# OLD (BROKEN):
"DayWH": {"device_class": "energy", "state_class": "total", "unit": "Wh"},
"WeekWH": {"device_class": "energy", "state_class": "total", "unit": "Wh"},
"MonthWH": {"device_class": "energy", "state_class": "total", "unit": "Wh"},
"YearWH": {"device_class": "energy", "state_class": "total", "unit": "Wh"},

# NEW (FIXED):
# Note: Values come as Wh from API, normalizer converts to kWh, so unit must be kWh
"DayWH": {"device_class": "energy", "state_class": "total", "unit": "kWh"},
"WeekWH": {"device_class": "energy", "state_class": "total", "unit": "kWh"},
"MonthWH": {"device_class": "energy", "state_class": "total", "unit": "kWh"},
"YearWH": {"device_class": "energy", "state_class": "total", "unit": "kWh"},
```

**Result**: All energy sensors now display correctly in kWh:
- Energia - Anno Scorso: `7.262 kWh` ‚úì
- Energia - Oggi: `8.013 kWh` ‚úì
- Energia - Ultimi 7 Giorni: `19.303 kWh` ‚úì
- Energia - Ultimi 30 Giorni: `265.673 kWh` ‚úì

---

### üêõ Bug #2: SysTime Sensor Precision Error (Critical)

**Problem**:
SysTime sensor was unavailable with error about numeric vs string value:

```
ValueError: Sensor sensor.power_one_inverter_pvi_10_0_outd_077909_3g82_3112_system_time
has device class 'None', state class 'None' unit 'None' and suggested precision '0'
thus indicating it has a numeric value; however, it has the non-numeric value:
'2025-11-17 14:30:13' (<class 'str'>)
```

**Root Cause**:
- v1.1.8 removed `device_class="timestamp"` from SysTime (to prevent "2 hours ago" display) ‚úì
- BUT forgot to also remove the `precision=0` field
- SysTime raw value from API is integer (Aurora epoch timestamp: `743709120`)
- sensor.py converts it to formatted string: `"2025-11-17 14:30:13"`
- Having `precision=0` makes HA think it's numeric ‚Üí ValueError when it returns a string

**This is the same issue as state sensors in v1.1.8** - precision field makes HA expect numeric value.

**Fix #1 - Add TIMESTAMP_SENSORS check** (lines 3061-3067):
```python
# Timestamp sensors that return formatted strings should NOT have precision
# Raw values from API are integers (Aurora epoch timestamps), but sensor.py converts
# them to formatted datetime strings (e.g., "2025-11-17 14:30:13")
# Having precision makes HA think it's numeric, causing ValueError
TIMESTAMP_SENSORS = {"SysTime"}
if sunspec_name in TIMESTAMP_SENSORS:
    return None  # No precision field - these return formatted date strings
```

**Fix #2 - Remove precision from SysTime metadata** (lines 1791-1796):
```python
# OLD (BROKEN):
"SysTime": {
    "device_class": None,
    "unit": "",
    "state_class": "",
    "precision": 0,  # ‚úó Makes HA think it's numeric!
},

# NEW (FIXED):
"SysTime": {
    "device_class": None,
    "unit": "",
    "state_class": "",
    # No precision - returns formatted date string, not numeric value (v1.1.9)
},
```

**Why Both Fixes Were Needed**:
1. TIMESTAMP_SENSORS check ensures `_get_suggested_precision()` returns `None` for SysTime
2. BUT the code checks SUNSPEC_TO_HA_METADATA first (takes priority), so we also had to remove the manual `precision: 0` entry

**Result**: SysTime now loads correctly and displays formatted date/time string without errors.

---

## Technical Details

### Files Modified

**Generator Script**:
1. `scripts/vsn-mapping-generator/generate_mapping.py` (3 changes)
   - Lines 976-980: Changed 4 energy sensors from `unit="Wh"` to `unit="kWh"`
   - Lines 3061-3067: Added TIMESTAMP_SENSORS check in `_get_suggested_precision()`
   - Lines 1791-1796: Removed `precision: 0` from SysTime metadata

**Mapping Files** (regenerated):
2. All 3 mapping JSON copies (output/, docs/, client data/)
3. Excel mapping file with corrected metadata

**Version Files**:
4. `custom_components/.../const.py` (version 1.1.9)
5. `custom_components/.../manifest.json` (version 1.1.9)

### Root Cause Analysis

**Why did v1.1.8 introduce these bugs?**

v1.1.8 fixed the normalizer energy conversion logic (device_class-based instead of unit-based) but didn't update the generator to set consistent units.

1. **Energy Sensors**: Normalizer converted values correctly, but generator still had `unit="Wh"` for 4 sensors, causing unit label mismatch

2. **SysTime**: Removed `device_class="timestamp"` to fix "2 hours ago" display, but forgot to also remove `precision=0` which causes the same numeric sensor classification issue as state sensors

**Lesson Learned**: When changing sensor data type or conversion logic, BOTH the runtime code (normalizer/sensor.py) AND the generator metadata must be updated consistently.

---

## Breaking Changes

**None** - This is a bug fix release that completes the v1.1.8 fixes correctly.

---

## Migration Notes

**For Users**:
- **Action Required**: Upgrade immediately if on v1.1.8
- No configuration changes needed
- No entity registry cleanup required
- All sensors will work correctly after upgrade

**For Developers**:
- Energy sensor units now correctly match their converted values (kWh)
- SysTime precision handling now matches state sensors (no precision field)
- Generator script is the single source of truth for all sensor metadata

---

## Testing

**Verified Fixes**:
- ‚úÖ DayWH, WeekWH, MonthWH, YearWH display in kWh (not Wh)
- ‚úÖ SysTime loads without errors and displays formatted string
- ‚úÖ No errors in Home Assistant logs
- ‚úÖ All 258 sensors working correctly

**Energy Sensor Verification**:
```
API returns:       7262065 Wh
Normalizer converts: 7262065 / 1000 = 7262.065 kWh
Mapping says:      unit="kWh" ‚úì
Display shows:     7.262 kWh ‚úì (was 7262.065 Wh in v1.1.8)
```

**SysTime Verification**:
```
API returns:       743709120 (Aurora epoch timestamp)
sensor.py converts: datetime(2025-11-17 14:30:13)
sensor.py formats:  "2025-11-17 14:30:13"
Mapping has:        no precision field ‚úì
Display shows:      "2025-11-17 14:30:13" ‚úì (not "unavailable")
```

---

## Upgrade Priority

**üö® CRITICAL - Upgrade Immediately**

v1.1.8 users are experiencing:
- 4 energy sensors with wrong unit labels (confusing but values are correct)
- 1 timestamp sensor unavailable (SysTime error)

**Impact**: Minor functionality loss and confusing energy unit labels.

---

## Commits

- TBD: Will be added when commit is created

---

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for the complete changelog.
