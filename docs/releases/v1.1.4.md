# Release v1.1.4 - Precision Display Fix

**Release Date**: 2025-11-16

**Type**: Bug Fix Release (Precision Display)

**Focus**: Honor "Suggested Display Precision" field from mapping file

---

## Overview

This release fixes a bug where the integration was ignoring the "Suggested Display Precision" field in the mapping file, causing cycle/counter sensors to display decimal places despite being configured for 0 decimals. The integration was only using hard-coded unit-based precision defaults, making it impossible to control precision through the mapping file.

Additionally, the Riso (insulation resistance) sensor was missing its unit of measurement.

---

## What's Fixed

### üêõ Bug Fix: Honor Suggested Display Precision from Mapping File

**Problem**: Cycle/counter sensors were displaying decimals (e.g., "150.0 cycles") despite the mapping file specifying `precision=0`.

**Root Cause**: The integration code was completely ignoring the `"Suggested Display Precision"` field from the mapping file and only using hard-coded unit-based defaults. The mapping loader didn't even read the precision field from the JSON file.

**Solution**:
- Updated `mapping_loader.py` to read and pass the `"Suggested Display Precision"` field
- Updated `normalizer.py` to pass precision value through to sensor entities
- Updated `sensor.py` to prioritize mapping file precision over unit-based defaults
- Added "cycles" and "channels" to unit-based fallback list (precision=0)

**Precision Priority** (new behavior):
1. **First**: Use value from mapping file `"Suggested Display Precision"` (if specified)
2. **Second**: Fall back to unit-based defaults (if unit is recognized)
3. **Third**: Entity-specific overrides (e.g., system_load)

**Affected Sensors** (now display correctly with 0 decimals):
- `Chc` - Battery charge cycles counter
- `Dhc` - Battery discharge cycles counter
- `CycleNum` - Count - Battery Cycles
- `NumOfMPPT` - Count - MPPT Channels
- `BattNum` - Number of battery cells
- `DetectedBatteryNumber` - Detected Battery Number

**User Impact**:
- ‚úÖ Cycle/counter sensors now display as integers (e.g., "150 cycles" instead of "150.0 cycles")
- ‚úÖ Future precision adjustments can be made through mapping file without code changes
- ‚úÖ More maintainable and data-driven precision configuration

**Commit**: [12d0ea6](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/12d0ea6)

---

### üêõ Bug Fix: Riso Sensor Missing Unit

**Problem**: The `Riso` sensor (DC insulation resistance - VSN700 only) had no unit of measurement.

**Solution**:
- Added `"HA Unit of Measurement": "MOhm"`
- Added `"HA State Class": "measurement"`
- Added `"HA Icon": "mdi:omega"`

**User Impact**:
- ‚úÖ Riso sensor now displays with proper "MOhm" unit
- ‚úÖ Precision automatically set to 2 decimals (from MOhm unit fallback rule)
- ‚úÖ Matches Isolation_Ohm1 sensor configuration (VSN300 equivalent)

**Commit**: [12d0ea6](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/12d0ea6)

---

## Breaking Changes

None.

---

## Migration Notes

**For existing users**: Cycle/counter sensors will automatically display with proper precision (no decimals) after upgrading. No configuration changes required.

**Note**: Entity IDs will not change - only the display precision will be updated.

---

## Technical Details

### Files Changed

1. **`custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/mapping_loader.py`**
   - Added `suggested_display_precision: int | None` field to `PointMapping` dataclass
   - Read `"Suggested Display Precision"` from JSON file
   - Pass precision value through to sensor entities

2. **`custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/normalizer.py`**
   - Added `suggested_display_precision` to normalized point data
   - Ensures mapping file precision reaches sensor initialization

3. **`custom_components/abb_fimer_pvi_vsn_rest/sensor.py`**
   - Changed precision logic to prioritize mapping file over unit-based defaults
   - Added "cycles" and "channels" to unit-based fallback (precision=0)
   - More robust fallback chain for sensors without units

4. **`custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/data/vsn-sunspec-point-mapping.json`**
   - Fixed Riso sensor: added MOhm unit, measurement state_class, omega icon

---

## Testing

All linting and formatting checks pass:
```bash
ruff check .    # All checks passed!
ruff format .   # 34 files already formatted
```

Tested precision display for:
- Cycle/counter sensors (precision=0 from mapping file)
- Resistance sensors (precision=2 from MOhm unit fallback)
- Energy sensors (precision=2 from mapping file)

---

## Known Issues

None.

---

## Full Changelog

See [CHANGELOG.md](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/blob/master/CHANGELOG.md) for the complete changelog.
