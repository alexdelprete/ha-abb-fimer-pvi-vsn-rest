**Release Date**: 2025-11-16

**Type**: Patch Release (Display Fix)

**Focus**: Fix decimal display for unitless sensors (cycle counters and state/flag sensors)

---

## Overview

This patch release fixes an issue where sensors without units were still displaying decimal places despite v1.1.4's precision fix. The root cause was a Home Assistant limitation: `suggested_display_precision` attribute does not work for sensors without units of measurement.

User **@wrongisthenewright** reported that cycle counters and state sensors still showed decimals (e.g., "82277504.0" for cycle counters, "0.0" for state sensors). Additionally, CycleNum incorrectly displayed with "cycles" unit, and state sensors needed to be in the diagnostic category.

---

## What's Fixed

### üêõ Bug Fix: Cycle Counter Decimal Display

**Problem**:
- Chc (Battery charge cycles) showed "82277504.0" ‚ùå
- Dhc (Battery discharge cycles) showed "183048368.0" ‚ùå
- CycleNum showed "707 cycles" with unwanted unit ‚ùå

**Root Cause**: Home Assistant's `suggested_display_precision` attribute **does not work for sensors without units**. This is a known limitation already documented in sensor.py for the `system_load` workaround.

**Solution**:
- Applied manual `int()` rounding in `native_value` property for cycle counter sensors
- Same workaround approach as `system_load` sensor (see sensor.py:469-471)
- Removed "cycles" unit from CycleNum mapping
- Changed state_class from "total" to "total_increasing" for all cycle counters

**Files Changed**:

1. **sensor.py** (lines 473-477):
   ```python
   # Round cycle counters to integers (suggested_display_precision not working without units)
   if self._point_name in ("chc", "dhc", "cycle_num") and isinstance(value, (int, float)):
       return int(value)
   ```

2. **vsn-sunspec-point-mapping.json**:
   - Chc: Added `"HA State Class": "total_increasing"`
   - Dhc: Added `"HA State Class": "total_increasing"`
   - CycleNum: Removed `"HA Unit of Measurement": "cycles"`, changed state_class to `"total_increasing"`

**User Impact**:
- ‚úÖ Chc displays as: **82277504** (no decimals, no unit)
- ‚úÖ Dhc displays as: **183048368** (no decimals, no unit)
- ‚úÖ CycleNum displays as: **707** (no decimals, no unit)
- ‚úÖ All cycle counters properly identified as `total_increasing` statistics

---

### üêõ Bug Fix: State/Flag Sensor Decimal Display

**Problem**:
User @wrongisthenewright reported that state sensors (except Battery State of Charge which has % unit) showed decimals and needed to be in diagnostic category:
- AC Power Derating Flags: 0.0 ‚ùå
- Alarm State: 0.0 ‚ùå
- Apparent Power Derating: 0.0 ‚ùå
- Battery Control Enabled: 0.0 ‚ùå
- Battery Control State: 1.0 ‚ùå
- Battery Mode: 0.0 ‚ùå
- Clock State: 0.0 ‚ùå

**Root Cause**: Same as cycle counters - Home Assistant's `suggested_display_precision` does not work for sensors without units.

**Solution**:
- Applied manual `int()` rounding in `native_value` property for state/flag sensors
- Set Entity Category to "diagnostic" for all 7 state/flag sensors

**Files Changed**:

1. **sensor.py** (lines 479-489):
   ```python
   # Round state/flag sensors to integers (suggested_display_precision not working without units)
   if self._point_name in (
       "battery_mode", "alarm_state", "batt_ext_ctrl_state", "batt_ext_ctrl_ena",
       "pac_derating_flags", "sac_derating_flags", "clock_state"
   ) and isinstance(value, (int, float)):
       return int(value)
   ```

2. **vsn-sunspec-point-mapping.json**:
   - battery_mode: Added `"Entity Category": "diagnostic"`
   - alarm_state: Added `"Entity Category": "diagnostic"`
   - batt_ext_ctrl_state: Added `"Entity Category": "diagnostic"`
   - batt_ext_ctrl_ena: Added `"Entity Category": "diagnostic"`
   - pac_derating_flags: Added `"Entity Category": "diagnostic"`
   - sac_derating_flags: Added `"Entity Category": "diagnostic"`
   - clock_state: Added `"Entity Category": "diagnostic"`

**User Impact**:
- ‚úÖ All state/flag sensors now display as integers (0, 1, etc.) without decimals
- ‚úÖ All state/flag sensors properly categorized as diagnostic entities
- ‚úÖ Cleaner UI - diagnostic entities grouped separately in device page

**Commit**: [6eb0ada](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/6eb0ada)

---

## Technical Details

### Why Manual Rounding is Required

Home Assistant's `suggested_display_precision` attribute is ignored for sensors without `native_unit_of_measurement`. This is why:

- **v1.1.4** added precision to mapping file ‚Üí didn't work for Chc/Dhc (no units)
- **v1.1.5** adds manual rounding in `native_value` ‚Üí works for all sensors

The manual rounding approach is already used in this integration for `system_load` sensor (sensor.py:469-471 with comment explaining the limitation).

### Why Remove "cycles" Unit?

User feedback indicated that cycle counters shouldn't have units displayed. This matches typical counter behavior where the value itself is the meaningful metric (e.g., "150" charge cycles, not "150 cycles").

---

## Breaking Changes

None.

---

## Migration Notes

**For existing users**: Cycle counter sensors will automatically display without decimals and without units after upgrading. Entity IDs and historical data remain unchanged.

**Note**: Existing entity configurations (automations, cards, etc.) are not affected.

---

## Contributors

Thanks to user **@wrongisthenewright** for the quick feedback on v1.1.4 and providing the screenshot that identified this issue.

---

## Full Changelog

See [CHANGELOG.md](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/blob/master/CHANGELOG.md) for the complete changelog.
