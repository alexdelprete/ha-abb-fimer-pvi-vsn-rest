# Release Notes - v1.0.0-beta.3

**Release Date:** October 27, 2025

## Overview

This release fixes three Home Assistant warnings/errors reported in v1.0.0-beta.2:

1. **Blocking I/O operations** in event loop
2. **OptionsFlow deprecation** warning (HA 2025.12)
3. **Sensor AttributeError** during initialization

**All users on v1.0.0-beta.2 should upgrade to v1.0.0-beta.3.**

---

## Bug Fixes

### 1. Blocking I/O Operations (Critical)

**Problem:**
Home Assistant detected blocking file operations in the event loop:
```
Detected blocking call to open with args (...) inside the event loop
at mapping_loader.py, line 116: with file_path.open(encoding="utf-8") as f:
```

**Root Cause:**
- `VSNMappingLoader` performed synchronous file I/O during initialization
- Called during async coordinator setup, blocking the event loop
- Home Assistant 2025.x strictly detects and warns about blocking operations

**Solution:**
Refactored to use deferred async loading pattern following Home Assistant best practices:

- **mapping_loader.py:**
  - Removed file I/O from `__init__` (now just stores path)
  - Added `async_load()` method for deferred async loading
  - Uses `Path.read_text()` instead of `open()` (HA recommended)
  - Uses `asyncio.to_thread()` to run blocking operations in executor
  - All file operations now run in thread pool

- **normalizer.py:**
  - Added `async_load()` method
  - Delegates to `mapping_loader.async_load()`
  - Safe to call multiple times (loads only once)

- **client.py:**
  - Added `await self._normalizer.async_load()` after creation
  - Ensures mappings loaded before first use

**Impact:**
- **v1.0.0-beta.2:** Event loop blocking, HA performance impact
- **v1.0.0-beta.3:** All file I/O runs in executor, no blocking

**Reference:**
- [HA Blocking Operations Docs](https://developers.home-assistant.io/docs/asyncio_blocking_operations/#open)
- Commit: [ab9dc38](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/ab9dc38)

---

### 2. OptionsFlow Deprecation Warning

**Problem:**
Home Assistant logged deprecation warning:
```
Detected that custom integration 'abb_fimer_pvi_vsn_rest' sets option flow
config_entry explicitly, which is deprecated at config_flow.py, line 303.
This will stop working in Home Assistant 2025.12
```

**Root Cause:**
- Manual assignment `self.config_entry = config_entry` in OptionsFlowHandler `__init__`
- This pattern is deprecated in HA 2025.12
- OptionsFlow base class now provides `self.config_entry` property automatically

**Solution:**
- Removed entire `__init__` method from `ABBFimerPVIVSNRestOptionsFlowHandler`
- The framework now automatically provides `self.config_entry` property
- Usage at line 318 (`self.config_entry.options.get(...)`) continues to work

**Impact:**
- **v1.0.0-beta.2:** Deprecation warning logged
- **v1.0.0-beta.3:** No warning, future-proof for HA 2025.12

**Changes:**
- **config_flow.py:** Removed lines 301-303 (`__init__` method)

**Commit:** [47c8ead](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/47c8ead)

---

### 3. Sensor AttributeError

**Problem:**
Integration crashed during sensor setup:
```
AttributeError: 'VSNSensor' object has no attribute '__attr_device_class'
at sensor.py, line 132
```

**Root Cause:**
- Debug logging tried to access `self._attr_device_class` and `self._attr_state_class`
- These attributes are only conditionally set when `device_class` or `state_class` provided
- When not provided, attributes don't exist, causing AttributeError

**Solution:**
- Use `getattr(self, "_attr_device_class", None)` with default value
- Use `getattr(self, "_attr_state_class", None)` with default value
- Debug logging now safely handles missing attributes

**Impact:**
- **v1.0.0-beta.2:** Crash during sensor initialization
- **v1.0.0-beta.3:** Safe attribute access, no errors

**Changes:**
- **sensor.py:** Lines 132-133 updated to use `getattr()`

**Commit:** [47c8ead](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/commit/47c8ead)

---

## Installation

### HACS (Recommended)

1. Go to HACS → Integrations
2. Find "ABB/FIMER PVI VSN REST"
3. Click "Update" to v1.0.0-beta.3
4. Restart Home Assistant
5. Integration will reload automatically

### Manual Installation

1. Download `abb_fimer_pvi_vsn_rest.zip` from [GitHub Releases](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/releases/tag/v1.0.0-beta.3)
2. Extract to `custom_components/abb_fimer_pvi_vsn_rest`
3. Restart Home Assistant
4. Integration will reload automatically

---

## Migration from v1.0.0-beta.2

**No configuration changes required.** Simply update and restart.

**What to check after upgrade:**
1. Check Home Assistant logs - all three warnings should be gone
2. Verify sensors are loading correctly
3. Verify data updates are working

---

## Known Issues

- None specific to v1.0.0-beta.3
- Please report any issues on [GitHub Issues](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues)

---

## Technical Details

### Changes Summary

**Files Modified:**
- `custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/mapping_loader.py`
- `custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/normalizer.py`
- `custom_components/abb_fimer_pvi_vsn_rest/abb_fimer_vsn_rest_client/client.py`
- `custom_components/abb_fimer_pvi_vsn_rest/config_flow.py`
- `custom_components/abb_fimer_pvi_vsn_rest/sensor.py`
- `custom_components/abb_fimer_pvi_vsn_rest/manifest.json`
- `custom_components/abb_fimer_pvi_vsn_rest/const.py`

**Lines Changed:**
- Added: ~40 lines (async_load methods, docstrings)
- Modified: ~8 lines (getattr, Path.read_text)
- Removed: ~3 lines (__init__ method)

### Async Loading Pattern

The new async loading pattern ensures proper initialization order:

```python
# Step 1: Create normalizer (non-blocking)
self._normalizer = VSNDataNormalizer(self.vsn_model)

# Step 2: Load mappings asynchronously (runs in executor)
await self._normalizer.async_load()

# Step 3: Use normalizer (mappings now loaded)
data = self._normalizer.normalize(raw_data)
```

### Home Assistant Best Practices

This release follows HA async best practices:
- ✅ No blocking I/O in event loop
- ✅ Uses `asyncio.to_thread()` for blocking operations
- ✅ Uses `Path.read_text()` instead of `open()`
- ✅ Deferred loading pattern for heavy initialization
- ✅ No deprecated API usage

---

## Feedback & Support

- **Issues:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/issues
- **Discussions:** https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/discussions

---

**Full Changelog:** [v1.0.0-beta.2...v1.0.0-beta.3](https://github.com/alexdelprete/ha-abb-fimer-pvi-vsn-rest/compare/v1.0.0-beta.2...v1.0.0-beta.3)
